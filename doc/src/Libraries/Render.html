<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE TypeSynonymInstances #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE FlexibleInstances #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE MultiParamTypeClasses #-}</i></font>
<a name="line-4"></a><font color=Blue><i>{-# LANGUAGE FunctionalDependencies #-}</i></font>
<a name="line-5"></a><font color=Blue><i>{-# LANGUAGE UndecidableInstances #-}</i></font>
<a name="line-6"></a><font color=Blue><i>{-# LANGUAGE FlexibleContexts #-}</i></font>
<a name="line-7"></a>
<a name="line-8"></a><font color=Blue><i>-- | This module provides efficient functions for rendering vector</i></font>
<a name="line-9"></a><font color=Blue><i>-- graphics to a number of formats, including EPS, PostScript, and</i></font>
<a name="line-10"></a><font color=Blue><i>-- PDF. It provides an abstraction for multi-page documents, as well</i></font>
<a name="line-11"></a><font color=Blue><i>-- as a set of graphics primitives for page descriptions. </i></font>
<a name="line-12"></a><font color=Blue><i>-- </i></font>
<a name="line-13"></a><font color=Blue><i>-- The graphics model is similar to that of the PostScript and PDF</i></font>
<a name="line-14"></a><font color=Blue><i>-- languages, but we only implement a subset of their functionality.</i></font>
<a name="line-15"></a><font color=Blue><i>-- Care has been taken that graphics rendering is done efficiently and</i></font>
<a name="line-16"></a><font color=Blue><i>-- as lazily as possible; documents are rendered \"on the fly\",</i></font>
<a name="line-17"></a><font color=Blue><i>-- without the need to store the whole document in memory.</i></font>
<a name="line-18"></a><font color=Blue><i>-- </i></font>
<a name="line-19"></a><font color=Blue><i>-- The provided document description model consists of two separate</i></font>
<a name="line-20"></a><font color=Blue><i>-- layers of abstraction:</i></font>
<a name="line-21"></a><font color=Blue><i>-- </i></font>
<a name="line-22"></a><font color=Blue><i>-- * /drawing/ is concerned with placing marks on a fixed surface, and</i></font>
<a name="line-23"></a><font color=Blue><i>-- takes place in the 'Draw' monad;</i></font>
<a name="line-24"></a><font color=Blue><i>-- </i></font>
<a name="line-25"></a><font color=Blue><i>-- * /document structure/ is concerned with a sequence of pages, their</i></font>
<a name="line-26"></a><font color=Blue><i>-- bounding boxes, and other meta-data. It takes place in the</i></font>
<a name="line-27"></a><font color=Blue><i>-- 'Document' monad.</i></font>
<a name="line-28"></a>
<a name="line-29"></a><font color=Green><u>module</u></font> Libraries<font color=Cyan>.</font>Render <font color=Cyan>(</font>
<a name="line-30"></a>  <font color=Blue><i>-- * Types</i></font>
<a name="line-31"></a>  <font color=Blue><i>-- ** Coordinates</i></font>
<a name="line-32"></a>  X<font color=Cyan>,</font>
<a name="line-33"></a>  Y<font color=Cyan>,</font>
<a name="line-34"></a>  <font color=Blue><i>-- ** Color</i></font>
<a name="line-35"></a>  Color<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-36"></a>  
<a name="line-37"></a>  <font color=Blue><i>-- ** Fonts</i></font>
<a name="line-38"></a>  Basefont<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-39"></a>  Font<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-40"></a>  nominalsize<font color=Cyan>,</font>
<a name="line-41"></a>  text_width<font color=Cyan>,</font>
<a name="line-42"></a>  
<a name="line-43"></a>  <font color=Blue><i>-- ** Alignment</i></font>
<a name="line-44"></a>  Alignment<font color=Cyan>,</font>
<a name="line-45"></a>  align_left<font color=Cyan>,</font>
<a name="line-46"></a>  align_center<font color=Cyan>,</font>
<a name="line-47"></a>  align_right<font color=Cyan>,</font>
<a name="line-48"></a>  
<a name="line-49"></a>  <font color=Blue><i>-- * The Document monad</i></font>
<a name="line-50"></a>  <font color=Blue><i>-- $DOCUMENTMODEL</i></font>
<a name="line-51"></a>  Document<font color=Cyan>,</font>
<a name="line-52"></a>  newpage<font color=Cyan>,</font>
<a name="line-53"></a>  newpage_defer<font color=Cyan>,</font>
<a name="line-54"></a>  endpage<font color=Cyan>,</font>
<a name="line-55"></a>  
<a name="line-56"></a>  <font color=Blue><i>-- * The Draw monad  </i></font>
<a name="line-57"></a>  <font color=Blue><i>-- $DRAWINGMODEL</i></font>
<a name="line-58"></a>  Draw<font color=Cyan>,</font>
<a name="line-59"></a>  
<a name="line-60"></a>  <font color=Blue><i>-- ** Path construction commands</i></font>
<a name="line-61"></a>  <font color=Blue><i>-- $PATHCONSTRUCTION</i></font>
<a name="line-62"></a>  newpath<font color=Cyan>,</font>
<a name="line-63"></a>  moveto<font color=Cyan>,</font>
<a name="line-64"></a>  lineto<font color=Cyan>,</font>
<a name="line-65"></a>  curveto<font color=Cyan>,</font>
<a name="line-66"></a>  closepath<font color=Cyan>,</font>
<a name="line-67"></a>  arc<font color=Cyan>,</font>
<a name="line-68"></a>  arc_append<font color=Cyan>,</font>
<a name="line-69"></a>  oval<font color=Cyan>,</font>
<a name="line-70"></a>  rectangle<font color=Cyan>,</font>
<a name="line-71"></a>  
<a name="line-72"></a>  <font color=Blue><i>-- ** Painting commands</i></font>
<a name="line-73"></a>  stroke<font color=Cyan>,</font>
<a name="line-74"></a>  fill<font color=Cyan>,</font>
<a name="line-75"></a>  fillstroke<font color=Cyan>,</font>
<a name="line-76"></a>  
<a name="line-77"></a>  <font color=Blue><i>-- ** Text commands</i></font>
<a name="line-78"></a>  textbox<font color=Cyan>,</font>
<a name="line-79"></a>  
<a name="line-80"></a>  <font color=Blue><i>-- ** Graphics parameters</i></font>
<a name="line-81"></a>  <font color=Blue><i>-- $GRAPHICSPARAMETERS</i></font>
<a name="line-82"></a>  setlinewidth<font color=Cyan>,</font>
<a name="line-83"></a>  setcolor<font color=Cyan>,</font>
<a name="line-84"></a>  
<a name="line-85"></a>  <font color=Blue><i>-- ** Coordinate system</i></font>
<a name="line-86"></a>  <font color=Blue><i>-- $COORDINATESYSTEM</i></font>
<a name="line-87"></a>  translate<font color=Cyan>,</font>
<a name="line-88"></a>  scale<font color=Cyan>,</font>
<a name="line-89"></a>  
<a name="line-90"></a>  <font color=Blue><i>-- ** Comments</i></font>
<a name="line-91"></a>  comment<font color=Cyan>,</font>
<a name="line-92"></a>  
<a name="line-93"></a>  <font color=Blue><i>-- ** Block structure</i></font>
<a name="line-94"></a>  <font color=Blue><i>-- $BLOCKSTRUCTURE</i></font>
<a name="line-95"></a>  block<font color=Cyan>,</font>
<a name="line-96"></a>  
<a name="line-97"></a>  <font color=Blue><i>-- * Backends</i></font>
<a name="line-98"></a>  <font color=Blue><i>-- $BACKENDS</i></font>
<a name="line-99"></a>  RenderFormat<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-100"></a>  render_stdout<font color=Cyan>,</font>
<a name="line-101"></a>  render_file<font color=Cyan>,</font>
<a name="line-102"></a>  render_string<font color=Cyan>,</font>
<a name="line-103"></a>  
<a name="line-104"></a>  <font color=Blue><i>-- * Customization</i></font>
<a name="line-105"></a>  <font color=Blue><i>-- $CUSTOMIZATION</i></font>
<a name="line-106"></a>  
<a name="line-107"></a>  <font color=Blue><i>-- ** Custom drawing commands</i></font>
<a name="line-108"></a>  <font color=Blue><i>-- $CUSTOMCOMMANDS</i></font>
<a name="line-109"></a>  draw_subroutine<font color=Cyan>,</font>
<a name="line-110"></a>  custom_ps<font color=Cyan>,</font>  
<a name="line-111"></a>  custom_pdf<font color=Cyan>,</font>
<a name="line-112"></a>  custom_ascii<font color=Cyan>,</font>
<a name="line-113"></a>
<a name="line-114"></a>  <font color=Blue><i>-- ** Customization interface</i></font>
<a name="line-115"></a>  Custom<font color=Cyan>(</font><font color=Red>..</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-116"></a>  custom<font color=Cyan>,</font>
<a name="line-117"></a>  
<a name="line-118"></a>  <font color=Blue><i>-- ** Customized rendering functions</i></font>
<a name="line-119"></a>  <font color=Blue><i>-- $CUSTOMRENDER</i></font>
<a name="line-120"></a>  render_custom_stdout<font color=Cyan>,</font>
<a name="line-121"></a>  render_custom_file<font color=Cyan>,</font>
<a name="line-122"></a>  render_custom_string<font color=Cyan>,</font>
<a name="line-123"></a>  <font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-124"></a>
<a name="line-125"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Auxiliary
<a name="line-126"></a>
<a name="line-127"></a><font color=Green><u>import</u></font> Codec<font color=Cyan>.</font>Compression<font color=Cyan>.</font>Zlib
<a name="line-128"></a><font color=Green><u>import</u></font> Control<font color=Cyan>.</font>Monad<font color=Cyan>.</font>State
<a name="line-129"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>ByteString<font color=Cyan>.</font>Lazy <font color=Green><u>as</u></font> ByteString
<a name="line-130"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Char
<a name="line-131"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>List
<a name="line-132"></a><font color=Green><u>import</u></font> <font color=Green><u>qualified</u></font> Data<font color=Cyan>.</font>Map <font color=Green><u>as</u></font> Map
<a name="line-133"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Map <font color=Cyan>(</font>Map<font color=Cyan>)</font>
<a name="line-134"></a><font color=Green><u>import</u></font> System<font color=Cyan>.</font>IO
<a name="line-135"></a><font color=Green><u>import</u></font> Text<font color=Cyan>.</font>Printf
<a name="line-136"></a>
<a name="line-137"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-138"></a><font color=Blue><i>-- * Types</i></font>
<a name="line-139"></a>
<a name="line-140"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-141"></a><font color=Blue><i>-- ** Coordinates</i></font>
<a name="line-142"></a>
<a name="line-143"></a><a name="X"></a><font color=Blue><i>-- | The type of /x/-coordinates.</i></font>
<a name="line-144"></a><a name="X"></a><font color=Green><u>type</u></font> X <font color=Red>=</font> Double
<a name="line-145"></a>
<a name="line-146"></a><a name="Y"></a><font color=Blue><i>-- | The type of /y/-coordinates.</i></font>
<a name="line-147"></a><a name="Y"></a><font color=Green><u>type</u></font> Y <font color=Red>=</font> Double
<a name="line-148"></a>
<a name="line-149"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-150"></a><font color=Blue><i>-- ** Colors</i></font>
<a name="line-151"></a>
<a name="line-152"></a><a name="Color"></a><font color=Blue><i>-- | The type of colors.</i></font>
<a name="line-153"></a><a name="Color"></a><font color=Green><u>data</u></font> Color <font color=Red>=</font>
<a name="line-154"></a>  Color_RGB Double Double Double <font color=Blue><i>-- ^ Red, green and blue components,</i></font>
<a name="line-155"></a>                                 <font color=Blue><i>-- in the range from 0.0 (dark) to</i></font>
<a name="line-156"></a>                                 <font color=Blue><i>-- 1.0 (bright).</i></font>
<a name="line-157"></a>  <font color=Red>|</font> Color_Gray Double            <font color=Blue><i>-- ^ Gray value, in the range from</i></font>
<a name="line-158"></a>                                 <font color=Blue><i>-- 0.0 (black) to 1.0 (white).</i></font>
<a name="line-159"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-160"></a>
<a name="line-161"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-162"></a><font color=Blue><i>-- ** Fonts</i></font>
<a name="line-163"></a>
<a name="line-164"></a><a name="Basefont"></a><font color=Blue><i>-- | A enumeration type for base fonts. For the time being, we only</i></font>
<a name="line-165"></a><a name="Basefont"></a><font color=Blue><i>-- offer TimesRoman and Helvetica.</i></font>
<a name="line-166"></a><a name="Basefont"></a><font color=Green><u>data</u></font> Basefont <font color=Red>=</font> TimesRoman <font color=Red>|</font> Helvetica
<a name="line-167"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-168"></a>
<a name="line-169"></a><a name="Fontmetric"></a><font color=Blue><i>-- | A type representing font metrics for a given base font. The first</i></font>
<a name="line-170"></a><a name="Fontmetric"></a><font color=Blue><i>-- component is the default width of characters; the second component</i></font>
<a name="line-171"></a><a name="Fontmetric"></a><font color=Blue><i>-- is a map from characters to widths.</i></font>
<a name="line-172"></a><a name="Fontmetric"></a><font color=Green><u>type</u></font> Fontmetric <font color=Red>=</font> <font color=Cyan>(</font>Double<font color=Cyan>,</font> Map Char Double<font color=Cyan>)</font>
<a name="line-173"></a>
<a name="line-174"></a><a name="metric"></a><font color=Blue><i>-- | Define a font metric for each base font.</i></font>
<a name="line-175"></a><font color=Blue>metric</font> <font color=Red>::</font> Basefont <font color=Red>-&gt;</font> Fontmetric
<a name="line-176"></a><font color=Blue>metric</font> TimesRoman <font color=Red>=</font> metric_timesroman
<a name="line-177"></a><font color=Blue>metric</font> Helvetica <font color=Red>=</font> metric_helvetica
<a name="line-178"></a>
<a name="line-179"></a><a name="metric_timesroman"></a><font color=Blue><i>-- | Font metrics for TimesRoman.</i></font>
<a name="line-180"></a><font color=Blue>metric_timesroman</font> <font color=Red>::</font> Fontmetric
<a name="line-181"></a><font color=Blue>metric_timesroman</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>0.5</font><font color=Cyan>,</font> m<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-182"></a>  m <font color=Red>=</font> Map<font color=Cyan>.</font>fromList <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>n<font color=Cyan>,</font>w<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>chr n<font color=Cyan>,</font> w<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-183"></a>      <font color=Red>[</font><font color=Cyan>(</font><font color=Magenta>32</font><font color=Cyan>,</font><font color=Magenta>0.25</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>33</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>34</font><font color=Cyan>,</font><font color=Magenta>0.40625</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>37</font><font color=Cyan>,</font><font color=Magenta>0.832031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>38</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-184"></a>       <font color=Cyan>(</font><font color=Magenta>39</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>40</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>41</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>44</font><font color=Cyan>,</font><font color=Magenta>0.25</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>45</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-185"></a>       <font color=Cyan>(</font><font color=Magenta>46</font><font color=Cyan>,</font><font color=Magenta>0.25</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>47</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>58</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>59</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>63</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-186"></a>       <font color=Cyan>(</font><font color=Magenta>64</font><font color=Cyan>,</font><font color=Magenta>0.917969</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>65</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>66</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>67</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>68</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-187"></a>       <font color=Cyan>(</font><font color=Magenta>69</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>71</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>72</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>73</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>74</font><font color=Cyan>,</font><font color=Magenta>0.386719</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-188"></a>       <font color=Cyan>(</font><font color=Magenta>75</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>76</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>77</font><font color=Cyan>,</font><font color=Magenta>0.886719</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>78</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>79</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-189"></a>       <font color=Cyan>(</font><font color=Magenta>81</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>82</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>84</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>85</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>86</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-190"></a>       <font color=Cyan>(</font><font color=Magenta>87</font><font color=Cyan>,</font><font color=Magenta>0.941406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>88</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>89</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>90</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>91</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-191"></a>       <font color=Cyan>(</font><font color=Magenta>92</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>93</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>94</font><font color=Cyan>,</font><font color=Magenta>0.46875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>96</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-192"></a>       <font color=Cyan>(</font><font color=Magenta>97</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>99</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>101</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>102</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-193"></a>       <font color=Cyan>(</font><font color=Magenta>105</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>106</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>108</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>109</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-194"></a>       <font color=Cyan>(</font><font color=Magenta>114</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>115</font><font color=Cyan>,</font><font color=Magenta>0.386719</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>116</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>119</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-195"></a>       <font color=Cyan>(</font><font color=Magenta>122</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>123</font><font color=Cyan>,</font><font color=Magenta>0.476562</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>124</font><font color=Cyan>,</font><font color=Magenta>0.199219</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>125</font><font color=Cyan>,</font><font color=Magenta>0.476562</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-196"></a>       <font color=Cyan>(</font><font color=Magenta>161</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>164</font><font color=Cyan>,</font><font color=Magenta>0.164062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>169</font><font color=Cyan>,</font><font color=Magenta>0.179688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>170</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-197"></a>       <font color=Cyan>(</font><font color=Magenta>172</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>173</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>180</font><font color=Cyan>,</font><font color=Magenta>0.25</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>182</font><font color=Cyan>,</font><font color=Magenta>0.449219</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-198"></a>       <font color=Cyan>(</font><font color=Magenta>183</font><font color=Cyan>,</font><font color=Magenta>0.347656</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>184</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>185</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>186</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-199"></a>       <font color=Cyan>(</font><font color=Magenta>188</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>189</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>191</font><font color=Cyan>,</font><font color=Magenta>0.441406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>193</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>194</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-200"></a>       <font color=Cyan>(</font><font color=Magenta>195</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>196</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>197</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>198</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-201"></a>       <font color=Cyan>(</font><font color=Magenta>199</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>200</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>202</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>203</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-202"></a>       <font color=Cyan>(</font><font color=Magenta>205</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>206</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>207</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>208</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-203"></a>       <font color=Cyan>(</font><font color=Magenta>225</font><font color=Cyan>,</font><font color=Magenta>0.886719</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>227</font><font color=Cyan>,</font><font color=Magenta>0.273438</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>232</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>233</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-204"></a>       <font color=Cyan>(</font><font color=Magenta>234</font><font color=Cyan>,</font><font color=Magenta>0.886719</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>241</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>245</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>248</font><font color=Cyan>,</font><font color=Magenta>0.277344</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-205"></a>       <font color=Cyan>(</font><font color=Magenta>250</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Red>]</font>
<a name="line-206"></a>
<a name="line-207"></a><a name="metric_helvetica"></a><font color=Blue><i>-- | Font metrics for Helvetica.</i></font>
<a name="line-208"></a><font color=Blue>metric_helvetica</font> <font color=Red>::</font> Fontmetric
<a name="line-209"></a><font color=Blue>metric_helvetica</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>0.277344</font><font color=Cyan>,</font> m<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-210"></a>  m <font color=Red>=</font> Map<font color=Cyan>.</font>fromList <font color=Cyan>$</font> map <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>n<font color=Cyan>,</font>w<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>chr n<font color=Cyan>,</font> w<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-211"></a>      <font color=Red>[</font><font color=Cyan>(</font><font color=Magenta>34</font><font color=Cyan>,</font><font color=Magenta>0.351562</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>35</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>36</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>37</font><font color=Cyan>,</font><font color=Magenta>0.886719</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-212"></a>      <font color=Cyan>(</font><font color=Magenta>38</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>39</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>40</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>41</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>42</font><font color=Cyan>,</font><font color=Magenta>0.386719</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-213"></a>      <font color=Cyan>(</font><font color=Magenta>43</font><font color=Cyan>,</font><font color=Magenta>0.582031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>45</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>48</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>49</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-214"></a>      <font color=Cyan>(</font><font color=Magenta>50</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>51</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>52</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>53</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-215"></a>      <font color=Cyan>(</font><font color=Magenta>54</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>55</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>56</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>57</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-216"></a>      <font color=Cyan>(</font><font color=Magenta>60</font><font color=Cyan>,</font><font color=Magenta>0.582031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>61</font><font color=Cyan>,</font><font color=Magenta>0.582031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>62</font><font color=Cyan>,</font><font color=Magenta>0.582031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>63</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>64</font><font color=Cyan>,</font><font color=Magenta>1.01172</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-217"></a>      <font color=Cyan>(</font><font color=Magenta>65</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>66</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>67</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>68</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>69</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-218"></a>      <font color=Cyan>(</font><font color=Magenta>70</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>71</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>72</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>74</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>75</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-219"></a>      <font color=Cyan>(</font><font color=Magenta>76</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>77</font><font color=Cyan>,</font><font color=Magenta>0.832031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>78</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>79</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>80</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-220"></a>      <font color=Cyan>(</font><font color=Magenta>81</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>82</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>83</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>84</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>85</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-221"></a>      <font color=Cyan>(</font><font color=Magenta>86</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>87</font><font color=Cyan>,</font><font color=Magenta>0.941406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>88</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>89</font><font color=Cyan>,</font><font color=Magenta>0.664062</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-222"></a>      <font color=Cyan>(</font><font color=Magenta>90</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>94</font><font color=Cyan>,</font><font color=Magenta>0.46875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>95</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>96</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>97</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-223"></a>      <font color=Cyan>(</font><font color=Magenta>98</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>99</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>100</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>101</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>103</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-224"></a>      <font color=Cyan>(</font><font color=Magenta>104</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>105</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>106</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>107</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>108</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-225"></a>      <font color=Cyan>(</font><font color=Magenta>109</font><font color=Cyan>,</font><font color=Magenta>0.832031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>110</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>111</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>112</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-226"></a>      <font color=Cyan>(</font><font color=Magenta>113</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>114</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>115</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>117</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>118</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-227"></a>      <font color=Cyan>(</font><font color=Magenta>119</font><font color=Cyan>,</font><font color=Magenta>0.71875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>120</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>121</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>122</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>123</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-228"></a>      <font color=Cyan>(</font><font color=Magenta>124</font><font color=Cyan>,</font><font color=Magenta>0.257812</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>125</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>126</font><font color=Cyan>,</font><font color=Magenta>0.582031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>161</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-229"></a>      <font color=Cyan>(</font><font color=Magenta>162</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>163</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>164</font><font color=Cyan>,</font><font color=Magenta>0.164062</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>165</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-230"></a>      <font color=Cyan>(</font><font color=Magenta>166</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>167</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>168</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>169</font><font color=Cyan>,</font><font color=Magenta>0.1875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-231"></a>      <font color=Cyan>(</font><font color=Magenta>170</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>171</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>172</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>173</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-232"></a>      <font color=Cyan>(</font><font color=Magenta>174</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>175</font><font color=Cyan>,</font><font color=Magenta>0.5</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>177</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>178</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>179</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-233"></a>      <font color=Cyan>(</font><font color=Magenta>182</font><font color=Cyan>,</font><font color=Magenta>0.535156</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>183</font><font color=Cyan>,</font><font color=Magenta>0.347656</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>184</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>185</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-234"></a>      <font color=Cyan>(</font><font color=Magenta>186</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>187</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>188</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>189</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>191</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-235"></a>      <font color=Cyan>(</font><font color=Magenta>193</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>194</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>195</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>196</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-236"></a>      <font color=Cyan>(</font><font color=Magenta>197</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>198</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>199</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>200</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-237"></a>      <font color=Cyan>(</font><font color=Magenta>202</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>203</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>205</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>206</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-238"></a>      <font color=Cyan>(</font><font color=Magenta>207</font><font color=Cyan>,</font><font color=Magenta>0.332031</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>208</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>225</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>227</font><font color=Cyan>,</font><font color=Magenta>0.367188</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>232</font><font color=Cyan>,</font><font color=Magenta>0.554688</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-239"></a>      <font color=Cyan>(</font><font color=Magenta>233</font><font color=Cyan>,</font><font color=Magenta>0.777344</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>234</font><font color=Cyan>,</font><font color=Magenta>1.0</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>235</font><font color=Cyan>,</font><font color=Magenta>0.363281</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>241</font><font color=Cyan>,</font><font color=Magenta>0.886719</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>248</font><font color=Cyan>,</font><font color=Magenta>0.21875</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-240"></a>      <font color=Cyan>(</font><font color=Magenta>249</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>250</font><font color=Cyan>,</font><font color=Magenta>0.941406</font><font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font><font color=Magenta>251</font><font color=Cyan>,</font><font color=Magenta>0.609375</font><font color=Cyan>)</font><font color=Red>]</font>
<a name="line-241"></a>
<a name="line-242"></a><a name="char_metric"></a><font color=Blue><i>-- | Look up the width of a character in the given metric.</i></font>
<a name="line-243"></a><font color=Blue>char_metric</font> <font color=Red>::</font> Fontmetric <font color=Red>-&gt;</font> Char <font color=Red>-&gt;</font> Double
<a name="line-244"></a><font color=Blue>char_metric</font> <font color=Cyan>(</font>d<font color=Cyan>,</font> m<font color=Cyan>)</font> c <font color=Red>=</font> <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup c m <font color=Green><u>of</u></font>
<a name="line-245"></a>  Nothing <font color=Red>-&gt;</font> d
<a name="line-246"></a>  Just w <font color=Red>-&gt;</font> w
<a name="line-247"></a>  
<a name="line-248"></a><a name="string_metric"></a><font color=Blue><i>-- | Look up with width of a string in the given metric.</i></font>
<a name="line-249"></a><font color=Blue>string_metric</font> <font color=Red>::</font> Fontmetric <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> Double
<a name="line-250"></a><font color=Blue>string_metric</font> metric s <font color=Red>=</font> sum <font color=Red>[</font> char_metric metric c <font color=Red>|</font> c <font color=Red>&lt;-</font> s <font color=Red>]</font>
<a name="line-251"></a>
<a name="line-252"></a><a name="Font"></a><font color=Blue><i>-- | A data type describing a scaled font. This consists of a base</i></font>
<a name="line-253"></a><a name="Font"></a><font color=Blue><i>-- font and a point size.</i></font>
<a name="line-254"></a><a name="Font"></a><font color=Green><u>data</u></font> Font <font color=Red>=</font> Font Basefont Double
<a name="line-255"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-256"></a>
<a name="line-257"></a><a name="nominalsize"></a><font color=Blue><i>-- | Return the nominal point size of a font.</i></font>
<a name="line-258"></a><font color=Blue>nominalsize</font> <font color=Red>::</font> Font <font color=Red>-&gt;</font> Double
<a name="line-259"></a><font color=Blue>nominalsize</font> <font color=Cyan>(</font>Font basefont pointsize<font color=Cyan>)</font> <font color=Red>=</font> pointsize
<a name="line-260"></a>
<a name="line-261"></a><a name="text_width"></a><font color=Blue><i>-- | Return the width of the given string in the given font.</i></font>
<a name="line-262"></a><font color=Blue>text_width</font> <font color=Red>::</font> Font <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> Double
<a name="line-263"></a><font color=Blue>text_width</font> <font color=Cyan>(</font>Font basefont pointsize<font color=Cyan>)</font> s <font color=Red>=</font> pointsize <font color=Cyan>*</font> string_metric m s
<a name="line-264"></a>  <font color=Green><u>where</u></font>
<a name="line-265"></a>    m <font color=Red>=</font> metric basefont
<a name="line-266"></a>
<a name="line-267"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-268"></a><font color=Blue><i>-- ** Alignment</i></font>
<a name="line-269"></a>
<a name="line-270"></a><a name="Alignment"></a><font color=Blue><i>-- | A real number representing text alignment.  0 = left aligned, 0.5</i></font>
<a name="line-271"></a><a name="Alignment"></a><font color=Blue><i>-- = centered, 1 = right aligned. Intermediate values are also</i></font>
<a name="line-272"></a><a name="Alignment"></a><font color=Blue><i>-- possible. For example, an alignment value of 0.25 means one quarter</i></font>
<a name="line-273"></a><a name="Alignment"></a><font color=Blue><i>-- of the way between left aligned and right aligned.</i></font>
<a name="line-274"></a><a name="Alignment"></a><font color=Green><u>type</u></font> Alignment <font color=Red>=</font> Double
<a name="line-275"></a>
<a name="line-276"></a><a name="align_left"></a><font color=Blue><i>-- | Left alignment.</i></font>
<a name="line-277"></a><font color=Blue>align_left</font> <font color=Red>::</font> Alignment
<a name="line-278"></a><font color=Blue>align_left</font> <font color=Red>=</font> <font color=Magenta>0.0</font>
<a name="line-279"></a>
<a name="line-280"></a><a name="align_center"></a><font color=Blue><i>-- | Centered alignment.</i></font>
<a name="line-281"></a><font color=Blue>align_center</font> <font color=Red>::</font> Alignment
<a name="line-282"></a><font color=Blue>align_center</font> <font color=Red>=</font> <font color=Magenta>0.5</font>
<a name="line-283"></a>
<a name="line-284"></a><a name="align_right"></a><font color=Blue><i>-- | Right alignment.</i></font>
<a name="line-285"></a><font color=Blue>align_right</font> <font color=Red>::</font> Alignment
<a name="line-286"></a><font color=Blue>align_right</font> <font color=Red>=</font> <font color=Magenta>1.0</font>
<a name="line-287"></a>
<a name="line-288"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-289"></a><font color=Blue><i>-- * The Document monad</i></font>
<a name="line-290"></a>  
<a name="line-291"></a><font color=Blue><i>-- $DOCUMENTMODEL </i></font>
<a name="line-292"></a><font color=Blue><i>-- </i></font>
<a name="line-293"></a><font color=Blue><i>-- Document description takes place in the 'Document' monad. A basic</i></font>
<a name="line-294"></a><font color=Blue><i>-- multi-page document has the following structure:</i></font>
<a name="line-295"></a><font color=Blue><i>-- </i></font>
<a name="line-296"></a><font color=Blue><i>-- &gt; document :: Document ()</i></font>
<a name="line-297"></a><font color=Blue><i>-- &gt; document = do</i></font>
<a name="line-298"></a><font color=Blue><i>-- &gt;   newpage x y $ do</i></font>
<a name="line-299"></a><font color=Blue><i>-- &gt;     &lt;&lt;&lt;drawing commands&gt;&gt;&gt;</i></font>
<a name="line-300"></a><font color=Blue><i>-- &gt;   newpage x y $ do</i></font>
<a name="line-301"></a><font color=Blue><i>-- &gt;     &lt;&lt;&lt;drawing commands&gt;&gt;&gt;</i></font>
<a name="line-302"></a><font color=Blue><i>-- &gt;   ...</i></font>
<a name="line-303"></a><font color=Blue><i>-- </i></font>
<a name="line-304"></a><font color=Blue><i>-- Here, each 'newpage' command describes one page of the</i></font>
<a name="line-305"></a><font color=Blue><i>-- document. The parameters /x/ and /y/ specify the dimensions of the</i></font>
<a name="line-306"></a><font color=Blue><i>-- page bounding box. They are expressed in units of PostScript</i></font>
<a name="line-307"></a><font color=Blue><i>-- points, i.e., multiples of 1/72 inch.</i></font>
<a name="line-308"></a><font color=Blue><i>-- </i></font>
<a name="line-309"></a><font color=Blue><i>-- Sometimes the bounding box for a page is not known until after the</i></font>
<a name="line-310"></a><font color=Blue><i>-- page content has been generated. For this purpose, we also provide</i></font>
<a name="line-311"></a><font color=Blue><i>-- the following alternative to the 'newpage' command:</i></font>
<a name="line-312"></a><font color=Blue><i>-- </i></font>
<a name="line-313"></a><font color=Blue><i>-- &gt;   newpage_defer $ do</i></font>
<a name="line-314"></a><font color=Blue><i>-- &gt;     &lt;&lt;&lt;drawing commands&gt;&gt;&gt;</i></font>
<a name="line-315"></a><font color=Blue><i>-- &gt;     endpage x y</i></font>
<a name="line-316"></a><font color=Blue><i>-- </i></font>
<a name="line-317"></a><font color=Blue><i>-- It works just like the 'newpage' command, except that the bounding</i></font>
<a name="line-318"></a><font color=Blue><i>-- box is given at the end.</i></font>
<a name="line-319"></a>
<a name="line-320"></a><a name="Document"></a><font color=Blue><i>-- | The Document monad.</i></font>
<a name="line-321"></a><a name="Document"></a><font color=Green><u>data</u></font> Document a <font color=Red>=</font>
<a name="line-322"></a>  Document_Return a                       <font color=Blue><i>-- ^ Terminate with a result.</i></font>
<a name="line-323"></a>  <font color=Red>|</font> Document_Page X Y <font color=Cyan>(</font>Draw <font color=Cyan>(</font>Document a<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Blue><i>-- ^ Page with bounding box</i></font>
<a name="line-324"></a>                                          <font color=Blue><i>-- known at the beginning.</i></font>
<a name="line-325"></a>  <font color=Red>|</font> Document_Page_defer <font color=Cyan>(</font>Draw <font color=Cyan>(</font>X<font color=Cyan>,</font> Y<font color=Cyan>,</font> Document a<font color=Cyan>)</font><font color=Cyan>)</font> 
<a name="line-326"></a>                                          <font color=Blue><i>-- ^ Page with bounding box</i></font>
<a name="line-327"></a>                                          <font color=Blue><i>-- known at the end.</i></font>
<a name="line-328"></a>
<a name="line-329"></a><font color=Green><u>instance</u></font> Monad Document <font color=Green><u>where</u></font>
<a name="line-330"></a>  return a <font color=Red>=</font> Document_Return a
<a name="line-331"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> <font color=Green><u>case</u></font> f <font color=Green><u>of</u></font>
<a name="line-332"></a>    Document_Return a <font color=Red>-&gt;</font> g a
<a name="line-333"></a>    Document_Page x y draw <font color=Red>-&gt;</font> Document_Page x y draw' <font color=Green><u>where</u></font>
<a name="line-334"></a>      draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-335"></a>        f' <font color=Red>&lt;-</font> draw
<a name="line-336"></a>        return <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-337"></a>    Document_Page_defer draw <font color=Red>-&gt;</font> Document_Page_defer draw' <font color=Green><u>where</u></font>
<a name="line-338"></a>      draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-339"></a>        <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> f'<font color=Cyan>)</font> <font color=Red>&lt;-</font> draw
<a name="line-340"></a>        return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-341"></a>                     
<a name="line-342"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-343"></a><font color=Blue><i>-- ** A vacuous run function</i></font>
<a name="line-344"></a>        
<a name="line-345"></a><a name="document_skip"></a><font color=Blue><i>-- | Skip document without rendering.        </i></font>
<a name="line-346"></a><font color=Blue>document_skip</font> <font color=Red>::</font> Document a <font color=Red>-&gt;</font> a
<a name="line-347"></a><font color=Blue>document_skip</font> <font color=Cyan>(</font>Document_Return a<font color=Cyan>)</font> <font color=Red>=</font> a
<a name="line-348"></a><font color=Blue>document_skip</font> <font color=Cyan>(</font>Document_Page x y draw<font color=Cyan>)</font> <font color=Red>=</font> document_skip a <font color=Green><u>where</u></font>
<a name="line-349"></a>  a <font color=Red>=</font> draw_skip draw
<a name="line-350"></a><font color=Blue>document_skip</font> <font color=Cyan>(</font>Document_Page_defer draw<font color=Cyan>)</font> <font color=Red>=</font> document_skip a <font color=Green><u>where</u></font>
<a name="line-351"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> draw_skip draw
<a name="line-352"></a>
<a name="line-353"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-354"></a><font color=Blue><i>-- ** User-level document structuring commands</i></font>
<a name="line-355"></a>
<a name="line-356"></a><a name="newpage"></a><font color=Blue><i>-- | Create a page of the given bounding box, containing the given</i></font>
<a name="line-357"></a><font color=Blue><i>-- drawing.</i></font>
<a name="line-358"></a><font color=Blue>newpage</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw a <font color=Red>-&gt;</font> Document a
<a name="line-359"></a><font color=Blue>newpage</font> x y draw <font color=Red>=</font>
<a name="line-360"></a>  Document_Page x y draw' <font color=Green><u>where</u></font>
<a name="line-361"></a>    draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-362"></a>      a <font color=Red>&lt;-</font> draw
<a name="line-363"></a>      return <font color=Cyan>(</font>Document_Return a<font color=Cyan>)</font>
<a name="line-364"></a>            
<a name="line-365"></a><a name="newpage_defer"></a><font color=Blue><i>-- | Create a page containing the given drawing, with the bounding box</i></font>
<a name="line-366"></a><font color=Blue><i>-- computed at the end of the drawing routines.</i></font>
<a name="line-367"></a><font color=Blue>newpage_defer</font> <font color=Red>::</font> Draw <font color=Cyan>(</font>X<font color=Cyan>,</font> Y<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>-&gt;</font> Document a
<a name="line-368"></a><font color=Blue>newpage_defer</font> draw <font color=Red>=</font>
<a name="line-369"></a>  Document_Page_defer draw' <font color=Green><u>where</u></font>
<a name="line-370"></a>    draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-371"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>&lt;-</font> draw
<a name="line-372"></a>      return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> Document_Return a<font color=Cyan>)</font>
<a name="line-373"></a>
<a name="line-374"></a><a name="endpage"></a><font color=Blue><i>-- | End the page with the given bounding box.</i></font>
<a name="line-375"></a><font color=Blue>endpage</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw <font color=Cyan>(</font>X<font color=Cyan>,</font> Y<font color=Cyan>,</font> ()<font color=Cyan>)</font>
<a name="line-376"></a><font color=Blue>endpage</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-377"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> ()<font color=Cyan>)</font>
<a name="line-378"></a>
<a name="line-379"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-380"></a><font color=Blue><i>-- * The Draw monad</i></font>
<a name="line-381"></a>
<a name="line-382"></a><font color=Blue><i>-- $DRAWINGMODEL </i></font>
<a name="line-383"></a><font color=Blue><i>-- </i></font>
<a name="line-384"></a><font color=Blue><i>-- The description of the visible content of a page take place in the</i></font>
<a name="line-385"></a><font color=Blue><i>-- 'Draw' monad. It takes the form of a sequence of drawing commands,</i></font>
<a name="line-386"></a><font color=Blue><i>-- for example:</i></font>
<a name="line-387"></a><font color=Blue><i>-- </i></font>
<a name="line-388"></a><font color=Blue><i>-- &gt;     moveto 10 10</i></font>
<a name="line-389"></a><font color=Blue><i>-- &gt;     lineto 10 100</i></font>
<a name="line-390"></a><font color=Blue><i>-- &gt;     lineto 100 100</i></font>
<a name="line-391"></a><font color=Blue><i>-- &gt;     lineto 100 10</i></font>
<a name="line-392"></a><font color=Blue><i>-- &gt;     closepath</i></font>
<a name="line-393"></a><font color=Blue><i>-- &gt;     stroke</i></font>
<a name="line-394"></a><font color=Blue><i>-- </i></font>
<a name="line-395"></a><font color=Blue><i>-- The graphics model is similar to that of the PostScript and PDF</i></font>
<a name="line-396"></a><font color=Blue><i>-- languages. The basic concept is that of a /path/, which is a</i></font>
<a name="line-397"></a><font color=Blue><i>-- sequence of straight and curved line segments. Paths are first</i></font>
<a name="line-398"></a><font color=Blue><i>-- constructed using /path construction commands/, and then painted</i></font>
<a name="line-399"></a><font color=Blue><i>-- using /painting commands/, depending on a set of current </i></font>
<a name="line-400"></a><font color=Blue><i>-- /graphics parameters/ and a current /coordinate system/.</i></font>
<a name="line-401"></a><font color=Blue><i>-- </i></font>
<a name="line-402"></a><font color=Blue><i>-- We also provide block structure. Changes to the graphics state</i></font>
<a name="line-403"></a><font color=Blue><i>-- (color, coordinate system, etc.) that are done within a block are</i></font>
<a name="line-404"></a><font color=Blue><i>-- local to the block.</i></font>
<a name="line-405"></a><font color=Blue><i>-- </i></font>
<a name="line-406"></a><font color=Blue><i>-- &gt;     block $ do</i></font>
<a name="line-407"></a><font color=Blue><i>-- &gt;       &lt;&lt;drawing commands&gt;&gt;</i></font>
<a name="line-408"></a>  
<a name="line-409"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-410"></a><font color=Blue><i>-- ** Internal definition of the Draw monad</i></font>
<a name="line-411"></a>
<a name="line-412"></a><a name="DrawCommand"></a><font color=Blue><i>-- | An abstract data type describing individual drawing commands.</i></font>
<a name="line-413"></a><a name="DrawCommand"></a><font color=Green><u>data</u></font> DrawCommand <font color=Red>=</font>
<a name="line-414"></a>  Newpath        <font color=Blue><i>-- ^ Set the current path to empty.</i></font>
<a name="line-415"></a>  <font color=Red>|</font> Moveto X Y   <font color=Blue><i>-- ^ Start a new subpath at the given coordinates.</i></font>
<a name="line-416"></a>  <font color=Red>|</font> Lineto X Y   <font color=Blue><i>-- ^ Append a straight line to the current subpath.</i></font>
<a name="line-417"></a>  <font color=Red>|</font> Curveto X Y X Y X Y <font color=Blue><i>-- ^ Append a Bezier curve segment.</i></font>
<a name="line-418"></a>  <font color=Red>|</font> Closepath    <font color=Blue><i>-- ^ Close the current subpath.</i></font>
<a name="line-419"></a>  <font color=Red>|</font> Stroke       <font color=Blue><i>-- ^ Stroke and clear the current path.</i></font>
<a name="line-420"></a>  <font color=Red>|</font> Fill Color   <font color=Blue><i>-- ^ Fill and clear the current path.</i></font>
<a name="line-421"></a>  <font color=Red>|</font> FillStroke Color <font color=Blue><i>-- ^ Fill and stroke and clear the current path.</i></font>
<a name="line-422"></a>  <font color=Red>|</font> TextBox Alignment Font Color X Y X Y Double String <font color=Blue><i>-- ^ Text.</i></font>
<a name="line-423"></a>  <font color=Red>|</font> SetLineWidth Double  <font color=Blue><i>-- ^ Set current line width.</i></font>
<a name="line-424"></a>  <font color=Red>|</font> SetColor Color <font color=Blue><i>-- ^ Set current color.</i></font>
<a name="line-425"></a>  <font color=Red>|</font> Translate X Y  <font color=Blue><i>-- ^ Translate current coordinate system.</i></font>
<a name="line-426"></a>  <font color=Red>|</font> Scale X Y      <font color=Blue><i>-- ^ Scale the current coordinate system.</i></font>
<a name="line-427"></a>  <font color=Red>|</font> Rotate Double  <font color=Blue><i>-- ^ Rotate the current coordinate system.</i></font>
<a name="line-428"></a>  <font color=Red>|</font> Comment String <font color=Blue><i>-- ^ A human-readable comment, not rendered</i></font>
<a name="line-429"></a>  <font color=Red>|</font> Subroutine <font color=Cyan>(</font>Draw ()<font color=Cyan>)</font> <font color=Red>[</font>CustomDef<font color=Red>]</font>
<a name="line-430"></a>                 <font color=Blue><i>-- ^ A subroutine is a composite drawing command. In</i></font>
<a name="line-431"></a>                 <font color=Blue><i>-- addition to a default definition that works for</i></font>
<a name="line-432"></a>                 <font color=Blue><i>-- any backend, it can also have optional specialized</i></font>
<a name="line-433"></a>                 <font color=Blue><i>-- definitions for particular backends.</i></font>
<a name="line-434"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-435"></a>
<a name="line-436"></a><font color=Blue><i>-- $ In understanding how the 'Draw' monad works, it is useful to keep</i></font>
<a name="line-437"></a><font color=Blue><i>-- in mind that there is an isomorphism</i></font>
<a name="line-438"></a><font color=Blue><i>-- </i></font>
<a name="line-439"></a><font color=Blue><i>-- @Draw /a/@ &#8773; @Draw ()@ &#215;. /a/,</i></font>
<a name="line-440"></a><font color=Blue><i>-- </i></font>
<a name="line-441"></a><font color=Blue><i>-- where \"&#215;.\" is left-strict product, i.e., if the left-hand-side is</i></font>
<a name="line-442"></a><font color=Blue><i>-- undefined, then so is the entire expression.</i></font>
<a name="line-443"></a>
<a name="line-444"></a><a name="Draw"></a><font color=Blue><i>-- | The Draw monad.</i></font>
<a name="line-445"></a><a name="Draw"></a><font color=Green><u>data</u></font> Draw a <font color=Red>=</font> 
<a name="line-446"></a>  Draw_Return a                     <font color=Blue><i>-- ^ Terminate with a result.</i></font>
<a name="line-447"></a>  <font color=Red>|</font> Draw_Write DrawCommand <font color=Cyan>(</font>Draw a<font color=Cyan>)</font> <font color=Blue><i>-- ^ Write a command and continue.</i></font>
<a name="line-448"></a>  <font color=Red>|</font> Draw_Block <font color=Cyan>(</font>Draw <font color=Cyan>(</font>Draw a<font color=Cyan>)</font><font color=Cyan>)</font>      <font color=Blue><i>-- ^ Block structure. Perform the</i></font>
<a name="line-449"></a>                                    <font color=Blue><i>-- commands of the outer 'Draw' in</i></font>
<a name="line-450"></a>                                    <font color=Blue><i>-- a temporary copy of the</i></font>
<a name="line-451"></a>                                    <font color=Blue><i>-- graphics state, then continue</i></font>
<a name="line-452"></a>                                    <font color=Blue><i>-- with the inner 'Draw' in the</i></font>
<a name="line-453"></a>                                    <font color=Blue><i>-- original graphics state.</i></font>
<a name="line-454"></a>    <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-455"></a>    
<a name="line-456"></a><font color=Green><u>instance</u></font> Monad Draw <font color=Green><u>where</u></font>
<a name="line-457"></a>  return a <font color=Red>=</font> Draw_Return a
<a name="line-458"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> <font color=Green><u>case</u></font> f <font color=Green><u>of</u></font>
<a name="line-459"></a>    Draw_Return a <font color=Red>-&gt;</font> g a
<a name="line-460"></a>    Draw_Write cmd f' <font color=Red>-&gt;</font> Draw_Write cmd <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-461"></a>    Draw_Block draw <font color=Red>-&gt;</font> Draw_Block draw' <font color=Green><u>where</u></font>
<a name="line-462"></a>      draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-463"></a>        f' <font color=Red>&lt;-</font> draw
<a name="line-464"></a>        return <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-465"></a>
<a name="line-466"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-467"></a><font color=Blue><i>-- ** Low-level operations for the Draw monad</i></font>
<a name="line-468"></a>
<a name="line-469"></a><a name="draw_write"></a><font color=Blue><i>-- | Write the given command to the 'Draw' monad.</i></font>
<a name="line-470"></a><font color=Blue>draw_write</font> <font color=Red>::</font> DrawCommand <font color=Red>-&gt;</font> Draw ()
<a name="line-471"></a><font color=Blue>draw_write</font> cmd <font color=Red>=</font> 
<a name="line-472"></a>  Draw_Write cmd <font color=Cyan>(</font>Draw_Return ()<font color=Cyan>)</font>  
<a name="line-473"></a>
<a name="line-474"></a><a name="draw_subroutine"></a><font color=Blue><i>-- | Create a new subroutine.</i></font>
<a name="line-475"></a><font color=Blue>draw_subroutine</font> <font color=Red>::</font> <font color=Red>[</font>CustomDef<font color=Red>]</font> <font color=Red>-&gt;</font> Draw () <font color=Red>-&gt;</font> Draw ()
<a name="line-476"></a><font color=Blue>draw_subroutine</font> alt draw <font color=Red>=</font>
<a name="line-477"></a>  draw_write <font color=Cyan>(</font>Subroutine draw alt<font color=Cyan>)</font>
<a name="line-478"></a>
<a name="line-479"></a><a name="draw_block"></a><font color=Blue><i>-- | Write a block to the 'Draw' monad.</i></font>
<a name="line-480"></a><font color=Blue>draw_block</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> Draw a
<a name="line-481"></a><font color=Blue>draw_block</font> draw <font color=Red>=</font> 
<a name="line-482"></a>  Draw_Block draw' <font color=Green><u>where</u></font>
<a name="line-483"></a>    draw' <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-484"></a>      a <font color=Red>&lt;-</font> draw
<a name="line-485"></a>      return <font color=Cyan>(</font>Draw_Return a<font color=Cyan>)</font>
<a name="line-486"></a>      
<a name="line-487"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-488"></a><font color=Blue><i>-- ** A vacuous run function</i></font>
<a name="line-489"></a>
<a name="line-490"></a><a name="draw_skip"></a><font color=Blue><i>-- | Skip draw actions without rendering.</i></font>
<a name="line-491"></a><font color=Blue>draw_skip</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> a
<a name="line-492"></a><font color=Blue>draw_skip</font> <font color=Cyan>(</font>Draw_Return x<font color=Cyan>)</font> <font color=Red>=</font> x
<a name="line-493"></a><font color=Blue>draw_skip</font> <font color=Cyan>(</font>Draw_Write cmd cont<font color=Cyan>)</font> <font color=Red>=</font> draw_skip cont
<a name="line-494"></a><font color=Blue>draw_skip</font> <font color=Cyan>(</font>Draw_Block f<font color=Cyan>)</font> <font color=Red>=</font> draw_skip <font color=Cyan>(</font>draw_skip f<font color=Cyan>)</font>
<a name="line-495"></a>
<a name="line-496"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-497"></a><font color=Blue><i>-- ** User-level drawing commands</i></font>
<a name="line-498"></a>
<a name="line-499"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-500"></a><font color=Blue><i>-- *** Path construction commands</i></font>
<a name="line-501"></a>
<a name="line-502"></a><font color=Blue><i>-- $PATHCONSTRUCTION</i></font>
<a name="line-503"></a><font color=Blue><i>--   </i></font>
<a name="line-504"></a><font color=Blue><i>-- During path construction, there is a notion of /current path/ and</i></font>
<a name="line-505"></a><font color=Blue><i>-- /current point/. A path may consist of zero or more connected</i></font>
<a name="line-506"></a><font color=Blue><i>-- subpaths, and each subpath is either open or closed. </i></font>
<a name="line-507"></a>
<a name="line-508"></a><a name="newpath"></a><font color=Blue><i>-- | Set the current path to empty.</i></font>
<a name="line-509"></a><font color=Blue>newpath</font> <font color=Red>::</font> Draw ()
<a name="line-510"></a><font color=Blue>newpath</font> <font color=Red>=</font> draw_write <font color=Cyan>(</font>Newpath<font color=Cyan>)</font>
<a name="line-511"></a>
<a name="line-512"></a><a name="moveto"></a><font color=Blue><i>-- | Start a new subpath at (/x/,/y/). The point (/x/,/y/) becomes the</i></font>
<a name="line-513"></a><font color=Blue><i>-- current point.</i></font>
<a name="line-514"></a><font color=Blue>moveto</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-515"></a><font color=Blue>moveto</font> x y <font color=Red>=</font> draw_write <font color=Cyan>(</font>Moveto x y<font color=Cyan>)</font>
<a name="line-516"></a>
<a name="line-517"></a><a name="lineto"></a><font color=Blue><i>-- | Extend the current subpath by a straight line segment from the</i></font>
<a name="line-518"></a><font color=Blue><i>-- current point to (/x/,/y/). The point (/x/,/y/) becomes the current</i></font>
<a name="line-519"></a><font color=Blue><i>-- point.</i></font>
<a name="line-520"></a><font color=Blue>lineto</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-521"></a><font color=Blue>lineto</font> x y <font color=Red>=</font> draw_write <font color=Cyan>(</font>Lineto x y<font color=Cyan>)</font>
<a name="line-522"></a>
<a name="line-523"></a><a name="curveto"></a><font color=Blue><i>-- | @'curveto' /x1/ /y1/ /x2/ /y2/ /x/ /y/@: Extend the current</i></font>
<a name="line-524"></a><font color=Blue><i>-- subpath by a Bezier curve segment from the current point to</i></font>
<a name="line-525"></a><font color=Blue><i>-- (/x/,/y/), with control points (/x1/,/y1/) and (/x2/,/y2/). The</i></font>
<a name="line-526"></a><font color=Blue><i>-- point (/x/,/y/) becomes the current point.</i></font>
<a name="line-527"></a><font color=Blue>curveto</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-528"></a><font color=Blue>curveto</font> x1 y1 x2 y2 x y <font color=Red>=</font> draw_write <font color=Cyan>(</font>Curveto x1 y1 x2 y2 x y<font color=Cyan>)</font>
<a name="line-529"></a>
<a name="line-530"></a><a name="closepath"></a><font color=Blue><i>-- | Close the current subpath. If necessary, connect the subpath's</i></font>
<a name="line-531"></a><font color=Blue><i>-- final and initial points by a straight line segment. Note that a</i></font>
<a name="line-532"></a><font color=Blue><i>-- closed path is rendered differently than a non-closed path whose</i></font>
<a name="line-533"></a><font color=Blue><i>-- initial and final points coincide, because in the latter case, the</i></font>
<a name="line-534"></a><font color=Blue><i>-- endpoints are capped rather than mitered.</i></font>
<a name="line-535"></a><font color=Blue>closepath</font> <font color=Red>::</font> Draw ()
<a name="line-536"></a><font color=Blue>closepath</font> <font color=Red>=</font> draw_write <font color=Cyan>(</font>Closepath<font color=Cyan>)</font>
<a name="line-537"></a>
<a name="line-538"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-539"></a><font color=Blue><i>-- *** Painting commands</i></font>
<a name="line-540"></a>
<a name="line-541"></a><a name="stroke"></a><font color=Blue><i>-- | Stroke the current path, using the current line color, line</i></font>
<a name="line-542"></a><font color=Blue><i>-- width, and other graphics parameters. This operation implicitly</i></font>
<a name="line-543"></a><font color=Blue><i>-- resets the current path to empty.</i></font>
<a name="line-544"></a><font color=Blue>stroke</font> <font color=Red>::</font> Draw ()
<a name="line-545"></a><font color=Blue>stroke</font> <font color=Red>=</font> draw_write <font color=Cyan>(</font>Stroke<font color=Cyan>)</font>
<a name="line-546"></a>
<a name="line-547"></a><a name="fill"></a><font color=Blue><i>-- | Fill the current path, using the given color. This operation</i></font>
<a name="line-548"></a><font color=Blue><i>-- implicitly resets the current path to empty. </i></font>
<a name="line-549"></a><font color=Blue>fill</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> Draw ()
<a name="line-550"></a><font color=Blue>fill</font> color <font color=Red>=</font> draw_write <font color=Cyan>(</font>Fill color<font color=Cyan>)</font>
<a name="line-551"></a>
<a name="line-552"></a><a name="fillstroke"></a><font color=Blue><i>-- | Fill the current path, using the given color; also stroke the</i></font>
<a name="line-553"></a><font color=Blue><i>-- path using the current line color. This operation implicitly resets</i></font>
<a name="line-554"></a><font color=Blue><i>-- the current path to empty.</i></font>
<a name="line-555"></a><font color=Blue>fillstroke</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> Draw ()
<a name="line-556"></a><font color=Blue>fillstroke</font> color <font color=Red>=</font> draw_write <font color=Cyan>(</font>FillStroke color<font color=Cyan>)</font>
<a name="line-557"></a>
<a name="line-558"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-559"></a><font color=Blue><i>-- *** Text</i></font>
<a name="line-560"></a>
<a name="line-561"></a><a name="textbox"></a><font color=Blue><i>-- | @'textbox' /a/ /f/ /c/ /x0/ /y0/ /x1/ /y1/ /b/ /s/@: Write the</i></font>
<a name="line-562"></a><font color=Blue><i>-- given string on an imaginary line from point (/x0/,/y0/) to</i></font>
<a name="line-563"></a><font color=Blue><i>-- (/x1/,/y1/), using font /f/ and color /c/. If the text is too wide</i></font>
<a name="line-564"></a><font color=Blue><i>-- to fit on the line, it is scaled down. Otherwise, it is aligned</i></font>
<a name="line-565"></a><font color=Blue><i>-- according to the alignment parameter /a/. The parameter /b/</i></font>
<a name="line-566"></a><font color=Blue><i>-- specifies an additional offset by which to lower the text, with</i></font>
<a name="line-567"></a><font color=Blue><i>-- respect to the text's nominal size. For example, if /b/=0, then the</i></font>
<a name="line-568"></a><font color=Blue><i>-- above-mentioned imaginary line from (/x0/,/y0/) to (/x1/,/y1/)</i></font>
<a name="line-569"></a><font color=Blue><i>-- coincides with the text's usual baseline. If /b/=0.5, then this</i></font>
<a name="line-570"></a><font color=Blue><i>-- line approximately goes through the center of each character.</i></font>
<a name="line-571"></a><font color=Blue><i>-- </i></font>
<a name="line-572"></a><font color=Blue><i>-- \[image textbox.png]</i></font>
<a name="line-573"></a><font color=Blue>textbox</font> <font color=Red>::</font> Alignment <font color=Red>-&gt;</font> Font <font color=Red>-&gt;</font> Color <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> String <font color=Red>-&gt;</font> Draw ()
<a name="line-574"></a><font color=Blue>textbox</font> a f c x0 y0 x1 y1 b s <font color=Red>=</font> draw_write <font color=Cyan>(</font>TextBox a f c x0 y0 x1 y1 b s<font color=Cyan>)</font>
<a name="line-575"></a>
<a name="line-576"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-577"></a><font color=Blue><i>-- *** Graphics parameters</i></font>
<a name="line-578"></a>
<a name="line-579"></a><font color=Blue><i>-- $GRAPHICSPARAMETERS</i></font>
<a name="line-580"></a><font color=Blue><i>-- </i></font>
<a name="line-581"></a><font color=Blue><i>-- The painting commands rely on a set of graphics parameters. The</i></font>
<a name="line-582"></a><font color=Blue><i>-- graphics parameters are initially set to default values, and can be</i></font>
<a name="line-583"></a><font color=Blue><i>-- altered with the following commands.</i></font>
<a name="line-584"></a>
<a name="line-585"></a><a name="setlinewidth"></a><font color=Blue><i>-- | Set the line width. The initial line width is 1.</i></font>
<a name="line-586"></a><font color=Blue>setlinewidth</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> Draw ()
<a name="line-587"></a><font color=Blue>setlinewidth</font> x <font color=Red>=</font> draw_write <font color=Cyan>(</font>SetLineWidth x<font color=Cyan>)</font>
<a name="line-588"></a>
<a name="line-589"></a><a name="setcolor"></a><font color=Blue><i>-- | Set the current color for stroking. The initial stroke color is</i></font>
<a name="line-590"></a><font color=Blue><i>-- black.</i></font>
<a name="line-591"></a><font color=Blue>setcolor</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> Draw ()
<a name="line-592"></a><font color=Blue>setcolor</font> color <font color=Red>=</font> draw_write <font color=Cyan>(</font>SetColor color<font color=Cyan>)</font>
<a name="line-593"></a>
<a name="line-594"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-595"></a><font color=Blue><i>-- *** Coordinate system</i></font>
<a name="line-596"></a>
<a name="line-597"></a><font color=Blue><i>-- $COORDINATESYSTEM</i></font>
<a name="line-598"></a><font color=Blue><i>-- </i></font>
<a name="line-599"></a><font color=Blue><i>-- Coordinates, lengths, widths, etc, are all interpreted relative to</i></font>
<a name="line-600"></a><font color=Blue><i>-- a /current coordinate system/. The initial coordinate system of</i></font>
<a name="line-601"></a><font color=Blue><i>-- each page has the origin in the lower left corner, with each unit</i></font>
<a name="line-602"></a><font color=Blue><i>-- equaling one PostScript point (1/72 inch). The following commands</i></font>
<a name="line-603"></a><font color=Blue><i>-- can be used to change the current coordinate system.</i></font>
<a name="line-604"></a>
<a name="line-605"></a><a name="translate"></a><font color=Blue><i>-- | Translate the current coordinate system by (/x/,/y/).</i></font>
<a name="line-606"></a><font color=Blue>translate</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-607"></a><font color=Blue>translate</font> x y <font color=Red>=</font> draw_write <font color=Cyan>(</font>Translate x y<font color=Cyan>)</font>
<a name="line-608"></a>
<a name="line-609"></a><a name="scale"></a><font color=Blue><i>-- | Scale the current coordinate system by (/s/,/t/). Here, /s/ is</i></font>
<a name="line-610"></a><font color=Blue><i>-- the scaling factor in the /x/-direction, and /t/ is the scaling</i></font>
<a name="line-611"></a><font color=Blue><i>-- factor in the /y/-direction.</i></font>
<a name="line-612"></a><font color=Blue>scale</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-613"></a><font color=Blue>scale</font> x y <font color=Red>=</font> draw_write <font color=Cyan>(</font>Scale x y<font color=Cyan>)</font>
<a name="line-614"></a>
<a name="line-615"></a><a name="rotate"></a><font color=Blue><i>-- | Rotate the current coordinate system by /angle/, measured</i></font>
<a name="line-616"></a><font color=Blue><i>-- counterclockwise in degrees.</i></font>
<a name="line-617"></a><font color=Blue>rotate</font> <font color=Red>::</font> Double <font color=Red>-&gt;</font> Draw ()
<a name="line-618"></a><font color=Blue>rotate</font> angle <font color=Red>=</font> draw_write <font color=Cyan>(</font>Rotate angle<font color=Cyan>)</font>
<a name="line-619"></a>
<a name="line-620"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-621"></a><font color=Blue><i>-- *** Comments</i></font>
<a name="line-622"></a>
<a name="line-623"></a><a name="comment"></a><font color=Blue><i>-- | Insert a human-readable comment in the content stream. This is</i></font>
<a name="line-624"></a><font color=Blue><i>-- for information only, and is not rendered in the graphical output.</i></font>
<a name="line-625"></a><font color=Blue>comment</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> Draw ()
<a name="line-626"></a><font color=Blue>comment</font> s <font color=Red>=</font> draw_write <font color=Cyan>(</font>Comment s<font color=Cyan>)</font>
<a name="line-627"></a>
<a name="line-628"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-629"></a><font color=Blue><i>-- *** Block structure</i></font>
<a name="line-630"></a>
<a name="line-631"></a><font color=Blue><i>-- $BLOCKSTRUCTURE </i></font>
<a name="line-632"></a><font color=Blue><i>-- </i></font>
<a name="line-633"></a><font color=Blue><i>-- Drawing operations can be grouped into blocks with the 'block'</i></font>
<a name="line-634"></a><font color=Blue><i>-- operator. Changes to the graphics parameters and coordinate system</i></font>
<a name="line-635"></a><font color=Blue><i>-- are local to the block. It is undefined whether changes to the</i></font>
<a name="line-636"></a><font color=Blue><i>-- current path made within a block persist after the end of the block</i></font>
<a name="line-637"></a><font color=Blue><i>-- (they do in PDF, but not in PostScript). Therefore, path</i></font>
<a name="line-638"></a><font color=Blue><i>-- construction should not be broken up across end-of-block boundaries.</i></font>
<a name="line-639"></a>
<a name="line-640"></a><a name="block"></a><font color=Blue><i>-- | Perform a block of commands in a local copy of the graphics</i></font>
<a name="line-641"></a><font color=Blue><i>-- state. This is intended to be used like this:</i></font>
<a name="line-642"></a><font color=Blue><i>-- </i></font>
<a name="line-643"></a><font color=Blue><i>-- &gt;     block $ do</i></font>
<a name="line-644"></a><font color=Blue><i>-- &gt;       &lt;&lt;drawing commands&gt;&gt;</i></font>
<a name="line-645"></a><font color=Blue>block</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> Draw a
<a name="line-646"></a><font color=Blue>block</font> <font color=Red>=</font> draw_block
<a name="line-647"></a>
<a name="line-648"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-649"></a><font color=Blue><i>-- *** Derived commands</i></font>
<a name="line-650"></a>
<a name="line-651"></a><font color=Blue><i>-- $ PDF has no built-in command for drawing circular arcs, so we</i></font>
<a name="line-652"></a><font color=Blue><i>-- define it here. Since PostScript does have such a command, we use</i></font>
<a name="line-653"></a><font color=Blue><i>-- the 'draw_subroutine' mechanism.</i></font>
<a name="line-654"></a>
<a name="line-655"></a><a name="arc"></a><font color=Blue><i>-- | Start a new subpath consisting of a circular arc segment. The</i></font>
<a name="line-656"></a><font color=Blue><i>-- arc segment is centered at (/x/,/y/), has radius /r/, and extends</i></font>
<a name="line-657"></a><font color=Blue><i>-- from angle /a1/ to angle /a2/, measured in degrees,</i></font>
<a name="line-658"></a><font color=Blue><i>-- counterclockwise from the /x/-axis. The arc is drawn clockwise if</i></font>
<a name="line-659"></a><font color=Blue><i>-- /a2/ &#8805; /a1/, and counterclockwise otherwise. The final point</i></font>
<a name="line-660"></a><font color=Blue><i>-- becomes the new current point.</i></font>
<a name="line-661"></a><font color=Blue>arc</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Draw ()
<a name="line-662"></a><font color=Blue>arc</font> x y r a1 a2 <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-663"></a>  arc_internal False x y r r a1 a2
<a name="line-664"></a>    <font color=Green><u>where</u></font>
<a name="line-665"></a>      alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f moveto\n"</font> x0 y0 <font color=Cyan>++</font> printf <font color=Magenta>"%f %f %f %f %f %s\n"</font> x y r a1 a2 <font color=Cyan>(</font><font color=Green><u>if</u></font> a1 <font color=Cyan>&lt;=</font> a2 <font color=Green><u>then</u></font> <font color=Magenta>"arc"</font> <font color=Green><u>else</u></font> <font color=Magenta>"arcn"</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-666"></a>             custom_ascii <font color=Cyan>$</font> printf <font color=Magenta>"Arc %f %f %f %f %f\n"</font> x y r a1 a2<font color=Red>]</font>
<a name="line-667"></a>      x0 <font color=Red>=</font> x <font color=Cyan>+</font> r <font color=Cyan>*</font> cos <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> a1<font color=Cyan>)</font>
<a name="line-668"></a>      y0 <font color=Red>=</font> y <font color=Cyan>+</font> r <font color=Cyan>*</font> sin <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> a1<font color=Cyan>)</font>
<a name="line-669"></a>
<a name="line-670"></a><a name="arc_append"></a><font color=Blue><i>-- | Like 'arc', except append to the current subpath. If necessary,</i></font>
<a name="line-671"></a><font color=Blue><i>-- add a straight line segment from the current point to the starting</i></font>
<a name="line-672"></a><font color=Blue><i>-- point of the arc.</i></font>
<a name="line-673"></a><font color=Blue>arc_append</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Draw ()
<a name="line-674"></a><font color=Blue>arc_append</font> x y r a1 a2 <font color=Red>=</font> draw_subroutine alt <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-675"></a>  arc_internal True x y r r a1 a2
<a name="line-676"></a>    <font color=Green><u>where</u></font>
<a name="line-677"></a>      alt <font color=Red>=</font> <font color=Red>[</font>custom_ps <font color=Cyan>$</font> printf <font color=Magenta>"%f %f %f %f %f %s\n"</font> x y r a1 a2 <font color=Cyan>(</font><font color=Green><u>if</u></font> a1 <font color=Cyan>&lt;=</font> a2 <font color=Green><u>then</u></font> <font color=Magenta>"arc"</font> <font color=Green><u>else</u></font> <font color=Magenta>"arcn"</font><font color=Cyan>)</font><font color=Cyan>,</font>
<a name="line-678"></a>             custom_ascii <font color=Cyan>$</font> printf <font color=Magenta>"Arc_append %f %f %f %f %f\n"</font> x y r a1 a2<font color=Red>]</font>
<a name="line-679"></a>
<a name="line-680"></a><a name="oval"></a><font color=Blue><i>-- | Append a new closed subpath consisting of an oval centered at</i></font>
<a name="line-681"></a><font color=Blue><i>-- (/x/,/y/), with horizontal and vertical radii /rx/ and /ry/,</i></font>
<a name="line-682"></a><font color=Blue><i>-- respectively.</i></font>
<a name="line-683"></a><font color=Blue>oval</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-684"></a><font color=Blue>oval</font> x y rx ry <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-685"></a>  arc_internal False x y rx ry <font color=Magenta>0</font> <font color=Magenta>360</font>
<a name="line-686"></a>  closepath
<a name="line-687"></a>
<a name="line-688"></a><a name="arc_internal"></a><font color=Blue><i>-- | The common implementation of 'arc', 'arc_append', and 'oval'. The</i></font>
<a name="line-689"></a><font color=Blue><i>-- first parameter is a boolean flag indicating whether to append to</i></font>
<a name="line-690"></a><font color=Blue><i>-- an existing subpath or start a new subpath. The fourth and fifth</i></font>
<a name="line-691"></a><font color=Blue><i>-- parameter are the horizontal and vertical radius.</i></font>
<a name="line-692"></a><font color=Blue>arc_internal</font> <font color=Red>::</font> Bool <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Double <font color=Red>-&gt;</font> Draw ()
<a name="line-693"></a><font color=Blue>arc_internal</font> connect x y rx ry a1 a2 <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-694"></a>  <font color=Green><u>if</u></font> connect <font color=Green><u>then</u></font> lineto x0 y0 <font color=Green><u>else</u></font> moveto x0 y0
<a name="line-695"></a>  <font color=Blue><i>-- We divide the arc into n segments of 90 degrees or less.</i></font>
<a name="line-696"></a>  sequence_ <font color=Red>[</font> aux a <font color=Red>|</font> i <font color=Red>&lt;-</font> <font color=Red>[</font><font color=Magenta>0</font><font color=Red>..</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Red>]</font><font color=Cyan>,</font> <font color=Green><u>let</u></font> a <font color=Red>=</font> a1 <font color=Cyan>+</font> <font color=Cyan>(</font>fromIntegral i<font color=Cyan>)</font><font color=Cyan>*</font>phi <font color=Red>]</font>
<a name="line-697"></a>  <font color=Green><u>where</u></font>
<a name="line-698"></a>    <font color=Cyan>(</font>x0<font color=Cyan>,</font> y0<font color=Cyan>)</font> <font color=Red>=</font> point rx ry a1
<a name="line-699"></a>    n <font color=Red>=</font> int_ceiling <font color=Cyan>(</font>abs<font color=Cyan>(</font>a2 <font color=Blue><i>-</i></font> a1<font color=Cyan>)</font> <font color=Cyan>/</font> <font color=Magenta>90</font><font color=Cyan>)</font>
<a name="line-700"></a>    phi <font color=Red>=</font> <font color=Green><u>if</u></font> n <font color=Cyan>&gt;</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font> <font color=Cyan>(</font>a2 <font color=Blue><i>-</i></font> a1<font color=Cyan>)</font> <font color=Cyan>/</font> <font color=Cyan>(</font>fromIntegral n<font color=Cyan>)</font> <font color=Green><u>else</u></font> <font color=Magenta>0</font>
<a name="line-701"></a>    alpha <font color=Red>=</font> <font color=Magenta>4</font><font color=Cyan>/</font><font color=Magenta>3</font> <font color=Cyan>*</font> c <font color=Cyan>/</font> <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>+</font>c<font color=Cyan>)</font>
<a name="line-702"></a>    c <font color=Red>=</font> cos' <font color=Cyan>(</font>phi<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-703"></a>    point rx ry a <font color=Red>=</font> <font color=Cyan>(</font>x <font color=Cyan>+</font> rx <font color=Cyan>*</font> cos' a<font color=Cyan>,</font> y <font color=Cyan>+</font> ry <font color=Cyan>*</font> sin' a<font color=Cyan>)</font>
<a name="line-704"></a>    cos' x <font color=Red>=</font> cos <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> x<font color=Cyan>)</font>
<a name="line-705"></a>    sin' x <font color=Red>=</font> sin <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> x<font color=Cyan>)</font>
<a name="line-706"></a>    along <font color=Cyan>(</font>x0<font color=Cyan>,</font>y0<font color=Cyan>)</font> <font color=Cyan>(</font>x1<font color=Cyan>,</font>y1<font color=Cyan>)</font> alpha <font color=Red>=</font> <font color=Cyan>(</font>x0 <font color=Cyan>+</font> alpha <font color=Cyan>*</font> <font color=Cyan>(</font>x1<font color=Blue><i>-</i></font>x0<font color=Cyan>)</font><font color=Cyan>,</font> y0 <font color=Cyan>+</font> alpha <font color=Cyan>*</font> <font color=Cyan>(</font>y1<font color=Blue><i>-</i></font>y0<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-707"></a>    aux a <font color=Red>=</font> curveto x1 y1 x2 y2 x3 y3
<a name="line-708"></a>      <font color=Green><u>where</u></font>
<a name="line-709"></a>        <font color=Cyan>(</font>x0<font color=Cyan>,</font> y0<font color=Cyan>)</font> <font color=Red>=</font> point rx ry a
<a name="line-710"></a>        <font color=Cyan>(</font>x3<font color=Cyan>,</font> y3<font color=Cyan>)</font> <font color=Red>=</font> point rx ry <font color=Cyan>(</font>a <font color=Cyan>+</font> phi<font color=Cyan>)</font>
<a name="line-711"></a>        <font color=Cyan>(</font>xp<font color=Cyan>,</font> yp<font color=Cyan>)</font> <font color=Red>=</font> point <font color=Cyan>(</font>rx<font color=Cyan>/</font>c<font color=Cyan>)</font> <font color=Cyan>(</font>ry<font color=Cyan>/</font>c<font color=Cyan>)</font> <font color=Cyan>(</font>a <font color=Cyan>+</font> phi<font color=Cyan>/</font><font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-712"></a>        <font color=Cyan>(</font>x1<font color=Cyan>,</font> y1<font color=Cyan>)</font> <font color=Red>=</font> along <font color=Cyan>(</font>x0<font color=Cyan>,</font> y0<font color=Cyan>)</font> <font color=Cyan>(</font>xp<font color=Cyan>,</font> yp<font color=Cyan>)</font> alpha
<a name="line-713"></a>        <font color=Cyan>(</font>x2<font color=Cyan>,</font> y2<font color=Cyan>)</font> <font color=Red>=</font> along <font color=Cyan>(</font>x3<font color=Cyan>,</font> y3<font color=Cyan>)</font> <font color=Cyan>(</font>xp<font color=Cyan>,</font> yp<font color=Cyan>)</font> alpha
<a name="line-714"></a>
<a name="line-715"></a><a name="rectangle"></a><font color=Blue><i>-- | @'rectangle' /x/ /y/ /w/ /h/@: Draw a rectangle of width /w/ and</i></font>
<a name="line-716"></a><font color=Blue><i>-- height /h/, starting from (/x/,/y/). If /w/ and /h/ are positive,</i></font>
<a name="line-717"></a><font color=Blue><i>-- then (/x/,/y/) is the lower left corner.</i></font>
<a name="line-718"></a><font color=Blue>rectangle</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> Draw ()
<a name="line-719"></a><font color=Blue>rectangle</font> x y w h <font color=Red>=</font> draw_subroutine alt def <font color=Green><u>where</u></font>
<a name="line-720"></a>  def <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-721"></a>    moveto x y
<a name="line-722"></a>    lineto x <font color=Cyan>(</font>y<font color=Cyan>+</font>h<font color=Cyan>)</font>
<a name="line-723"></a>    lineto <font color=Cyan>(</font>x<font color=Cyan>+</font>w<font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>+</font>h<font color=Cyan>)</font>
<a name="line-724"></a>    lineto <font color=Cyan>(</font>x<font color=Cyan>+</font>w<font color=Cyan>)</font> y
<a name="line-725"></a>    closepath
<a name="line-726"></a>  alt <font color=Red>=</font> <font color=Red>[</font>
<a name="line-727"></a>    custom_pdf <font color=Cyan>$</font> printf <font color=Magenta>"%f %f %f %f re\n"</font> x y w h<font color=Cyan>,</font>
<a name="line-728"></a>    custom_ascii <font color=Cyan>$</font> printf <font color=Magenta>"Rectangle %f %f %f %f\n"</font> x y w h
<a name="line-729"></a>    <font color=Red>]</font>
<a name="line-730"></a>
<a name="line-731"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-732"></a><font color=Blue><i>-- * Customization</i></font>
<a name="line-733"></a>
<a name="line-734"></a><font color=Blue><i>-- $CUSTOMIZATION</i></font>
<a name="line-735"></a><font color=Blue><i>-- </i></font>
<a name="line-736"></a><font color=Blue><i>-- The document and drawing abstractions provided by this module are</i></font>
<a name="line-737"></a><font color=Blue><i>-- purposely kept general-purpose, and do not include</i></font>
<a name="line-738"></a><font color=Blue><i>-- application-specific features. However, we provide a mechanism by</i></font>
<a name="line-739"></a><font color=Blue><i>-- which applications can provide customized drawing commands and</i></font>
<a name="line-740"></a><font color=Blue><i>-- other custom features.</i></font>
<a name="line-741"></a>
<a name="line-742"></a><font color=Blue><i>-- ** Custom drawing commands</i></font>
<a name="line-743"></a>
<a name="line-744"></a><font color=Blue><i>-- $CUSTOMCOMMANDS</i></font>
<a name="line-745"></a><font color=Blue><i>-- </i></font>
<a name="line-746"></a><font color=Blue><i>-- It is sometimes useful to use customized drawing commands. For</i></font>
<a name="line-747"></a><font color=Blue><i>-- example, an application that draws many rectangles might like to</i></font>
<a name="line-748"></a><font color=Blue><i>-- define a custom 'rectangle' function for appending a rectangle to</i></font>
<a name="line-749"></a><font color=Blue><i>-- the current path. Of course this can be defined as an ordinary</i></font>
<a name="line-750"></a><font color=Blue><i>-- Haskell function, using elementary drawing commands:</i></font>
<a name="line-751"></a><font color=Blue><i>-- </i></font>
<a name="line-752"></a><font color=Blue><i>-- &gt; my_rect :: X -&gt; Y -&gt; X -&gt; Y -&gt; Draw ()</i></font>
<a name="line-753"></a><font color=Blue><i>-- &gt; my_rect x0 y0 x1 y1 = do</i></font>
<a name="line-754"></a><font color=Blue><i>-- &gt;   moveto x0 y0</i></font>
<a name="line-755"></a><font color=Blue><i>-- &gt;   lineto x0 y1</i></font>
<a name="line-756"></a><font color=Blue><i>-- &gt;   lineto x1 y1</i></font>
<a name="line-757"></a><font color=Blue><i>-- &gt;   lineto x1 y0</i></font>
<a name="line-758"></a><font color=Blue><i>-- &gt;   closepath</i></font>
<a name="line-759"></a><font color=Blue><i>-- </i></font>
<a name="line-760"></a><font color=Blue><i>-- However, sometimes it is nice to make use of specialized abilities</i></font>
<a name="line-761"></a><font color=Blue><i>-- of individual backends. For example, PDF already has a built-in</i></font>
<a name="line-762"></a><font color=Blue><i>-- rectangle drawing command, and PostScript has the ability to define</i></font>
<a name="line-763"></a><font color=Blue><i>-- custom subroutines within the document text. Using these features</i></font>
<a name="line-764"></a><font color=Blue><i>-- can decrease the size of the generated documents. </i></font>
<a name="line-765"></a><font color=Blue><i>-- </i></font>
<a name="line-766"></a><font color=Blue><i>-- We therefore provide a facility for defining new drawing commands</i></font>
<a name="line-767"></a><font color=Blue><i>-- with backend-specific implementations. For example, a more general</i></font>
<a name="line-768"></a><font color=Blue><i>-- version of the above 'my_rect' function can be defined as</i></font>
<a name="line-769"></a><font color=Blue><i>-- follows:</i></font>
<a name="line-770"></a><font color=Blue><i>-- </i></font>
<a name="line-771"></a><font color=Blue><i>-- &gt; my_rect :: X -&gt; Y -&gt; X -&gt; Y -&gt; Draw ()</i></font>
<a name="line-772"></a><font color=Blue><i>-- &gt; my_rect x0 y0 x1 y1 = draw_subroutine alt $ do</i></font>
<a name="line-773"></a><font color=Blue><i>-- &gt;   moveto x0 y0</i></font>
<a name="line-774"></a><font color=Blue><i>-- &gt;   lineto x0 y1</i></font>
<a name="line-775"></a><font color=Blue><i>-- &gt;   lineto x1 y1</i></font>
<a name="line-776"></a><font color=Blue><i>-- &gt;   lineto x1 y0</i></font>
<a name="line-777"></a><font color=Blue><i>-- &gt;   closepath</i></font>
<a name="line-778"></a><font color=Blue><i>-- &gt;  where</i></font>
<a name="line-779"></a><font color=Blue><i>-- &gt;   alt = [</i></font>
<a name="line-780"></a><font color=Blue><i>-- &gt;     custom_ps $      printf "%f %f %f %f rect\n" x0 y0 x1 y1,</i></font>
<a name="line-781"></a><font color=Blue><i>-- &gt;     custom_pdf $     printf "%f %f %f %f re\n" x0 y0 (x1-x0) (y1-y0),</i></font>
<a name="line-782"></a><font color=Blue><i>-- &gt;     custom_ascii $   printf "My_rect %f %f %f %f\n" x0 y0 x1 y1</i></font>
<a name="line-783"></a><font color=Blue><i>-- &gt;     ]</i></font>
<a name="line-784"></a><font color=Blue><i>-- </i></font>
<a name="line-785"></a><font color=Blue><i>-- The idea is to provide a default definition in terms of primitive</i></font>
<a name="line-786"></a><font color=Blue><i>-- drawing commands, as well as a list of various backend specific</i></font>
<a name="line-787"></a><font color=Blue><i>-- definitions. In the case of PostScript subroutines, the PostScript</i></font>
<a name="line-788"></a><font color=Blue><i>-- file must then also be supplied with a definition for the /rect/</i></font>
<a name="line-789"></a><font color=Blue><i>-- subroutine, which can be done with the command 'render_ps_custom':</i></font>
<a name="line-790"></a><font color=Blue><i>-- </i></font>
<a name="line-791"></a><font color=Blue><i>-- &gt; my_ps_defs = "/rect { ... } bind def\n"</i></font>
<a name="line-792"></a><font color=Blue><i>-- &gt;</i></font>
<a name="line-793"></a><font color=Blue><i>-- &gt; my_render_ps = render_ps_custom custom { ps_defs = my_ps_defs }</i></font>
<a name="line-794"></a><font color=Blue><i>-- </i></font>
<a name="line-795"></a><font color=Blue><i>-- Note that the 'draw_subroutine' customization mechanism is entirely</i></font>
<a name="line-796"></a><font color=Blue><i>-- optional. Its purpose is to generate shorter output for some</i></font>
<a name="line-797"></a><font color=Blue><i>-- backends; if it is omitted, the file may be be longer but should</i></font>
<a name="line-798"></a><font color=Blue><i>-- look the same.</i></font>
<a name="line-799"></a>
<a name="line-800"></a><a name="Language"></a><font color=Blue><i>-- | An enumeration of backend languages, for the purpose of defining</i></font>
<a name="line-801"></a><a name="Language"></a><font color=Blue><i>-- custom drawing commands. Note that several backends (e.g. EPS and</i></font>
<a name="line-802"></a><a name="Language"></a><font color=Blue><i>-- PostScript) may share the same language, and therefore they are</i></font>
<a name="line-803"></a><a name="Language"></a><font color=Blue><i>-- only represented once in this enumeration.</i></font>
<a name="line-804"></a><a name="Language"></a><font color=Green><u>data</u></font> Language <font color=Red>=</font>
<a name="line-805"></a>  Language_PS      <font color=Blue><i>-- ^ PostScript (including EPS)</i></font>
<a name="line-806"></a>  <font color=Red>|</font> Language_PDF   <font color=Blue><i>-- ^ PDF</i></font>
<a name="line-807"></a>  <font color=Red>|</font> Language_ASCII <font color=Blue><i>-- ^ ASCII (for debugging)</i></font>
<a name="line-808"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Eq<font color=Cyan>,</font> Ord<font color=Cyan>)</font>
<a name="line-809"></a>
<a name="line-810"></a><a name="CustomDef"></a><font color=Blue><i>-- | The type of custom definitions, to be used with the</i></font>
<a name="line-811"></a><a name="CustomDef"></a><font color=Blue><i>-- 'draw_subroutine' command.</i></font>
<a name="line-812"></a><a name="CustomDef"></a><font color=Green><u>data</u></font> CustomDef <font color=Red>=</font> CustomDef Language String
<a name="line-813"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>)</font>
<a name="line-814"></a>
<a name="line-815"></a><a name="custom_ps"></a><font color=Blue><i>-- | Define a custom PostScript definition.</i></font>
<a name="line-816"></a><font color=Blue>custom_ps</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> CustomDef
<a name="line-817"></a><font color=Blue>custom_ps</font> s <font color=Red>=</font> CustomDef Language_PS s
<a name="line-818"></a>
<a name="line-819"></a><a name="custom_pdf"></a><font color=Blue><i>-- | Define a custom PDF definition.</i></font>
<a name="line-820"></a><font color=Blue>custom_pdf</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> CustomDef
<a name="line-821"></a><font color=Blue>custom_pdf</font> s <font color=Red>=</font> CustomDef Language_PDF s
<a name="line-822"></a>
<a name="line-823"></a><a name="custom_ascii"></a><font color=Blue><i>-- | Define a custom ASCII definition.</i></font>
<a name="line-824"></a><font color=Blue>custom_ascii</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> CustomDef
<a name="line-825"></a><font color=Blue>custom_ascii</font> s <font color=Red>=</font> CustomDef Language_ASCII s
<a name="line-826"></a>
<a name="line-827"></a><a name="custom_lookup"></a><font color=Blue><i>-- | Look up an element in a list of 'CustomDef's.</i></font>
<a name="line-828"></a><font color=Blue>custom_lookup</font> <font color=Red>::</font> Language <font color=Red>-&gt;</font> <font color=Red>[</font>CustomDef<font color=Red>]</font> <font color=Red>-&gt;</font> Maybe String
<a name="line-829"></a><font color=Blue>custom_lookup</font> lang defs <font color=Red>=</font> 
<a name="line-830"></a>  <font color=Green><u>case</u></font> find <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>CustomDef l <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>-&gt;</font> l<font color=Cyan>==</font>lang<font color=Cyan>)</font> defs <font color=Green><u>of</u></font>
<a name="line-831"></a>    Nothing <font color=Red>-&gt;</font> Nothing
<a name="line-832"></a>    Just <font color=Cyan>(</font>CustomDef l s<font color=Cyan>)</font> <font color=Red>-&gt;</font> Just s
<a name="line-833"></a>
<a name="line-834"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-835"></a><font color=Blue><i>-- ** Customization interface</i></font>
<a name="line-836"></a>
<a name="line-837"></a><a name="Custom"></a><font color=Blue><i>-- | A data structure that holds application-specific meta-data and</i></font>
<a name="line-838"></a><a name="Custom"></a><font color=Blue><i>-- customization information.</i></font>
<a name="line-839"></a><a name="Custom"></a><font color=Green><u>data</u></font> Custom <font color=Red>=</font> Custom <font color=Cyan>{</font> 
<a name="line-840"></a>  creator <font color=Red>::</font> String<font color=Cyan>,</font> <font color=Blue><i>-- ^ Name of the software that created the file.</i></font>
<a name="line-841"></a>                     <font color=Blue><i>-- Example: \"MyApp 1.0\". Note: this is intended</i></font>
<a name="line-842"></a>                     <font color=Blue><i>-- to hold the name of the software, not the</i></font>
<a name="line-843"></a>                     <font color=Blue><i>-- human user, that created the document.</i></font>
<a name="line-844"></a>  ps_defs <font color=Red>::</font> String  <font color=Blue><i>-- ^ Definitions to go in the PostScript</i></font>
<a name="line-845"></a>                     <font color=Blue><i>-- preamble.</i></font>
<a name="line-846"></a>  <font color=Cyan>}</font>
<a name="line-847"></a>              
<a name="line-848"></a><a name="custom"></a><font color=Blue><i>-- | An empty customization structure. Customizations should be</i></font>
<a name="line-849"></a><font color=Blue><i>-- specified by modifying 'custom', for example:</i></font>
<a name="line-850"></a><font color=Blue><i>-- </i></font>
<a name="line-851"></a><font color=Blue><i>-- &gt; custom { creator = "MyApp 1.0" }</i></font>
<a name="line-852"></a><font color=Blue>custom</font> <font color=Red>::</font> Custom
<a name="line-853"></a><font color=Blue>custom</font> <font color=Red>=</font> Custom <font color=Cyan>{</font>
<a name="line-854"></a>  creator <font color=Red>=</font> <font color=Magenta>""</font><font color=Cyan>,</font>
<a name="line-855"></a>  ps_defs <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-856"></a>  <font color=Cyan>}</font>
<a name="line-857"></a>
<a name="line-858"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-859"></a><font color=Blue><i>-- * Generic string output</i></font>
<a name="line-860"></a>
<a name="line-861"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-862"></a><font color=Blue><i>-- ** The WriterMonad class</i></font>
<a name="line-863"></a>
<a name="line-864"></a><a name="WriterMonad"></a><font color=Blue><i>-- | A 'WriterMonad' is any monad that one can output strings to.</i></font>
<a name="line-865"></a><a name="WriterMonad"></a><font color=Blue><i>-- </i></font>
<a name="line-866"></a><a name="WriterMonad"></a><font color=Blue><i>-- Minimal complete definition: 'wPutChar' or 'wPutStr'.</i></font>
<a name="line-867"></a><a name="WriterMonad"></a><font color=Green><u>class</u></font> Monad m <font color=Red>=&gt;</font> WriterMonad m <font color=Green><u>where</u></font>
<a name="line-868"></a>  <font color=Blue><i>-- | Write a character.</i></font>
<a name="line-869"></a>  wPutChar <font color=Red>::</font> Char <font color=Red>-&gt;</font> m ()
<a name="line-870"></a>  wPutChar c <font color=Red>=</font> wPutStr <font color=Red>[</font>c<font color=Red>]</font>
<a name="line-871"></a>  
<a name="line-872"></a>  <font color=Blue><i>-- | Write a string.</i></font>
<a name="line-873"></a>  wPutStr <font color=Red>::</font> String <font color=Red>-&gt;</font> m ()
<a name="line-874"></a>  wPutStr s <font color=Red>=</font> sequence_ <font color=Red>[</font> wPutChar c <font color=Red>|</font> c <font color=Red>&lt;-</font> s <font color=Red>]</font>
<a name="line-875"></a>  
<a name="line-876"></a><a name="wPutStrLn"></a><font color=Blue><i>-- | Like 'wPutStr', but adds a newline character.</i></font>
<a name="line-877"></a><font color=Blue>wPutStrLn</font> <font color=Red>::</font> <font color=Cyan>(</font>WriterMonad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> String <font color=Red>-&gt;</font> m ()
<a name="line-878"></a><font color=Blue>wPutStrLn</font> s <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-879"></a>  wPutStr s
<a name="line-880"></a>  wPutChar <font color=Magenta>'\n'</font>
<a name="line-881"></a>  
<a name="line-882"></a><a name="wprint"></a><font color=Blue><i>-- | Write a value of any printable type, and add a newline.</i></font>
<a name="line-883"></a><font color=Blue>wprint</font> <font color=Red>::</font> <font color=Cyan>(</font>WriterMonad m<font color=Cyan>,</font> Show a<font color=Cyan>)</font> <font color=Red>=&gt;</font> a <font color=Red>-&gt;</font> m ()
<a name="line-884"></a><font color=Blue>wprint</font> x <font color=Red>=</font> wPutStrLn <font color=Cyan>(</font>show x<font color=Cyan>)</font>
<a name="line-885"></a>    
<a name="line-886"></a><font color=Green><u>instance</u></font> WriterMonad IO <font color=Green><u>where</u></font>
<a name="line-887"></a>  wPutChar <font color=Red>=</font> putChar
<a name="line-888"></a>  wPutStr <font color=Red>=</font> putStr
<a name="line-889"></a>
<a name="line-890"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-891"></a><font color=Blue><i>-- ** The Writer monad</i></font>
<a name="line-892"></a>
<a name="line-893"></a><a name="Writer"></a><font color=Blue><i>-- | A generic 'WriterMonad'.</i></font>
<a name="line-894"></a><a name="Writer"></a><font color=Green><u>data</u></font> Writer a <font color=Red>=</font>
<a name="line-895"></a>  Writer_Return a                    <font color=Blue><i>-- ^ Terminate with a result.</i></font>
<a name="line-896"></a>  <font color=Red>|</font> Writer_PutChar Char <font color=Cyan>(</font>Writer a<font color=Cyan>)</font>   <font color=Blue><i>-- ^ Write a character.</i></font>
<a name="line-897"></a>  <font color=Red>|</font> Writer_PutStr String <font color=Cyan>(</font>Writer a<font color=Cyan>)</font>  <font color=Blue><i>-- ^ Write a string.</i></font>
<a name="line-898"></a>
<a name="line-899"></a><font color=Green><u>instance</u></font> Monad Writer <font color=Green><u>where</u></font>
<a name="line-900"></a>  return a <font color=Red>=</font> Writer_Return a
<a name="line-901"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> <font color=Green><u>case</u></font> f <font color=Green><u>of</u></font>
<a name="line-902"></a>    Writer_Return a <font color=Red>-&gt;</font> g a
<a name="line-903"></a>    Writer_PutChar c f' <font color=Red>-&gt;</font> Writer_PutChar c <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font>
<a name="line-904"></a>    Writer_PutStr s f' <font color=Red>-&gt;</font> Writer_PutStr s <font color=Cyan>(</font>f' <font color=Cyan>&gt;&gt;=</font> g<font color=Cyan>)</font> 
<a name="line-905"></a>    
<a name="line-906"></a><font color=Green><u>instance</u></font> WriterMonad Writer <font color=Green><u>where</u></font>
<a name="line-907"></a>  wPutChar c <font color=Red>=</font> Writer_PutChar c <font color=Cyan>(</font>Writer_Return ()<font color=Cyan>)</font>
<a name="line-908"></a>  wPutStr s <font color=Red>=</font> Writer_PutStr s <font color=Cyan>(</font>Writer_Return ()<font color=Cyan>)</font>
<a name="line-909"></a>  
<a name="line-910"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-911"></a><font color=Blue><i>-- ** Isomorphism with (String, a)</i></font>
<a name="line-912"></a>  
<a name="line-913"></a><a name="writer_to_pair"></a><font color=Blue><i>-- | Isomorphically map a 'Writer' computation to a pair of a string</i></font>
<a name="line-914"></a><font color=Blue><i>-- and a value.</i></font>
<a name="line-915"></a><font color=Blue><i>-- </i></font>
<a name="line-916"></a><font color=Blue><i>-- Important usage note: the 'String' in the output is produced</i></font>
<a name="line-917"></a><font color=Blue><i>-- lazily, and before /a/ is produced. To preserve laziness, do not</i></font>
<a name="line-918"></a><font color=Blue><i>-- evaluate /a/ before the end of 'String' has been reached.</i></font>
<a name="line-919"></a><font color=Blue>writer_to_pair</font> <font color=Red>::</font> Writer a <font color=Red>-&gt;</font> <font color=Cyan>(</font>String<font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-920"></a><font color=Blue>writer_to_pair</font> <font color=Cyan>(</font>Writer_Return a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Magenta>""</font><font color=Cyan>,</font> a<font color=Cyan>)</font>
<a name="line-921"></a><font color=Blue>writer_to_pair</font> <font color=Cyan>(</font>Writer_PutChar c cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>c<font color=Red><b>:</b></font>t<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-922"></a>  <font color=Cyan>(</font>t<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> writer_to_pair cont
<a name="line-923"></a><font color=Blue>writer_to_pair</font> <font color=Cyan>(</font>Writer_PutStr s cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>s <font color=Cyan>++</font> t<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-924"></a>  <font color=Cyan>(</font>t<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> writer_to_pair cont
<a name="line-925"></a>
<a name="line-926"></a><a name="pair_to_writer"></a><font color=Blue><i>-- | The inverse of 'writer_to_pair'.</i></font>
<a name="line-927"></a><font color=Blue>pair_to_writer</font> <font color=Red>::</font> <font color=Cyan>(</font>String<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>-&gt;</font> Writer a
<a name="line-928"></a><font color=Blue>pair_to_writer</font> <font color=Cyan>(</font>s<font color=Cyan>,</font> a<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-929"></a>  wPutStr s
<a name="line-930"></a>  return a
<a name="line-931"></a>
<a name="line-932"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-933"></a><font color=Blue><i>-- ** Run functions</i></font>
<a name="line-934"></a>
<a name="line-935"></a><a name="run_writer"></a><font color=Blue><i>-- | Run a 'Writer' computation in any 'WriterMonad'.</i></font>
<a name="line-936"></a><font color=Blue>run_writer</font> <font color=Red>::</font> <font color=Cyan>(</font>WriterMonad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> Writer a <font color=Red>-&gt;</font> m a
<a name="line-937"></a><font color=Blue>run_writer</font> <font color=Cyan>(</font>Writer_Return a<font color=Cyan>)</font> <font color=Red>=</font> return a
<a name="line-938"></a><font color=Blue>run_writer</font> <font color=Cyan>(</font>Writer_PutChar c cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-939"></a>  wPutChar c
<a name="line-940"></a>  run_writer cont
<a name="line-941"></a><font color=Blue>run_writer</font> <font color=Cyan>(</font>Writer_PutStr s cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-942"></a>  wPutStr s
<a name="line-943"></a>  run_writer cont
<a name="line-944"></a>
<a name="line-945"></a><a name="writer_to_file"></a><font color=Blue><i>-- | Run a writer in the 'IO' monad by printing to a file.</i></font>
<a name="line-946"></a><font color=Blue>writer_to_file</font> <font color=Red>::</font> Handle <font color=Red>-&gt;</font> Writer a <font color=Red>-&gt;</font> IO a
<a name="line-947"></a><font color=Blue>writer_to_file</font> h <font color=Cyan>(</font>Writer_Return a<font color=Cyan>)</font> <font color=Red>=</font> return a
<a name="line-948"></a><font color=Blue>writer_to_file</font> h <font color=Cyan>(</font>Writer_PutChar c cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-949"></a>  hPutChar h c
<a name="line-950"></a>  writer_to_file h cont
<a name="line-951"></a><font color=Blue>writer_to_file</font> h <font color=Cyan>(</font>Writer_PutStr s cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-952"></a>  hPutStr h s
<a name="line-953"></a>  writer_to_file h cont
<a name="line-954"></a>
<a name="line-955"></a><a name="writer_to_string"></a><font color=Blue><i>-- | Run a writer by printing to a string.</i></font>
<a name="line-956"></a><font color=Blue>writer_to_string</font> <font color=Red>::</font> Writer a <font color=Red>-&gt;</font> String
<a name="line-957"></a><font color=Blue>writer_to_string</font> <font color=Red>=</font> fst <font color=Cyan>.</font> writer_to_pair
<a name="line-958"></a>
<a name="line-959"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-960"></a><font color=Blue><i>-- ** Boxed monads</i></font>
<a name="line-961"></a>
<a name="line-962"></a><a name="Boxed"></a><font color=Blue><i>-- | Create an identical \"boxed\" copy of a type constructor. This is</i></font>
<a name="line-963"></a><a name="Boxed"></a><font color=Blue><i>-- used for technical reasons, to allow the 'wprintf' operation to be</i></font>
<a name="line-964"></a><a name="Boxed"></a><font color=Blue><i>-- typed.</i></font>
<a name="line-965"></a><a name="Boxed"></a><font color=Green><u>newtype</u></font> Boxed m a <font color=Red>=</font> Boxed <font color=Cyan>(</font>m a<font color=Cyan>)</font>
<a name="line-966"></a>
<a name="line-967"></a><a name="unbox"></a><font color=Blue><i>-- | Unbox a boxed item.</i></font>
<a name="line-968"></a><font color=Blue>unbox</font> <font color=Red>::</font> Boxed m a <font color=Red>-&gt;</font> m a
<a name="line-969"></a><font color=Blue>unbox</font> <font color=Cyan>(</font>Boxed x<font color=Cyan>)</font> <font color=Red>=</font> x
<a name="line-970"></a>
<a name="line-971"></a><font color=Green><u>instance</u></font> Monad m <font color=Red>=&gt;</font> Monad <font color=Cyan>(</font>Boxed m<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-972"></a>  return a <font color=Red>=</font> Boxed <font color=Cyan>(</font>return a<font color=Cyan>)</font>
<a name="line-973"></a>  f <font color=Cyan>&gt;&gt;=</font> g <font color=Red>=</font> Boxed <font color=Cyan>(</font>unbox f <font color=Cyan>&gt;&gt;=</font> <font color=Cyan>(</font>unbox <font color=Cyan>.</font> g<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-974"></a>
<a name="line-975"></a><font color=Green><u>instance</u></font> WriterMonad m <font color=Red>=&gt;</font> WriterMonad <font color=Cyan>(</font>Boxed m<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-976"></a>  wPutChar c <font color=Red>=</font> Boxed <font color=Cyan>(</font>wPutChar c<font color=Cyan>)</font>
<a name="line-977"></a>  wPutStr c <font color=Red>=</font> Boxed <font color=Cyan>(</font>wPutStr c<font color=Cyan>)</font>
<a name="line-978"></a>
<a name="line-979"></a><font color=Green><u>instance</u></font> MonadState s m <font color=Red>=&gt;</font> MonadState s <font color=Cyan>(</font>Boxed m<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-980"></a>  get <font color=Red>=</font> Boxed get
<a name="line-981"></a>  put s <font color=Red>=</font> Boxed <font color=Cyan>(</font>put s<font color=Cyan>)</font>
<a name="line-982"></a>
<a name="line-983"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-984"></a><font color=Blue><i>-- ** Currying in a boxed monad</i></font>
<a name="line-985"></a>  
<a name="line-986"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- | A class to curry/uncurry functions in any boxed monad. This</i></font>
<a name="line-987"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- establishes an isomorphism</i></font>
<a name="line-988"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- </i></font>
<a name="line-989"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- &gt; @fun  &#8773;  args -&gt; Boxed m res,@</i></font>
<a name="line-990"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- </i></font>
<a name="line-991"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- where</i></font>
<a name="line-992"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- </i></font>
<a name="line-993"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- &gt; fun = a1 -&gt; a2 -&gt; ... -&gt; an -&gt; Boxed m res,</i></font>
<a name="line-994"></a><a name="Boxed_Curry"></a><font color=Blue><i>-- &gt; args = (a1, (a2, (..., (an, ())))).</i></font>
<a name="line-995"></a><a name="Boxed_Curry"></a><font color=Green><u>class</u></font> Boxed_Curry fun args m res <font color=Red>|</font> fun <font color=Red>-&gt;</font> args res m<font color=Cyan>,</font> args res m <font color=Red>-&gt;</font> fun <font color=Green><u>where</u></font>
<a name="line-996"></a>  boxed_curry <font color=Red>::</font> <font color=Cyan>(</font>args <font color=Red>-&gt;</font> Boxed m res<font color=Cyan>)</font> <font color=Red>-&gt;</font> fun
<a name="line-997"></a>  boxed_uncurry <font color=Red>::</font> fun <font color=Red>-&gt;</font> <font color=Cyan>(</font>args <font color=Red>-&gt;</font> Boxed m res<font color=Cyan>)</font>
<a name="line-998"></a>
<a name="line-999"></a><font color=Green><u>instance</u></font> Boxed_Curry <font color=Cyan>(</font>Boxed m a<font color=Cyan>)</font> () m a <font color=Green><u>where</u></font>
<a name="line-1000"></a>  boxed_curry g <font color=Red>=</font> g ()
<a name="line-1001"></a>  boxed_uncurry x <font color=Red>=</font> const x
<a name="line-1002"></a>  
<a name="line-1003"></a><font color=Green><u>instance</u></font> Boxed_Curry fun args m res <font color=Red>=&gt;</font> Boxed_Curry <font color=Cyan>(</font>a <font color=Red>-&gt;</font> fun<font color=Cyan>)</font> <font color=Cyan>(</font>a<font color=Cyan>,</font> args<font color=Cyan>)</font> m res <font color=Green><u>where</u></font>
<a name="line-1004"></a>  boxed_curry g x <font color=Red>=</font> boxed_curry <font color=Cyan>(</font><font color=Red>\</font>xs <font color=Red>-&gt;</font> g <font color=Cyan>(</font>x<font color=Cyan>,</font>xs<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1005"></a>  boxed_uncurry f <font color=Cyan>(</font>x<font color=Cyan>,</font>xs<font color=Cyan>)</font> <font color=Red>=</font> boxed_uncurry <font color=Cyan>(</font>f x<font color=Cyan>)</font> xs
<a name="line-1006"></a>
<a name="line-1007"></a><font color=Blue><i>-- ----------------------------------------------------------------------  </i></font>
<a name="line-1008"></a><font color=Blue><i>-- ** Formatted printing</i></font>
<a name="line-1009"></a>  
<a name="line-1010"></a><a name="wprintf"></a><font color=Blue><i>-- | Print a formatted value in the context of a boxed WriterMonad. Usage:</i></font>
<a name="line-1011"></a><font color=Blue><i>-- </i></font>
<a name="line-1012"></a><font color=Blue><i>-- wprintf "%f %f" x y :: Boxed Writer</i></font>
<a name="line-1013"></a><font color=Blue>wprintf</font> <font color=Red>::</font> <font color=Cyan>(</font>Boxed_Curry fun args m ()<font color=Cyan>,</font> WriterMonad m<font color=Cyan>,</font> Curry fun' args String<font color=Cyan>,</font> PrintfType fun'<font color=Cyan>)</font> <font color=Red>=&gt;</font> String <font color=Red>-&gt;</font> fun
<a name="line-1014"></a><font color=Blue>wprintf</font> fmt <font color=Red>=</font> g <font color=Green><u>where</u></font>
<a name="line-1015"></a>  g <font color=Red>=</font> boxed_curry g'
<a name="line-1016"></a>  g' args <font color=Red>=</font> wPutStr <font color=Cyan>(</font>f' args<font color=Cyan>)</font>
<a name="line-1017"></a>  f' <font color=Red>=</font> muncurry f
<a name="line-1018"></a>  f <font color=Red>=</font> printf fmt
<a name="line-1019"></a>
<a name="line-1020"></a><a name="with_printf"></a><font color=Blue><i>-- | In any 'WriterMonad', introduce a block in which 'wprintf' can be</i></font>
<a name="line-1021"></a><font color=Blue><i>-- used. This has no computational overhead, i.e., is compiled to the</i></font>
<a name="line-1022"></a><font color=Blue><i>-- identity operation; it exists only to please the type system,</i></font>
<a name="line-1023"></a><font color=Blue><i>-- due to the fancy typing of 'wprintf'.</i></font>
<a name="line-1024"></a><font color=Blue>with_printf</font> <font color=Red>::</font> <font color=Cyan>(</font>WriterMonad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> Boxed m a <font color=Red>-&gt;</font> m a
<a name="line-1025"></a><font color=Blue>with_printf</font> <font color=Red>=</font> unbox
<a name="line-1026"></a>
<a name="line-1027"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1028"></a><font color=Blue><i>-- ** Filters</i></font>
<a name="line-1029"></a>
<a name="line-1030"></a><font color=Blue><i>-- $ A filter is any function from strings to strings, but it should</i></font>
<a name="line-1031"></a><font color=Blue><i>-- usually be lazy. Typical examples are compression, encryption,</i></font>
<a name="line-1032"></a><font color=Blue><i>-- ASCII armoring, character encoding, and their inverses.</i></font>
<a name="line-1033"></a><font color=Blue><i>-- </i></font>
<a name="line-1034"></a><font color=Blue><i>-- We provide a convenient operator for temporarily wrapping a filter</i></font>
<a name="line-1035"></a><font color=Blue><i>-- around the 'Writer' monad, as well as specific filters.</i></font>
<a name="line-1036"></a>
<a name="line-1037"></a><a name="with_filter"></a><font color=Blue><i>-- | Wrap a filter around a 'Writer' computation. This introduces a</i></font>
<a name="line-1038"></a><font color=Blue><i>-- local block within the 'Writer' monad; all text written within the</i></font>
<a name="line-1039"></a><font color=Blue><i>-- block is encoded through the given filter. Filters can be composed</i></font>
<a name="line-1040"></a><font color=Blue><i>-- and nested.</i></font>
<a name="line-1041"></a><font color=Blue>with_filter</font> <font color=Red>::</font> <font color=Cyan>(</font>WriterMonad m<font color=Cyan>)</font> <font color=Red>=&gt;</font> <font color=Cyan>(</font>String <font color=Red>-&gt;</font> String<font color=Cyan>)</font> <font color=Red>-&gt;</font> Writer a <font color=Red>-&gt;</font> m a
<a name="line-1042"></a><font color=Blue>with_filter</font> encoding <font color=Red>=</font> run_writer <font color=Cyan>.</font> pair_to_writer <font color=Cyan>.</font> <font color=Cyan>(</font><font color=Red>\</font><font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>encoding x<font color=Cyan>,</font> y<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Cyan>.</font> writer_to_pair
<a name="line-1043"></a>
<a name="line-1044"></a><a name="flate_filter"></a><font color=Blue><i>-- | A filter for performing \"flate\" (also known as \"zlib\")</i></font>
<a name="line-1045"></a><font color=Blue><i>-- compression. </i></font>
<a name="line-1046"></a><font color=Blue><i>-- </i></font>
<a name="line-1047"></a><font color=Blue><i>-- Note: both the input and output strings are regarded as sequences</i></font>
<a name="line-1048"></a><font color=Blue><i>-- of bytes, not characters. Any characters outside the byte range are</i></font>
<a name="line-1049"></a><font color=Blue><i>-- truncated to 8 bits.</i></font>
<a name="line-1050"></a><font color=Blue>flate_filter</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-1051"></a><font color=Blue>flate_filter</font> <font color=Red>=</font> map chr <font color=Cyan>.</font> map fromIntegral <font color=Cyan>.</font> ByteString<font color=Cyan>.</font>unpack <font color=Cyan>.</font> compress <font color=Cyan>.</font> ByteString<font color=Cyan>.</font>pack <font color=Cyan>.</font> map fromIntegral <font color=Cyan>.</font> map ord
<a name="line-1052"></a>
<a name="line-1053"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1054"></a><font color=Blue><i>-- * Backends</i></font>
<a name="line-1055"></a>
<a name="line-1056"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1057"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-1058"></a>
<a name="line-1059"></a><a name="ensure_nl"></a><font color=Blue><i>-- | Ensure that the last line of the string ends in a newline</i></font>
<a name="line-1060"></a><font color=Blue><i>-- character, adding one if necessary. An empty string is considered to contain zero lines, so no newline character needs to be added. </i></font>
<a name="line-1061"></a><font color=Blue>ensure_nl</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-1062"></a><font color=Blue>ensure_nl</font> <font color=Magenta>""</font> <font color=Red>=</font> <font color=Magenta>""</font>
<a name="line-1063"></a><font color=Blue>ensure_nl</font> s <font color=Red>=</font> 
<a name="line-1064"></a>  <font color=Green><u>if</u></font> last s <font color=Cyan>==</font> <font color=Magenta>'\n'</font> <font color=Green><u>then</u></font> s <font color=Green><u>else</u></font> s<font color=Cyan>++</font><font color=Magenta>"\n"</font>
<a name="line-1065"></a>
<a name="line-1066"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1067"></a><font color=Blue><i>-- * ASCII output</i></font>
<a name="line-1068"></a>
<a name="line-1069"></a><a name="draw_to_ascii"></a><font color=Blue><i>-- | Render draw actions as ASCII.</i></font>
<a name="line-1070"></a><font color=Blue>draw_to_ascii</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> Writer a
<a name="line-1071"></a><font color=Blue>draw_to_ascii</font> <font color=Cyan>(</font>Draw_Return x<font color=Cyan>)</font> <font color=Red>=</font> return x
<a name="line-1072"></a><font color=Blue>draw_to_ascii</font> <font color=Cyan>(</font>Draw_Write cmd cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1073"></a>  command_to_ascii cmd
<a name="line-1074"></a>  draw_to_ascii cont
<a name="line-1075"></a><font color=Blue>draw_to_ascii</font> <font color=Cyan>(</font>Draw_Block f<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1076"></a>  wPutStrLn <font color=Magenta>"begin"</font>
<a name="line-1077"></a>  cont <font color=Red>&lt;-</font> draw_to_ascii f
<a name="line-1078"></a>  wPutStrLn <font color=Magenta>"end"</font>
<a name="line-1079"></a>  draw_to_ascii cont
<a name="line-1080"></a>  
<a name="line-1081"></a><a name="command_to_ascii"></a><font color=Blue><i>-- | Render drawing commands as ASCII.</i></font>
<a name="line-1082"></a><font color=Blue>command_to_ascii</font> <font color=Red>::</font> DrawCommand <font color=Red>-&gt;</font> Writer ()
<a name="line-1083"></a><font color=Blue>command_to_ascii</font> <font color=Cyan>(</font>Subroutine draw alt<font color=Cyan>)</font> <font color=Red>=</font>
<a name="line-1084"></a>  <font color=Green><u>case</u></font> custom_lookup Language_ASCII alt <font color=Green><u>of</u></font>
<a name="line-1085"></a>    Just out <font color=Red>-&gt;</font> wPutStr <font color=Cyan>(</font>ensure_nl out<font color=Cyan>)</font>
<a name="line-1086"></a>    Nothing <font color=Red>-&gt;</font> draw_to_ascii draw
<a name="line-1087"></a><font color=Blue>command_to_ascii</font> cmd <font color=Red>=</font>
<a name="line-1088"></a>  wprint cmd
<a name="line-1089"></a>
<a name="line-1090"></a><a name="document_to_ascii"></a><font color=Blue><i>-- | Render a document as ASCII.</i></font>
<a name="line-1091"></a><font color=Blue>document_to_ascii</font> <font color=Red>::</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1092"></a><font color=Blue>document_to_ascii</font> <font color=Cyan>(</font>Document_Return x<font color=Cyan>)</font> <font color=Red>=</font> return x
<a name="line-1093"></a><font color=Blue>document_to_ascii</font> <font color=Cyan>(</font>Document_Page x y draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1094"></a>  wPutStrLn <font color=Cyan>$</font> <font color=Magenta>"startpage "</font> <font color=Cyan>++</font> show x <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> show y
<a name="line-1095"></a>  cont <font color=Red>&lt;-</font> draw_to_ascii draw
<a name="line-1096"></a>  wPutStrLn <font color=Magenta>"endpage"</font>
<a name="line-1097"></a>  document_to_ascii cont
<a name="line-1098"></a><font color=Blue>document_to_ascii</font> <font color=Cyan>(</font>Document_Page_defer draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1099"></a>  wPutStrLn <font color=Magenta>"startpage (atend)"</font>
<a name="line-1100"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> cont<font color=Cyan>)</font> <font color=Red>&lt;-</font> draw_to_ascii draw
<a name="line-1101"></a>  wPutStrLn <font color=Cyan>$</font> <font color=Magenta>"endpage "</font> <font color=Cyan>++</font> show x <font color=Cyan>++</font> <font color=Magenta>" "</font> <font color=Cyan>++</font> show y
<a name="line-1102"></a>  document_to_ascii cont
<a name="line-1103"></a>  
<a name="line-1104"></a><a name="render_ascii"></a><font color=Blue><i>-- | Render a document as ASCII. This is for debugging purposes only.</i></font>
<a name="line-1105"></a><font color=Blue><i>-- The output is a sequence of drawing commands, rather than a</i></font>
<a name="line-1106"></a><font color=Blue><i>-- graphical representation.</i></font>
<a name="line-1107"></a><font color=Blue>render_ascii</font> <font color=Red>::</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1108"></a><font color=Blue>render_ascii</font> <font color=Red>=</font> document_to_ascii
<a name="line-1109"></a>
<a name="line-1110"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1111"></a><font color=Blue><i>-- * PostScript output</i></font>
<a name="line-1112"></a>  
<a name="line-1113"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1114"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-1115"></a>
<a name="line-1116"></a><a name="ps_escape"></a><font color=Blue><i>-- | Escape special characters in a string literal.</i></font>
<a name="line-1117"></a><font color=Blue>ps_escape</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-1118"></a><font color=Blue>ps_escape</font> [] <font color=Red>=</font> []
<a name="line-1119"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> ps_escape t
<a name="line-1120"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>'('</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'('</font>  <font color=Red><b>:</b></font> ps_escape t
<a name="line-1121"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font><font color=Magenta>')'</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>')'</font>  <font color=Red><b>:</b></font> ps_escape t
<a name="line-1122"></a><font color=Blue>ps_escape</font> <font color=Cyan>(</font>h <font color=Red><b>:</b></font> t<font color=Cyan>)</font>    <font color=Red>=</font> h <font color=Red><b>:</b></font> ps_escape t
<a name="line-1123"></a>
<a name="line-1124"></a><a name="remove_nl"></a><font color=Blue><i>-- | Remove newline characters in a string.</i></font>
<a name="line-1125"></a><font color=Blue>remove_nl</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-1126"></a><font color=Blue>remove_nl</font> <font color=Red>=</font> map f <font color=Green><u>where</u></font>
<a name="line-1127"></a>  f <font color=Magenta>'\n'</font> <font color=Red>=</font> <font color=Magenta>' '</font>
<a name="line-1128"></a>  f <font color=Magenta>'\r'</font> <font color=Red>=</font> <font color=Magenta>' '</font>
<a name="line-1129"></a>  f x <font color=Red>=</font> x
<a name="line-1130"></a>
<a name="line-1131"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1132"></a><font color=Blue><i>-- ** The PSWriter monad</i></font>
<a name="line-1133"></a>
<a name="line-1134"></a><font color=Blue><i>-- $ For convenience, we wrap the 'Writer' monad in a custom state monad;</i></font>
<a name="line-1135"></a><font color=Blue><i>-- the latter keeps track of the current document bounding box (i.e.,</i></font>
<a name="line-1136"></a><font color=Blue><i>-- the smallest bounding box containing all pages) and the current</i></font>
<a name="line-1137"></a><font color=Blue><i>-- number of pages.</i></font>
<a name="line-1138"></a>
<a name="line-1139"></a><a name="Page"></a><font color=Blue><i>-- | The type of page numbers.</i></font>
<a name="line-1140"></a><a name="Page"></a><font color=Green><u>type</u></font> Page <font color=Red>=</font> Integer
<a name="line-1141"></a>
<a name="line-1142"></a><a name="PS_State"></a><font color=Blue><i>-- | A state to keep track of a current bounding box and page number.</i></font>
<a name="line-1143"></a><a name="PS_State"></a><font color=Green><u>data</u></font> PS_State <font color=Red>=</font> PS_State <font color=Cyan>!</font>X <font color=Cyan>!</font>Y <font color=Cyan>!</font>Page
<a name="line-1144"></a>
<a name="line-1145"></a><a name="ps_state_empty"></a><font color=Blue><i>-- | The initial 'PS_State'.</i></font>
<a name="line-1146"></a><font color=Blue>ps_state_empty</font> <font color=Red>::</font> PS_State
<a name="line-1147"></a><font color=Blue>ps_state_empty</font> <font color=Red>=</font> PS_State <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font> 
<a name="line-1148"></a>
<a name="line-1149"></a><a name="PSWriter"></a><font color=Blue><i>-- | The 'PSWriter' monad. This is just a 'PS_State' wrapped around</i></font>
<a name="line-1150"></a><a name="PSWriter"></a><font color=Blue><i>-- the 'Writer' monad.</i></font>
<a name="line-1151"></a><a name="PSWriter"></a><font color=Green><u>type</u></font> PSWriter <font color=Red>=</font> Boxed <font color=Cyan>(</font>StateT PS_State Writer<font color=Cyan>)</font>
<a name="line-1152"></a>
<a name="line-1153"></a><font color=Green><u>instance</u></font> WriterMonad <font color=Cyan>(</font>StateT PS_State Writer<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-1154"></a>  wPutChar c <font color=Red>=</font> lift <font color=Cyan>(</font>wPutChar c<font color=Cyan>)</font>
<a name="line-1155"></a>  wPutStr s <font color=Red>=</font> lift <font color=Cyan>(</font>wPutStr s<font color=Cyan>)</font>
<a name="line-1156"></a>
<a name="line-1157"></a><a name="pswriter_run"></a><font color=Blue><i>-- | Run function for the 'PSWriter' monad.</i></font>
<a name="line-1158"></a><font color=Blue>pswriter_run</font> <font color=Red>::</font> PSWriter a <font color=Red>-&gt;</font> Writer a
<a name="line-1159"></a><font color=Blue>pswriter_run</font> f <font color=Red>=</font> evalStateT <font color=Cyan>(</font>unbox f<font color=Cyan>)</font> ps_state_empty
<a name="line-1160"></a>
<a name="line-1161"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1162"></a><font color=Blue><i>-- *** Access functions for the PSWriter monad</i></font>
<a name="line-1163"></a>
<a name="line-1164"></a><a name="ps_get_bbox"></a><font color=Blue><i>-- | Get the bounding box.</i></font>
<a name="line-1165"></a><font color=Blue>ps_get_bbox</font> <font color=Red>::</font> PSWriter <font color=Cyan>(</font>X<font color=Cyan>,</font> Y<font color=Cyan>)</font>
<a name="line-1166"></a><font color=Blue>ps_get_bbox</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1167"></a>  PS_State x y <font color=Green><u>_</u></font> <font color=Red>&lt;-</font> get
<a name="line-1168"></a>  return <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>)</font>
<a name="line-1169"></a>  
<a name="line-1170"></a><a name="ps_add_bbox"></a><font color=Blue><i>-- | Add to the bounding box.</i></font>
<a name="line-1171"></a><font color=Blue>ps_add_bbox</font> <font color=Red>::</font> X <font color=Red>-&gt;</font> Y <font color=Red>-&gt;</font> PSWriter ()
<a name="line-1172"></a><font color=Blue>ps_add_bbox</font> x y <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1173"></a>  PS_State x' y' p <font color=Red>&lt;-</font> get
<a name="line-1174"></a>  put <font color=Cyan>(</font>PS_State <font color=Cyan>(</font>x <font color=Cyan>`max`</font> x'<font color=Cyan>)</font> <font color=Cyan>(</font>y <font color=Cyan>`max`</font> y'<font color=Cyan>)</font> p<font color=Cyan>)</font>
<a name="line-1175"></a>
<a name="line-1176"></a><a name="ps_get_pagecount"></a><font color=Blue><i>-- | Get the page count.</i></font>
<a name="line-1177"></a><font color=Blue>ps_get_pagecount</font> <font color=Red>::</font> PSWriter Page
<a name="line-1178"></a><font color=Blue>ps_get_pagecount</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1179"></a>  PS_State <font color=Green><u>_</u></font> <font color=Green><u>_</u></font> p <font color=Red>&lt;-</font> get
<a name="line-1180"></a>  return p
<a name="line-1181"></a>  
<a name="line-1182"></a><a name="ps_next_page"></a><font color=Blue><i>-- | Return the next page number.</i></font>
<a name="line-1183"></a><font color=Blue>ps_next_page</font> <font color=Red>::</font> PSWriter Page
<a name="line-1184"></a><font color=Blue>ps_next_page</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1185"></a>  PS_State x y p <font color=Red>&lt;-</font> get
<a name="line-1186"></a>  put <font color=Cyan>(</font>PS_State x y <font color=Cyan>(</font>p<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-1187"></a>  return <font color=Cyan>(</font>p<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1188"></a>
<a name="line-1189"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1190"></a><font color=Blue><i>-- ** Internal rendering to the PSWriter monad</i></font>
<a name="line-1191"></a>
<a name="line-1192"></a><a name="draw_to_ps"></a><font color=Blue><i>-- | Render draw actions as PostScript.</i></font>
<a name="line-1193"></a><font color=Blue>draw_to_ps</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> PSWriter a
<a name="line-1194"></a><font color=Blue>draw_to_ps</font> <font color=Cyan>(</font>Draw_Return x<font color=Cyan>)</font> <font color=Red>=</font> return x
<a name="line-1195"></a><font color=Blue>draw_to_ps</font> <font color=Cyan>(</font>Draw_Write cmd cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1196"></a>  command_to_ps cmd
<a name="line-1197"></a>  draw_to_ps cont
<a name="line-1198"></a><font color=Blue>draw_to_ps</font> <font color=Cyan>(</font>Draw_Block body<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1199"></a>  wPutStrLn <font color=Magenta>"gsave"</font>
<a name="line-1200"></a>  cont <font color=Red>&lt;-</font> draw_to_ps body
<a name="line-1201"></a>  wPutStrLn <font color=Magenta>"grestore"</font>
<a name="line-1202"></a>  draw_to_ps cont
<a name="line-1203"></a>  
<a name="line-1204"></a><a name="color_to_ps"></a><font color=Blue><i>-- | Set the color.</i></font>
<a name="line-1205"></a><font color=Blue>color_to_ps</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> PSWriter ()
<a name="line-1206"></a><font color=Blue>color_to_ps</font> <font color=Cyan>(</font>Color_RGB r g b<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1207"></a>  wprintf <font color=Magenta>"%f %f %f setrgbcolor\n"</font> r g b
<a name="line-1208"></a><font color=Blue>color_to_ps</font> <font color=Cyan>(</font>Color_Gray v<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1209"></a>  wprintf <font color=Magenta>"%f setgray\n"</font> v
<a name="line-1210"></a>
<a name="line-1211"></a><a name="font_to_ps"></a><font color=Blue><i>-- | Set the font.</i></font>
<a name="line-1212"></a><font color=Blue>font_to_ps</font> <font color=Red>::</font> Font <font color=Red>-&gt;</font> PSWriter ()
<a name="line-1213"></a><font color=Blue>font_to_ps</font> <font color=Cyan>(</font>Font TimesRoman pt<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1214"></a>  wprintf <font color=Magenta>"/Times-Roman findfont %f scalefont setfont\n"</font> pt
<a name="line-1215"></a><font color=Blue>font_to_ps</font> <font color=Cyan>(</font>Font Helvetica pt<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1216"></a>  wprintf <font color=Magenta>"/Helvetica findfont %f scalefont setfont\n"</font> pt
<a name="line-1217"></a>
<a name="line-1218"></a><a name="command_to_ps"></a><font color=Blue><i>-- | Draw a single drawing command to PostScript.</i></font>
<a name="line-1219"></a><font color=Blue>command_to_ps</font> <font color=Red>::</font> DrawCommand <font color=Red>-&gt;</font> PSWriter ()
<a name="line-1220"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Newpath<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1221"></a>  wPutStrLn <font color=Magenta>"newpath"</font>
<a name="line-1222"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Moveto x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1223"></a>  wprintf <font color=Magenta>"%f %f moveto\n"</font> x y
<a name="line-1224"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Lineto x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1225"></a>  wprintf <font color=Magenta>"%f %f lineto\n"</font> x y
<a name="line-1226"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Curveto x1 y1 x2 y2 x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1227"></a>  wprintf <font color=Magenta>"%f %f %f %f %f %f curveto\n"</font> x1 y1 x2 y2 x y
<a name="line-1228"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Closepath<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1229"></a>  wPutStrLn <font color=Magenta>"closepath"</font>
<a name="line-1230"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Stroke<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1231"></a>  wPutStrLn <font color=Magenta>"stroke"</font>
<a name="line-1232"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Fill color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1233"></a>  wPutStrLn <font color=Magenta>"gsave"</font> 
<a name="line-1234"></a>  color_to_ps color
<a name="line-1235"></a>  wPutStrLn <font color=Magenta>"fill"</font> 
<a name="line-1236"></a>  wPutStrLn <font color=Magenta>"grestore"</font>
<a name="line-1237"></a>  wPutStrLn <font color=Magenta>"newpath"</font>
<a name="line-1238"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>FillStroke color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1239"></a>  wPutStrLn <font color=Magenta>"gsave"</font>
<a name="line-1240"></a>  color_to_ps color
<a name="line-1241"></a>  wPutStrLn <font color=Magenta>"fill"</font>
<a name="line-1242"></a>  wPutStrLn <font color=Magenta>"grestore"</font>
<a name="line-1243"></a>  wPutStrLn <font color=Magenta>"stroke"</font>
<a name="line-1244"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>TextBox align font color x0 y0 x1 y1 b s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1245"></a>  wPutStrLn <font color=Magenta>"gsave"</font>
<a name="line-1246"></a>  font_to_ps font
<a name="line-1247"></a>  color_to_ps color
<a name="line-1248"></a>  wprintf <font color=Magenta>"(%s) %f %f %f %f %f %f textbox\n"</font> <font color=Cyan>(</font>ps_escape s<font color=Cyan>)</font> x0 y0 x1 y1 align yshift
<a name="line-1249"></a>  wPutStrLn <font color=Magenta>"grestore"</font>
<a name="line-1250"></a>  <font color=Green><u>where</u></font>
<a name="line-1251"></a>    yshift <font color=Red>=</font> <font color=Blue><i>-</i></font>b <font color=Cyan>*</font> nominalsize font
<a name="line-1252"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>SetLineWidth x<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1253"></a>  wprintf <font color=Magenta>"%f setlinewidth\n"</font> x
<a name="line-1254"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>SetColor color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1255"></a>  color_to_ps color
<a name="line-1256"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Translate x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1257"></a>  wprintf <font color=Magenta>"%f %f translate\n"</font> x y
<a name="line-1258"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Scale x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1259"></a>  wprintf <font color=Magenta>"%f %f scale\n"</font> x y
<a name="line-1260"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Rotate angle<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1261"></a>  wprintf <font color=Magenta>"%f rotate\n"</font> angle
<a name="line-1262"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Comment s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1263"></a>  wprintf <font color=Magenta>"%% %s\n"</font> <font color=Cyan>(</font>remove_nl s<font color=Cyan>)</font>
<a name="line-1264"></a><font color=Blue>command_to_ps</font> <font color=Cyan>(</font>Subroutine draw alt<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1265"></a>  <font color=Green><u>case</u></font> custom_lookup Language_PS alt <font color=Green><u>of</u></font>
<a name="line-1266"></a>    Just out <font color=Red>-&gt;</font> wprintf <font color=Magenta>"%s"</font> <font color=Cyan>(</font>ensure_nl out<font color=Cyan>)</font>
<a name="line-1267"></a>    Nothing <font color=Red>-&gt;</font> draw_to_ps draw
<a name="line-1268"></a>
<a name="line-1269"></a><a name="document_to_ps"></a><font color=Blue><i>-- | Render a document as PostScript.</i></font>
<a name="line-1270"></a><font color=Blue>document_to_ps</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> PSWriter a
<a name="line-1271"></a><font color=Blue>document_to_ps</font> custom document <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1272"></a>  <font color=Blue><i>-- global header</i></font>
<a name="line-1273"></a>  wPutStrLn <font color=Magenta>"%!PS-Adobe-3.0"</font>
<a name="line-1274"></a>  wPutStrLn <font color=Magenta>"%%LanguageLevel: 2"</font>
<a name="line-1275"></a>  when <font color=Cyan>(</font>creator custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1276"></a>    wprintf <font color=Magenta>"%%%%Creator: %s\n"</font> <font color=Cyan>(</font>creator custom<font color=Cyan>)</font>
<a name="line-1277"></a>  wPutStrLn <font color=Magenta>"%%BoundingBox: (atend)"</font>
<a name="line-1278"></a>  wPutStrLn <font color=Magenta>"%%HiResBoundingBox: (atend)"</font>
<a name="line-1279"></a>  wPutStrLn <font color=Magenta>"%%Pages: (atend)"</font>
<a name="line-1280"></a>  wPutStrLn <font color=Magenta>"%%EndComments"</font>
<a name="line-1281"></a>  wPutStrLn <font color=Magenta>"%%BeginSetup"</font>
<a name="line-1282"></a>  wprintf <font color=Magenta>"%s"</font> global_ps_defs
<a name="line-1283"></a>  when <font color=Cyan>(</font>ps_defs custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1284"></a>    wprintf <font color=Magenta>"%s"</font> <font color=Cyan>(</font>ensure_nl <font color=Cyan>$</font> ps_defs custom<font color=Cyan>)</font>
<a name="line-1285"></a>  wPutStrLn <font color=Magenta>"%%EndSetup"</font>
<a name="line-1286"></a>  a <font color=Red>&lt;-</font> pages_to_ps document
<a name="line-1287"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>)</font> <font color=Red>&lt;-</font> ps_get_bbox
<a name="line-1288"></a>  pagecount <font color=Red>&lt;-</font> ps_get_pagecount
<a name="line-1289"></a>  wPutStrLn <font color=Magenta>"%%Trailer"</font>
<a name="line-1290"></a>  wprintf <font color=Magenta>"%%%%BoundingBox: 0 0 %d %d\n"</font> <font color=Cyan>(</font>int_ceiling x<font color=Cyan>)</font> <font color=Cyan>(</font>int_ceiling y<font color=Cyan>)</font>
<a name="line-1291"></a>  wprintf <font color=Magenta>"%%%%HiResBoundingBox: 0 0 %f %f\n"</font> x y
<a name="line-1292"></a>  wprintf <font color=Magenta>"%%%%Pages: %d\n"</font> pagecount
<a name="line-1293"></a>  wPutStrLn <font color=Magenta>"%%EOF"</font>
<a name="line-1294"></a>  return a
<a name="line-1295"></a>
<a name="line-1296"></a><a name="global_ps_defs"></a><font color=Blue><i>-- | Global PostScript definitions used by the rendering engine.</i></font>
<a name="line-1297"></a><font color=Blue>global_ps_defs</font> <font color=Red>::</font> String
<a name="line-1298"></a><font color=Blue>global_ps_defs</font> <font color=Red>=</font> <font color=Magenta>"/textbox { /b exch def /align exch def /y1 exch def /x1 exch def /y0 exch def /x0 exch def /dx x1 x0 sub def /dy y1 y0 sub def /d dx dx mul dy dy mul add sqrt def dup stringwidth pop /w exch def /fontscale w d le {d} {w} ifelse def gsave [dx dy dy neg dx x0 y0] concat 1 fontscale div dup scale fontscale w sub align mul b moveto show grestore } bind def\n"</font>
<a name="line-1299"></a>        
<a name="line-1300"></a><a name="pages_to_ps"></a><font color=Blue><i>-- | Render pages as PostScript.</i></font>
<a name="line-1301"></a><font color=Blue>pages_to_ps</font> <font color=Red>::</font> Document a <font color=Red>-&gt;</font> PSWriter a
<a name="line-1302"></a><font color=Blue>pages_to_ps</font> <font color=Cyan>(</font>Document_Return a<font color=Cyan>)</font> <font color=Red>=</font> return a
<a name="line-1303"></a><font color=Blue>pages_to_ps</font> <font color=Cyan>(</font>Document_Page x y draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1304"></a>  page <font color=Red>&lt;-</font> ps_next_page
<a name="line-1305"></a>  ps_add_bbox x y
<a name="line-1306"></a>  wprintf <font color=Magenta>"%%%%Page: %d %d\n"</font> page page
<a name="line-1307"></a>  wprintf <font color=Magenta>"%%%%PageBoundingBox: 0 0 %d %d\n"</font> <font color=Cyan>(</font>int_ceiling x<font color=Cyan>)</font> <font color=Cyan>(</font>int_ceiling y<font color=Cyan>)</font>
<a name="line-1308"></a>  wprintf <font color=Magenta>"%%%%PageHiResBoundingBox: 0 0 %f %f\n"</font> x y
<a name="line-1309"></a>  wPutStrLn <font color=Magenta>"save"</font>
<a name="line-1310"></a>  cont <font color=Red>&lt;-</font> draw_to_ps draw
<a name="line-1311"></a>  wPutStrLn <font color=Magenta>"showpage"</font>
<a name="line-1312"></a>  wPutStrLn <font color=Magenta>"restore"</font>
<a name="line-1313"></a>  pages_to_ps cont
<a name="line-1314"></a><font color=Blue>pages_to_ps</font> <font color=Cyan>(</font>Document_Page_defer draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1315"></a>  page <font color=Red>&lt;-</font> ps_next_page
<a name="line-1316"></a>  wprintf <font color=Magenta>"%%%%Page: %d %d\n"</font> page page
<a name="line-1317"></a>  wPutStrLn <font color=Magenta>"%%PageBoundingBox: (atend)"</font>
<a name="line-1318"></a>  wPutStrLn <font color=Magenta>"%%PageHiResBoundingBox: (atend)"</font>
<a name="line-1319"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> cont<font color=Cyan>)</font> <font color=Red>&lt;-</font> draw_to_ps draw
<a name="line-1320"></a>  wPutStrLn <font color=Magenta>"showpage"</font>
<a name="line-1321"></a>  wPutStrLn <font color=Magenta>"%%PageTrailer"</font>
<a name="line-1322"></a>  wprintf <font color=Magenta>"%%%%PageBoundingBox: 0 0 %d %d\n"</font> <font color=Cyan>(</font>int_ceiling x<font color=Cyan>)</font> <font color=Cyan>(</font>int_ceiling y<font color=Cyan>)</font>
<a name="line-1323"></a>  wprintf <font color=Magenta>"%%%%PageHiResBoundingBox: 0 0 %f %f\n"</font> x y
<a name="line-1324"></a>  ps_add_bbox x y
<a name="line-1325"></a>  pages_to_ps cont
<a name="line-1326"></a>
<a name="line-1327"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1328"></a><font color=Blue><i>-- ** Rendering to the Writer monad</i></font>
<a name="line-1329"></a>
<a name="line-1330"></a><a name="render_ps_custom"></a><font color=Blue><i>-- | Render document as PostScript. The first argument is a</i></font>
<a name="line-1331"></a><font color=Blue><i>-- customization data structure.</i></font>
<a name="line-1332"></a><font color=Blue>render_ps_custom</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1333"></a><font color=Blue>render_ps_custom</font> custom doc <font color=Red>=</font> 
<a name="line-1334"></a>  pswriter_run <font color=Cyan>(</font>document_to_ps custom doc<font color=Cyan>)</font>
<a name="line-1335"></a>
<a name="line-1336"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1337"></a><font color=Blue><i>-- * EPS output</i></font>
<a name="line-1338"></a>
<a name="line-1339"></a><font color=Blue><i>-- $ Encapsulated PostScript (EPS) output is slightly different from</i></font>
<a name="line-1340"></a><font color=Blue><i>-- normal PostScript output. EPS is limited to a single page, and</i></font>
<a name="line-1341"></a><font color=Blue><i>-- contains no \"showpage\" command. We permit the user to print a</i></font>
<a name="line-1342"></a><font color=Blue><i>-- single page from a multi-page document, by specifying the page</i></font>
<a name="line-1343"></a><font color=Blue><i>-- number.</i></font>
<a name="line-1344"></a>
<a name="line-1345"></a><a name="document_to_eps"></a><font color=Blue><i>-- | Render a document as EPS. Since EPS only permits a single page of</i></font>
<a name="line-1346"></a><font color=Blue><i>-- output, the 'Page' parameter is used to specify which page (of a</i></font>
<a name="line-1347"></a><font color=Blue><i>-- potential multi-page document) should be printed. An error will be</i></font>
<a name="line-1348"></a><font color=Blue><i>-- thrown if the page number was out of range.</i></font>
<a name="line-1349"></a><font color=Blue><i>-- </i></font>
<a name="line-1350"></a><font color=Blue><i>-- Note: if the return value is not used, the remaining pages are</i></font>
<a name="line-1351"></a><font color=Blue><i>-- lazily skipped.</i></font>
<a name="line-1352"></a><font color=Blue>document_to_eps</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Page <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> PSWriter a
<a name="line-1353"></a><font color=Blue>document_to_eps</font> custom page <font color=Cyan>(</font>Document_Return a<font color=Cyan>)</font> <font color=Red>=</font> 
<a name="line-1354"></a>  error <font color=Magenta>"document_to_eps: requested page does not exist"</font>
<a name="line-1355"></a><font color=Blue>document_to_eps</font> custom page <font color=Cyan>(</font>Document_Page x y draw<font color=Cyan>)</font>  
<a name="line-1356"></a>  <font color=Red>|</font> page <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1357"></a>      <font color=Blue><i>-- EPS header</i></font>
<a name="line-1358"></a>      wPutStrLn <font color=Magenta>"%!PS-Adobe-3.0 EPSF-3.0"</font>
<a name="line-1359"></a>      wPutStrLn <font color=Magenta>"%%LanguageLevel: 2"</font>
<a name="line-1360"></a>      when <font color=Cyan>(</font>creator custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1361"></a>        wprintf <font color=Magenta>"%%%%Creator: %s\n"</font> <font color=Cyan>(</font>creator custom<font color=Cyan>)</font>
<a name="line-1362"></a>      wprintf <font color=Magenta>"%%%%BoundingBox: 0 0 %d %d\n"</font> <font color=Cyan>(</font>int_ceiling x<font color=Cyan>)</font> <font color=Cyan>(</font>int_ceiling y<font color=Cyan>)</font>
<a name="line-1363"></a>      wprintf <font color=Magenta>"%%%%HiResBoundingBox: 0 0 %f %f\n"</font> x y
<a name="line-1364"></a>      wPutStrLn <font color=Magenta>"%%Pages: 1"</font>
<a name="line-1365"></a>      wPutStrLn <font color=Magenta>"%%EndComments"</font>
<a name="line-1366"></a>      wPutStrLn <font color=Magenta>"%%Page: 1 1"</font>
<a name="line-1367"></a>      wPutStrLn <font color=Magenta>"save"</font>
<a name="line-1368"></a>      wprintf <font color=Magenta>"%s"</font> global_ps_defs
<a name="line-1369"></a>      when <font color=Cyan>(</font>ps_defs custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1370"></a>        wprintf <font color=Magenta>"%s"</font> <font color=Cyan>(</font>ensure_nl <font color=Cyan>$</font> ps_defs custom<font color=Cyan>)</font>
<a name="line-1371"></a>      cont <font color=Red>&lt;-</font> draw_to_ps draw
<a name="line-1372"></a>      wPutStrLn <font color=Magenta>"restore"</font>
<a name="line-1373"></a>      wPutStrLn <font color=Magenta>"%%EOF"</font>
<a name="line-1374"></a>      <font color=Green><u>let</u></font> a <font color=Red>=</font> document_skip cont
<a name="line-1375"></a>      return a
<a name="line-1376"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1377"></a>      <font color=Green><u>let</u></font> cont <font color=Red>=</font> draw_skip draw
<a name="line-1378"></a>      document_to_eps custom <font color=Cyan>(</font>page<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> cont
<a name="line-1379"></a><font color=Blue>document_to_eps</font> custom page <font color=Cyan>(</font>Document_Page_defer draw<font color=Cyan>)</font>  
<a name="line-1380"></a>  <font color=Red>|</font> page <font color=Cyan>==</font> <font color=Magenta>1</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1381"></a>      <font color=Blue><i>-- EPS header</i></font>
<a name="line-1382"></a>      wPutStrLn <font color=Magenta>"%!PS-Adobe-3.0 EPSF-3.0"</font>
<a name="line-1383"></a>      wPutStrLn <font color=Magenta>"%%LanguageLevel: 2"</font>
<a name="line-1384"></a>      when <font color=Cyan>(</font>creator custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1385"></a>        wprintf <font color=Magenta>"%%%%Creator: %s\n"</font> <font color=Cyan>(</font>creator custom<font color=Cyan>)</font>
<a name="line-1386"></a>      wPutStrLn <font color=Magenta>"%%BoundingBox: (atend)"</font>
<a name="line-1387"></a>      wPutStrLn <font color=Magenta>"%%HiResBoundingBox: (atend)"</font>
<a name="line-1388"></a>      wPutStrLn <font color=Magenta>"%%Pages: 1"</font>
<a name="line-1389"></a>      wPutStrLn <font color=Magenta>"%%EndComments"</font>
<a name="line-1390"></a>      wPutStrLn <font color=Magenta>"%%Page: 1 1"</font>
<a name="line-1391"></a>      wPutStrLn <font color=Magenta>"save"</font>
<a name="line-1392"></a>      wprintf <font color=Magenta>"%s"</font> global_ps_defs
<a name="line-1393"></a>      when <font color=Cyan>(</font>ps_defs custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1394"></a>        wprintf <font color=Magenta>"%s"</font> <font color=Cyan>(</font>ensure_nl <font color=Cyan>$</font> ps_defs custom<font color=Cyan>)</font>
<a name="line-1395"></a>      <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> cont<font color=Cyan>)</font> <font color=Red>&lt;-</font> draw_to_ps draw
<a name="line-1396"></a>      wPutStrLn <font color=Magenta>"restore"</font>
<a name="line-1397"></a>      wPutStrLn <font color=Magenta>"%%Trailer"</font>
<a name="line-1398"></a>      wprintf <font color=Magenta>"%%%%BoundingBox: 0 0 %d %d\n"</font> <font color=Cyan>(</font>int_ceiling x<font color=Cyan>)</font> <font color=Cyan>(</font>int_ceiling y<font color=Cyan>)</font>
<a name="line-1399"></a>      wprintf <font color=Magenta>"%%%%HiResBoundingBox: 0 0 %f %f\n"</font> x y
<a name="line-1400"></a>      wPutStrLn <font color=Magenta>"%%EOF"</font>
<a name="line-1401"></a>      <font color=Green><u>let</u></font> a <font color=Red>=</font> document_skip cont
<a name="line-1402"></a>      return a
<a name="line-1403"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1404"></a>      <font color=Green><u>let</u></font> <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>,</font> cont<font color=Cyan>)</font> <font color=Red>=</font> draw_skip draw
<a name="line-1405"></a>      document_to_eps custom <font color=Cyan>(</font>page<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> cont
<a name="line-1406"></a>        
<a name="line-1407"></a><a name="render_eps_custom"></a><font color=Blue><i>-- | Render document as EPS. The first argument is a customization</i></font>
<a name="line-1408"></a><font color=Blue><i>-- data structure, and the second argument is the number of the page</i></font>
<a name="line-1409"></a><font color=Blue><i>-- to extract from the document.</i></font>
<a name="line-1410"></a><font color=Blue>render_eps_custom</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Page <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1411"></a><font color=Blue>render_eps_custom</font> custom page doc <font color=Red>=</font> 
<a name="line-1412"></a>  pswriter_run <font color=Cyan>(</font>document_to_eps custom page doc<font color=Cyan>)</font>
<a name="line-1413"></a>
<a name="line-1414"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1415"></a><font color=Blue><i>-- * PDF output</i></font>
<a name="line-1416"></a>
<a name="line-1417"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1418"></a><font color=Blue><i>-- ** Auxiliary functions</i></font>
<a name="line-1419"></a>
<a name="line-1420"></a><a name="pdf_escape"></a><font color=Blue><i>-- | Escape special characters in a string literal.</i></font>
<a name="line-1421"></a><font color=Blue>pdf_escape</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> String
<a name="line-1422"></a><font color=Blue>pdf_escape</font> [] <font color=Red>=</font> []
<a name="line-1423"></a><font color=Blue>pdf_escape</font> <font color=Cyan>(</font><font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> pdf_escape t
<a name="line-1424"></a><font color=Blue>pdf_escape</font> <font color=Cyan>(</font><font color=Magenta>'('</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>'('</font>  <font color=Red><b>:</b></font> pdf_escape t
<a name="line-1425"></a><font color=Blue>pdf_escape</font> <font color=Cyan>(</font><font color=Magenta>')'</font>  <font color=Red><b>:</b></font> t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Magenta>'\\'</font> <font color=Red><b>:</b></font> <font color=Magenta>')'</font>  <font color=Red><b>:</b></font> pdf_escape t
<a name="line-1426"></a><font color=Blue>pdf_escape</font> <font color=Cyan>(</font>h <font color=Red><b>:</b></font> t<font color=Cyan>)</font>    <font color=Red>=</font> h <font color=Red><b>:</b></font> pdf_escape t
<a name="line-1427"></a>
<a name="line-1428"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1429"></a><font color=Blue><i>-- ** The PDF state</i></font>
<a name="line-1430"></a>
<a name="line-1431"></a><font color=Blue><i>-- $ Creating PDF files requires some state: we need to keep track of</i></font>
<a name="line-1432"></a><font color=Blue><i>-- the current file position, page numbering, and object numbering. </i></font>
<a name="line-1433"></a>
<a name="line-1434"></a><a name="Filepos"></a><font color=Blue><i>-- | A position in a file. The first byte is 0.</i></font>
<a name="line-1435"></a><a name="Filepos"></a><font color=Green><u>type</u></font> Filepos <font color=Red>=</font> Integer
<a name="line-1436"></a>
<a name="line-1437"></a><a name="Object"></a><font color=Blue><i>-- | A PDF object reference.</i></font>
<a name="line-1438"></a><a name="Object"></a><font color=Green><u>type</u></font> Object <font color=Red>=</font> Integer
<a name="line-1439"></a>
<a name="line-1440"></a><a name="PDF_State"></a><font color=Blue><i>-- | A state to keep track of PDF document structure: current</i></font>
<a name="line-1441"></a><a name="PDF_State"></a><font color=Blue><i>-- character count, current TOC, current page, etc.</i></font>
<a name="line-1442"></a><a name="PDF_State"></a><font color=Green><u>data</u></font> PDF_State <font color=Red>=</font> PDF_State <font color=Cyan>{</font>
<a name="line-1443"></a>  pdf_filepos <font color=Red>::</font> <font color=Cyan>!</font>Filepos<font color=Cyan>,</font>              <font color=Blue><i>-- ^ Current position in file.</i></font>
<a name="line-1444"></a>  pdf_obj <font color=Red>::</font> <font color=Cyan>!</font>Object<font color=Cyan>,</font>                   <font color=Blue><i>-- ^ Object count.</i></font>
<a name="line-1445"></a>  pdf_xref <font color=Red>::</font> <font color=Cyan>!</font><font color=Cyan>(</font>Map Object Filepos<font color=Cyan>)</font><font color=Cyan>,</font>    <font color=Blue><i>-- ^ Cross-reference table.</i></font>
<a name="line-1446"></a>  pdf_page <font color=Red>::</font> <font color=Cyan>!</font>Page<font color=Cyan>,</font>                    <font color=Blue><i>-- ^ Next available page number.</i></font>
<a name="line-1447"></a>  pdf_pagetable <font color=Red>::</font> <font color=Cyan>!</font><font color=Cyan>(</font>Map Page Object<font color=Cyan>)</font><font color=Cyan>,</font>  <font color=Blue><i>-- ^ Page table.</i></font>
<a name="line-1448"></a>  pdf_font <font color=Red>::</font> <font color=Cyan>!</font>Integer<font color=Cyan>,</font>                 <font color=Blue><i>-- ^ Next available font number.</i></font>
<a name="line-1449"></a>  pdf_fonttable <font color=Red>::</font> <font color=Cyan>!</font><font color=Cyan>(</font>Map String String<font color=Cyan>)</font> <font color=Blue><i>-- ^ Font table mapping each font's PostScript name to a local name.</i></font>
<a name="line-1450"></a>  <font color=Cyan>}</font>
<a name="line-1451"></a>                 
<a name="line-1452"></a><a name="pdf_state_empty"></a><font color=Blue><i>-- | The initial 'PDF_State'.</i></font>
<a name="line-1453"></a><font color=Blue>pdf_state_empty</font> <font color=Red>::</font> PDF_State
<a name="line-1454"></a><font color=Blue>pdf_state_empty</font> <font color=Red>=</font> PDF_State <font color=Cyan>{</font>
<a name="line-1455"></a>  pdf_filepos <font color=Red>=</font> <font color=Magenta>0</font><font color=Cyan>,</font>
<a name="line-1456"></a>  pdf_obj <font color=Red>=</font> <font color=Magenta>0</font><font color=Cyan>,</font>
<a name="line-1457"></a>  pdf_xref <font color=Red>=</font> Map<font color=Cyan>.</font>empty<font color=Cyan>,</font>
<a name="line-1458"></a>  pdf_page <font color=Red>=</font> <font color=Magenta>0</font><font color=Cyan>,</font>
<a name="line-1459"></a>  pdf_pagetable <font color=Red>=</font> Map<font color=Cyan>.</font>empty<font color=Cyan>,</font>
<a name="line-1460"></a>  pdf_font <font color=Red>=</font> <font color=Magenta>0</font><font color=Cyan>,</font>
<a name="line-1461"></a>  pdf_fonttable <font color=Red>=</font> Map<font color=Cyan>.</font>empty
<a name="line-1462"></a>  <font color=Cyan>}</font>
<a name="line-1463"></a>
<a name="line-1464"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1465"></a><font color=Blue><i>-- ** The PDFWriter monad</i></font>
<a name="line-1466"></a>
<a name="line-1467"></a><a name="RawPDFWriter"></a><font color=Blue><i>-- | The 'RawPDFWriter' monad is just a 'PDF_State' wrapped around</i></font>
<a name="line-1468"></a><a name="RawPDFWriter"></a><font color=Blue><i>-- the 'Writer' monad. Its 'wPutChar' and 'wPutStr' methods</i></font>
<a name="line-1469"></a><a name="RawPDFWriter"></a><font color=Blue><i>-- automatically keep track of the file position.</i></font>
<a name="line-1470"></a><a name="RawPDFWriter"></a><font color=Green><u>type</u></font> RawPDFWriter <font color=Red>=</font> StateT PDF_State Writer
<a name="line-1471"></a>
<a name="line-1472"></a><font color=Green><u>instance</u></font> WriterMonad RawPDFWriter <font color=Green><u>where</u></font>
<a name="line-1473"></a>  wPutChar c <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1474"></a>    lift <font color=Cyan>(</font>wPutChar c<font color=Cyan>)</font>
<a name="line-1475"></a>    pdf_inc_filepos <font color=Magenta>1</font>
<a name="line-1476"></a>  wPutStr s <font color=Red>=</font> <font color=Green><u>do</u></font>                 
<a name="line-1477"></a>    lift <font color=Cyan>(</font>wPutStr s<font color=Cyan>)</font>
<a name="line-1478"></a>    pdf_inc_filepos <font color=Cyan>(</font>toInteger <font color=Cyan>$</font> length s<font color=Cyan>)</font>
<a name="line-1479"></a>
<a name="line-1480"></a><a name="PDFWriter"></a><font color=Blue><i>-- | Boxed version of the 'RawPDFWriter' monad.</i></font>
<a name="line-1481"></a><a name="PDFWriter"></a><font color=Green><u>type</u></font> PDFWriter <font color=Red>=</font> Boxed RawPDFWriter
<a name="line-1482"></a>  
<a name="line-1483"></a><a name="pdfwriter_run"></a><font color=Blue><i>-- | Run function for the 'PDFWriter' monad.</i></font>
<a name="line-1484"></a><font color=Blue>pdfwriter_run</font> <font color=Red>::</font> PDFWriter a <font color=Red>-&gt;</font> Writer a
<a name="line-1485"></a><font color=Blue>pdfwriter_run</font> f <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1486"></a>  evalStateT <font color=Cyan>(</font>unbox f<font color=Cyan>)</font> pdf_state_empty
<a name="line-1487"></a>
<a name="line-1488"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1489"></a><font color=Blue><i>-- *** Access functions for the PDFWriter monad</i></font>
<a name="line-1490"></a>
<a name="line-1491"></a><a name="pdf_get_filepos"></a><font color=Blue><i>-- | Get the file position.</i></font>
<a name="line-1492"></a><font color=Blue>pdf_get_filepos</font> <font color=Red>::</font> PDFWriter Filepos
<a name="line-1493"></a><font color=Blue>pdf_get_filepos</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1494"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1495"></a>  return <font color=Cyan>$</font> pdf_filepos s
<a name="line-1496"></a>
<a name="line-1497"></a><a name="pdf_inc_filepos"></a><font color=Blue><i>-- | Add to the file position.</i></font>
<a name="line-1498"></a><font color=Blue>pdf_inc_filepos</font> <font color=Red>::</font> Integer <font color=Red>-&gt;</font> RawPDFWriter ()
<a name="line-1499"></a><font color=Blue>pdf_inc_filepos</font> n <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1500"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1501"></a>  <font color=Green><u>let</u></font> p <font color=Red>=</font> pdf_filepos s
<a name="line-1502"></a>  put s <font color=Cyan>{</font> pdf_filepos <font color=Red>=</font> p<font color=Cyan>+</font>n <font color=Cyan>}</font>
<a name="line-1503"></a>
<a name="line-1504"></a><a name="pdf_get_objcount"></a><font color=Blue><i>-- | Get the number of allocated objects. Note that objects are</i></font>
<a name="line-1505"></a><font color=Blue><i>-- allocated as 1, 2, ..., /n/; this function returns /n/.</i></font>
<a name="line-1506"></a><font color=Blue>pdf_get_objcount</font> <font color=Red>::</font> PDFWriter Object
<a name="line-1507"></a><font color=Blue>pdf_get_objcount</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1508"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1509"></a>  return <font color=Cyan>$</font> pdf_obj s
<a name="line-1510"></a>  
<a name="line-1511"></a><a name="pdf_next_object"></a><font color=Blue><i>-- | Allocate an unused object identifier.</i></font>
<a name="line-1512"></a><font color=Blue>pdf_next_object</font> <font color=Red>::</font> PDFWriter Object
<a name="line-1513"></a><font color=Blue>pdf_next_object</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1514"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1515"></a>  <font color=Green><u>let</u></font> o <font color=Red>=</font> pdf_obj s
<a name="line-1516"></a>  put s <font color=Cyan>{</font> pdf_obj <font color=Red>=</font> o<font color=Cyan>+</font><font color=Magenta>1</font> <font color=Cyan>}</font>  
<a name="line-1517"></a>  return <font color=Cyan>$</font> o<font color=Cyan>+</font><font color=Magenta>1</font>
<a name="line-1518"></a>  
<a name="line-1519"></a><a name="pdf_add_xref"></a><font color=Blue><i>-- | Add a cross reference to the cross reference table.</i></font>
<a name="line-1520"></a><font color=Blue>pdf_add_xref</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> Filepos <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1521"></a><font color=Blue>pdf_add_xref</font> obj pos <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1522"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1523"></a>  <font color=Green><u>let</u></font> xref <font color=Red>=</font> pdf_xref s
<a name="line-1524"></a>  put s <font color=Cyan>{</font> pdf_xref <font color=Red>=</font> Map<font color=Cyan>.</font>insert obj pos xref <font color=Cyan>}</font>
<a name="line-1525"></a>
<a name="line-1526"></a><a name="pdf_get_xref"></a><font color=Blue><i>-- | Retrieve the cross reference table.</i></font>
<a name="line-1527"></a><font color=Blue>pdf_get_xref</font> <font color=Red>::</font> PDFWriter <font color=Cyan>(</font>Map Object Filepos<font color=Cyan>)</font>
<a name="line-1528"></a><font color=Blue>pdf_get_xref</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1529"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1530"></a>  return <font color=Cyan>$</font> pdf_xref s
<a name="line-1531"></a>
<a name="line-1532"></a><a name="pdf_get_pagecount"></a><font color=Blue><i>-- | Get the page count.</i></font>
<a name="line-1533"></a><font color=Blue>pdf_get_pagecount</font> <font color=Red>::</font> PDFWriter Page
<a name="line-1534"></a><font color=Blue>pdf_get_pagecount</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1535"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1536"></a>  return <font color=Cyan>$</font> pdf_page s
<a name="line-1537"></a>  
<a name="line-1538"></a><a name="pdf_next_page"></a><font color=Blue><i>-- | Return the next page number.</i></font>
<a name="line-1539"></a><font color=Blue>pdf_next_page</font> <font color=Red>::</font> PDFWriter Page
<a name="line-1540"></a><font color=Blue>pdf_next_page</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1541"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1542"></a>  <font color=Green><u>let</u></font> p <font color=Red>=</font> pdf_page s
<a name="line-1543"></a>  put s <font color=Cyan>{</font> pdf_page <font color=Red>=</font> p<font color=Cyan>+</font><font color=Magenta>1</font> <font color=Cyan>}</font>
<a name="line-1544"></a>  return <font color=Cyan>$</font> p<font color=Cyan>+</font><font color=Magenta>1</font>
<a name="line-1545"></a>
<a name="line-1546"></a><a name="pdf_add_pagetable"></a><font color=Blue><i>-- | Add a page to the page table.</i></font>
<a name="line-1547"></a><font color=Blue>pdf_add_pagetable</font> <font color=Red>::</font> Page <font color=Red>-&gt;</font> Object <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1548"></a><font color=Blue>pdf_add_pagetable</font> page obj <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1549"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1550"></a>  <font color=Green><u>let</u></font> pagetable <font color=Red>=</font> pdf_pagetable s
<a name="line-1551"></a>  put s <font color=Cyan>{</font> pdf_pagetable <font color=Red>=</font> Map<font color=Cyan>.</font>insert page obj pagetable <font color=Cyan>}</font>
<a name="line-1552"></a>
<a name="line-1553"></a><a name="pdf_get_pagetable"></a><font color=Blue><i>-- | Retrieve the page table.</i></font>
<a name="line-1554"></a><font color=Blue>pdf_get_pagetable</font> <font color=Red>::</font> PDFWriter <font color=Cyan>(</font>Map Page Object<font color=Cyan>)</font>
<a name="line-1555"></a><font color=Blue>pdf_get_pagetable</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1556"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1557"></a>  return <font color=Cyan>$</font> pdf_pagetable s
<a name="line-1558"></a>
<a name="line-1559"></a><a name="pdf_find_font"></a><font color=Blue><i>-- | Look up the local font identifier for a font.</i></font>
<a name="line-1560"></a><font color=Blue>pdf_find_font</font> <font color=Red>::</font> String <font color=Red>-&gt;</font> PDFWriter String  
<a name="line-1561"></a><font color=Blue>pdf_find_font</font> font <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1562"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1563"></a>  <font color=Green><u>let</u></font> t <font color=Red>=</font> pdf_fonttable s
<a name="line-1564"></a>  <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup font t <font color=Green><u>of</u></font>
<a name="line-1565"></a>    Nothing <font color=Red>-&gt;</font> <font color=Green><u>do</u></font>
<a name="line-1566"></a>      <font color=Green><u>let</u></font> f <font color=Red>=</font> pdf_font s
<a name="line-1567"></a>      <font color=Green><u>let</u></font> fontname <font color=Red>=</font> <font color=Magenta>"F"</font> <font color=Cyan>++</font> show f
<a name="line-1568"></a>      put s <font color=Cyan>{</font> pdf_font <font color=Red>=</font> f<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>,</font> pdf_fonttable <font color=Red>=</font> Map<font color=Cyan>.</font>insert font fontname t <font color=Cyan>}</font>
<a name="line-1569"></a>      return fontname
<a name="line-1570"></a>    Just fontname <font color=Red>-&gt;</font> return fontname
<a name="line-1571"></a>  
<a name="line-1572"></a><a name="pdf_get_fonttable"></a><font color=Blue><i>-- | Retrieve the font table.</i></font>
<a name="line-1573"></a><font color=Blue>pdf_get_fonttable</font> <font color=Red>::</font> PDFWriter <font color=Cyan>(</font>Map String String<font color=Cyan>)</font>
<a name="line-1574"></a><font color=Blue>pdf_get_fonttable</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1575"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1576"></a>  return <font color=Cyan>$</font> pdf_fonttable s
<a name="line-1577"></a>
<a name="line-1578"></a><a name="pdf_clear_fonttable"></a><font color=Blue><i>-- | Clear the font table.</i></font>
<a name="line-1579"></a><font color=Blue>pdf_clear_fonttable</font> <font color=Red>::</font> PDFWriter ()
<a name="line-1580"></a><font color=Blue>pdf_clear_fonttable</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1581"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1582"></a>  put s <font color=Cyan>{</font> pdf_font <font color=Red>=</font> <font color=Magenta>0</font><font color=Cyan>,</font> pdf_fonttable <font color=Red>=</font> Map<font color=Cyan>.</font>empty <font color=Cyan>}</font>
<a name="line-1583"></a>
<a name="line-1584"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1585"></a><font color=Blue><i>-- *** Filters</i></font>
<a name="line-1586"></a>  
<a name="line-1587"></a><a name="with_filter_pdf"></a><font color=Blue><i>-- | A version of 'with_filter' tailored to the 'PDFWriter' monad.</i></font>
<a name="line-1588"></a><font color=Blue><i>-- </i></font>
<a name="line-1589"></a><font color=Blue><i>-- This allows certain global state updates within the local block.</i></font>
<a name="line-1590"></a><font color=Blue><i>-- Specifically, updates to everything except the file position are</i></font>
<a name="line-1591"></a><font color=Blue><i>-- propagated from the inner to the outer block. The outer block's</i></font>
<a name="line-1592"></a><font color=Blue><i>-- file position is updated to reflect the encoded content's</i></font>
<a name="line-1593"></a><font color=Blue><i>-- length. From the inner block's point of view, the file position</i></font>
<a name="line-1594"></a><font color=Blue><i>-- starts from 0.</i></font>
<a name="line-1595"></a><font color=Blue>with_filter_pdf</font> <font color=Red>::</font> <font color=Cyan>(</font>String <font color=Red>-&gt;</font> String<font color=Cyan>)</font> <font color=Red>-&gt;</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1596"></a><font color=Blue>with_filter_pdf</font> encoding body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1597"></a>  s <font color=Red>&lt;-</font> get
<a name="line-1598"></a>  <font color=Green><u>let</u></font> s' <font color=Red>=</font> s <font color=Cyan>{</font> pdf_filepos <font color=Red>=</font> <font color=Magenta>0</font> <font color=Cyan>}</font> <font color=Blue><i>-- pass everything except filepos to the body</i></font>
<a name="line-1599"></a>  <font color=Cyan>(</font>a<font color=Cyan>,</font> s''<font color=Cyan>)</font> <font color=Red>&lt;-</font> with_filter encoding <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1600"></a>    runStateT <font color=Cyan>(</font>unbox body<font color=Cyan>)</font> s'
<a name="line-1601"></a>  pos <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1602"></a>  put s'' <font color=Cyan>{</font> pdf_filepos <font color=Red>=</font> pos <font color=Cyan>}</font> <font color=Blue><i>-- pass everything except filepos from the body</i></font>
<a name="line-1603"></a>  return a
<a name="line-1604"></a>
<a name="line-1605"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1606"></a><font color=Blue><i>-- *** Higher access functions</i></font>
<a name="line-1607"></a>
<a name="line-1608"></a><a name="pdf_deferred_object"></a><font color=Blue><i>-- | Define an indirect PDF object with the given object id, which</i></font>
<a name="line-1609"></a><font color=Blue><i>-- must have previously been uniquely obtained with 'pdf_next_object'.</i></font>
<a name="line-1610"></a><font color=Blue><i>-- </i></font>
<a name="line-1611"></a><font color=Blue><i>-- This can be used to define objects with forward references: first</i></font>
<a name="line-1612"></a><font color=Blue><i>-- obtain an object id, then create references to the object, and</i></font>
<a name="line-1613"></a><font color=Blue><i>-- finally define the object.</i></font>
<a name="line-1614"></a><font color=Blue><i>-- </i></font>
<a name="line-1615"></a><font color=Blue><i>-- It should be used like this:</i></font>
<a name="line-1616"></a><font color=Blue><i>-- </i></font>
<a name="line-1617"></a><font color=Blue><i>-- &gt; obj &lt;- pdf_next_object</i></font>
<a name="line-1618"></a><font color=Blue><i>-- &gt; ...</i></font>
<a name="line-1619"></a><font color=Blue><i>-- &gt; pdf_deferred_object obj $ do</i></font>
<a name="line-1620"></a><font color=Blue><i>-- &gt;   &lt;&lt;object definition&gt;&gt;</i></font>
<a name="line-1621"></a><font color=Blue>pdf_deferred_object</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1622"></a><font color=Blue>pdf_deferred_object</font> obj body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1623"></a>  pos <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1624"></a>  pdf_add_xref obj pos
<a name="line-1625"></a>  wprintf <font color=Magenta>"%d 0 obj\n"</font> obj
<a name="line-1626"></a>  a <font color=Red>&lt;-</font> body
<a name="line-1627"></a>  wprintf <font color=Magenta>"endobj\n"</font>
<a name="line-1628"></a>  return a
<a name="line-1629"></a>
<a name="line-1630"></a><a name="pdf_define_object"></a><font color=Blue><i>-- | Define an indirect PDF object with a newly generated object id.</i></font>
<a name="line-1631"></a><font color=Blue><i>-- Return the object id. This essentially combines 'pdf_next_object'</i></font>
<a name="line-1632"></a><font color=Blue><i>-- and 'pdf_deferred_object' into a single function, and should be</i></font>
<a name="line-1633"></a><font color=Blue><i>-- used like this:</i></font>
<a name="line-1634"></a><font color=Blue><i>-- </i></font>
<a name="line-1635"></a><font color=Blue><i>-- &gt; obj &lt;- pdf_define_object $ do</i></font>
<a name="line-1636"></a><font color=Blue><i>-- &gt;   &lt;&lt;object definition&gt;&gt;</i></font>
<a name="line-1637"></a><font color=Blue>pdf_define_object</font> <font color=Red>::</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter Object
<a name="line-1638"></a><font color=Blue>pdf_define_object</font> body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1639"></a>  obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1640"></a>  pdf_deferred_object obj body
<a name="line-1641"></a>  return obj
<a name="line-1642"></a>
<a name="line-1643"></a><a name="pdf_deferred_stream"></a><font color=Blue><i>-- | Define a PDF stream object with the given object id, which must</i></font>
<a name="line-1644"></a><font color=Blue><i>-- have previously been uniquely obtained with 'pdf_next_object'. It</i></font>
<a name="line-1645"></a><font color=Blue><i>-- should be used like this:</i></font>
<a name="line-1646"></a><font color=Blue><i>-- </i></font>
<a name="line-1647"></a><font color=Blue><i>-- &gt; obj &lt;- pdf_next_object</i></font>
<a name="line-1648"></a><font color=Blue><i>-- &gt; ...</i></font>
<a name="line-1649"></a><font color=Blue><i>-- &gt; pdf_deferred_stream obj $ do</i></font>
<a name="line-1650"></a><font color=Blue><i>-- &gt;   &lt;&lt;stream contents&gt;&gt;</i></font>
<a name="line-1651"></a><font color=Blue>pdf_deferred_stream</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1652"></a><font color=Blue>pdf_deferred_stream</font> obj body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1653"></a>  length_obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1654"></a>  <font color=Cyan>(</font>a<font color=Cyan>,</font> len<font color=Cyan>)</font> <font color=Red>&lt;-</font> pdf_deferred_object obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1655"></a>    wprintf <font color=Magenta>"&lt;&lt;/Length %s&gt;&gt;\n"</font> <font color=Cyan>(</font>objref length_obj<font color=Cyan>)</font>
<a name="line-1656"></a>    wPutStr <font color=Magenta>"stream\n"</font>
<a name="line-1657"></a>    x0 <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1658"></a>    a <font color=Red>&lt;-</font> body
<a name="line-1659"></a>    x1 <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1660"></a>    wPutStr <font color=Magenta>"\n"</font>
<a name="line-1661"></a>    wPutStr <font color=Magenta>"endstream\n"</font>
<a name="line-1662"></a>    return <font color=Cyan>(</font>a<font color=Cyan>,</font> x1<font color=Blue><i>-</i></font>x0<font color=Cyan>)</font>
<a name="line-1663"></a>  pdf_deferred_object length_obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1664"></a>    wprintf <font color=Magenta>"%d\n"</font> len
<a name="line-1665"></a>  return a
<a name="line-1666"></a>
<a name="line-1667"></a><a name="pdf_define_stream"></a><font color=Blue><i>-- | Define a PDF stream object with a newly generated object</i></font>
<a name="line-1668"></a><font color=Blue><i>-- id. Return the object id. This should be used like this:</i></font>
<a name="line-1669"></a><font color=Blue><i>-- </i></font>
<a name="line-1670"></a><font color=Blue><i>-- &gt; obj &lt;- pdf_define_stream $ do</i></font>
<a name="line-1671"></a><font color=Blue><i>-- &gt;   &lt;&lt;stream contents&gt;&gt;</i></font>
<a name="line-1672"></a><font color=Blue>pdf_define_stream</font> <font color=Red>::</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter Object  
<a name="line-1673"></a><font color=Blue>pdf_define_stream</font> body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1674"></a>  obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1675"></a>  pdf_deferred_stream obj body
<a name="line-1676"></a>  return obj
<a name="line-1677"></a>
<a name="line-1678"></a><a name="pdf_deferred_flate_stream"></a><font color=Blue><i>-- | Define a compressed PDF stream object with the given object id,</i></font>
<a name="line-1679"></a><font color=Blue><i>-- which must have previously been uniquely obtained with</i></font>
<a name="line-1680"></a><font color=Blue><i>-- 'pdf_next_object'. It should be used like this:</i></font>
<a name="line-1681"></a><font color=Blue><i>-- </i></font>
<a name="line-1682"></a><font color=Blue><i>-- &gt; obj &lt;- pdf_next_object</i></font>
<a name="line-1683"></a><font color=Blue><i>-- &gt; ...</i></font>
<a name="line-1684"></a><font color=Blue><i>-- &gt; pdf_deferred_flate_stream obj $ do</i></font>
<a name="line-1685"></a><font color=Blue><i>-- &gt;   &lt;&lt;stream contents&gt;&gt;</i></font>
<a name="line-1686"></a><font color=Blue>pdf_deferred_flate_stream</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> PDFWriter a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1687"></a><font color=Blue>pdf_deferred_flate_stream</font> obj body <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1688"></a>  length_obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1689"></a>  <font color=Cyan>(</font>a<font color=Cyan>,</font> len<font color=Cyan>)</font> <font color=Red>&lt;-</font> pdf_deferred_object obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1690"></a>    wprintf <font color=Magenta>"&lt;&lt;/Length %s/Filter/FlateDecode&gt;&gt;\n"</font> <font color=Cyan>(</font>objref length_obj<font color=Cyan>)</font>
<a name="line-1691"></a>    wPutStr <font color=Magenta>"stream\n"</font>
<a name="line-1692"></a>    x0 <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1693"></a>    a <font color=Red>&lt;-</font> with_filter_pdf flate_filter body
<a name="line-1694"></a>    x1 <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1695"></a>    wPutStr <font color=Magenta>"\n"</font>
<a name="line-1696"></a>    wPutStr <font color=Magenta>"endstream\n"</font>
<a name="line-1697"></a>    return <font color=Cyan>(</font>a<font color=Cyan>,</font> x1<font color=Blue><i>-</i></font>x0<font color=Cyan>)</font>
<a name="line-1698"></a>  pdf_deferred_object length_obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1699"></a>    wprintf <font color=Magenta>"%d\n"</font> len
<a name="line-1700"></a>  return a
<a name="line-1701"></a>
<a name="line-1702"></a><a name="objref"></a><font color=Blue><i>-- | Create a direct object from a reference to an indirect object.</i></font>
<a name="line-1703"></a><font color=Blue>objref</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> String
<a name="line-1704"></a><font color=Blue>objref</font> n <font color=Red>=</font> 
<a name="line-1705"></a>  show n <font color=Cyan>++</font> <font color=Magenta>" 0 R"</font>
<a name="line-1706"></a>
<a name="line-1707"></a><a name="wprintf_xref_entry"></a><font color=Blue><i>-- | Write one line in the cross reference table. This must be exactly</i></font>
<a name="line-1708"></a><font color=Blue><i>-- 20 characters long, including the terminating newline.</i></font>
<a name="line-1709"></a><font color=Blue>wprintf_xref_entry</font> <font color=Red>::</font> Filepos <font color=Red>-&gt;</font> Integer <font color=Red>-&gt;</font> Char <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1710"></a><font color=Blue>wprintf_xref_entry</font> pos gen c <font color=Red>=</font>
<a name="line-1711"></a>  wprintf <font color=Magenta>"%010u %05u %c \n"</font> pos gen c
<a name="line-1712"></a>
<a name="line-1713"></a><a name="wprintf_xref"></a><font color=Blue><i>-- | Format the cross reference table. Return the file position of the</i></font>
<a name="line-1714"></a><font color=Blue><i>-- cross reference table.</i></font>
<a name="line-1715"></a><font color=Blue>wprintf_xref</font> <font color=Red>::</font> PDFWriter Filepos
<a name="line-1716"></a><font color=Blue>wprintf_xref</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1717"></a>  xref <font color=Red>&lt;-</font> pdf_get_xref
<a name="line-1718"></a>  n <font color=Red>&lt;-</font> pdf_get_objcount
<a name="line-1719"></a>  pos <font color=Red>&lt;-</font> pdf_get_filepos
<a name="line-1720"></a>  wprintf <font color=Magenta>"xref\n"</font>
<a name="line-1721"></a>  wprintf <font color=Magenta>"0 %d\n"</font> <font color=Cyan>(</font>n<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-1722"></a>  wprintf_xref_entry <font color=Magenta>0</font> <font color=Magenta>65535</font> <font color=Magenta>'f'</font>
<a name="line-1723"></a>  sequence_ <font color=Red>[</font> <font color=Green><u>case</u></font> Map<font color=Cyan>.</font>lookup obj xref <font color=Green><u>of</u></font>  
<a name="line-1724"></a>                 Nothing <font color=Red>-&gt;</font> wprintf_xref_entry <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>'f'</font> 
<a name="line-1725"></a>                 Just p <font color=Red>-&gt;</font> wprintf_xref_entry p <font color=Magenta>0</font> <font color=Magenta>'n'</font> <font color=Red>|</font> obj <font color=Red>&lt;-</font> <font color=Red>[</font><font color=Magenta>1</font><font color=Red>..</font>n<font color=Red>]</font> <font color=Red>]</font>
<a name="line-1726"></a>  return pos
<a name="line-1727"></a>
<a name="line-1728"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1729"></a><font color=Blue><i>-- ** Internal rendering to the PDFWriter monad</i></font>
<a name="line-1730"></a>
<a name="line-1731"></a><a name="fillcolor_to_pdf"></a><font color=Blue><i>-- | Set the fill color.</i></font>
<a name="line-1732"></a><font color=Blue>fillcolor_to_pdf</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1733"></a><font color=Blue>fillcolor_to_pdf</font> <font color=Cyan>(</font>Color_RGB r g b<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1734"></a>  wprintf <font color=Magenta>"%f %f %f rg\n"</font> r g b
<a name="line-1735"></a><font color=Blue>fillcolor_to_pdf</font> <font color=Cyan>(</font>Color_Gray v<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1736"></a>  wprintf <font color=Magenta>"%f g\n"</font> v
<a name="line-1737"></a>
<a name="line-1738"></a><a name="strokecolor_to_pdf"></a><font color=Blue><i>-- | Set the stroke color.</i></font>
<a name="line-1739"></a><font color=Blue>strokecolor_to_pdf</font> <font color=Red>::</font> Color <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1740"></a><font color=Blue>strokecolor_to_pdf</font> <font color=Cyan>(</font>Color_RGB r g b<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1741"></a>  wprintf <font color=Magenta>"%f %f %f RG\n"</font> r g b
<a name="line-1742"></a><font color=Blue>strokecolor_to_pdf</font> <font color=Cyan>(</font>Color_Gray v<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1743"></a>  wprintf <font color=Magenta>"%f G\n"</font> v
<a name="line-1744"></a>
<a name="line-1745"></a><a name="font_to_pdf"></a><font color=Blue><i>-- | Set the font.</i></font>
<a name="line-1746"></a><font color=Blue>font_to_pdf</font> <font color=Red>::</font> Font <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1747"></a><font color=Blue>font_to_pdf</font> <font color=Cyan>(</font>Font TimesRoman pt<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1748"></a>  fn <font color=Red>&lt;-</font> pdf_find_font <font color=Magenta>"Times-Roman"</font>
<a name="line-1749"></a>  wprintf <font color=Magenta>"/%s %f Tf\n"</font> fn pt
<a name="line-1750"></a><font color=Blue>font_to_pdf</font> <font color=Cyan>(</font>Font Helvetica pt<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1751"></a>  fn <font color=Red>&lt;-</font> pdf_find_font <font color=Magenta>"Helvetica"</font>
<a name="line-1752"></a>  wprintf <font color=Magenta>"/%s %f Tf\n"</font> fn pt
<a name="line-1753"></a>
<a name="line-1754"></a><a name="command_to_pdf"></a><font color=Blue><i>-- | Render a drawing command to PDF.</i></font>
<a name="line-1755"></a><font color=Blue>command_to_pdf</font> <font color=Red>::</font> DrawCommand <font color=Red>-&gt;</font> PDFWriter ()
<a name="line-1756"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Newpath<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1757"></a>  wPutStr <font color=Magenta>"n\n"</font>
<a name="line-1758"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Moveto x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1759"></a>  wprintf <font color=Magenta>"%f %f m\n"</font> x y
<a name="line-1760"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Lineto x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1761"></a>  wprintf <font color=Magenta>"%f %f l\n"</font> x y
<a name="line-1762"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Curveto x1 y1 x2 y2 x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1763"></a>  wprintf <font color=Magenta>"%f %f %f %f %f %f c\n"</font> x1 y1 x2 y2 x y
<a name="line-1764"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Closepath<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1765"></a>  wPutStr <font color=Magenta>"h\n"</font>
<a name="line-1766"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Stroke<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1767"></a>  wPutStr <font color=Magenta>"S\n"</font>
<a name="line-1768"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Fill color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1769"></a>  fillcolor_to_pdf color
<a name="line-1770"></a>  wPutStr <font color=Magenta>"f\n"</font>
<a name="line-1771"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>FillStroke color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1772"></a>  fillcolor_to_pdf color
<a name="line-1773"></a>  wPutStr <font color=Magenta>"B\n"</font>
<a name="line-1774"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>TextBox align font color x0 y0 x1 y1 b s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1775"></a>  <font color=Green><u>let</u></font> w <font color=Red>=</font> text_width font s
<a name="line-1776"></a>      dx <font color=Red>=</font> x1 <font color=Blue><i>-</i></font> x0
<a name="line-1777"></a>      dy <font color=Red>=</font> y1 <font color=Blue><i>-</i></font> y0
<a name="line-1778"></a>      d <font color=Red>=</font> sqrt <font color=Cyan>(</font>dx<font color=Cyan>*</font>dx <font color=Cyan>+</font> dy<font color=Cyan>*</font>dy<font color=Cyan>)</font>
<a name="line-1779"></a>      f <font color=Red>=</font> max w d
<a name="line-1780"></a>      dxf <font color=Red>=</font> <font color=Green><u>if</u></font> f <font color=Cyan>&gt;</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font> dx<font color=Cyan>/</font>f <font color=Green><u>else</u></font> <font color=Magenta>1</font>
<a name="line-1781"></a>      dyf <font color=Red>=</font> <font color=Green><u>if</u></font> f <font color=Cyan>&gt;</font> <font color=Magenta>0</font> <font color=Green><u>then</u></font> dy<font color=Cyan>/</font>f <font color=Green><u>else</u></font> <font color=Magenta>1</font>
<a name="line-1782"></a>      xshift <font color=Red>=</font> <font color=Cyan>(</font>f<font color=Blue><i>-</i></font>w<font color=Cyan>)</font> <font color=Cyan>*</font> align
<a name="line-1783"></a>      yshift <font color=Red>=</font> <font color=Blue><i>-</i></font>b <font color=Cyan>*</font> nominalsize font
<a name="line-1784"></a>  wPutStr <font color=Magenta>"BT\n"</font>
<a name="line-1785"></a>  font_to_pdf font
<a name="line-1786"></a>  wprintf <font color=Magenta>"%f %f %f %f %f %f Tm\n"</font> dxf dyf <font color=Cyan>(</font><font color=Blue><i>-</i></font>dyf<font color=Cyan>)</font> dxf <font color=Cyan>(</font>x0 <font color=Cyan>+</font> xshift<font color=Cyan>*</font>dxf <font color=Blue><i>-</i></font> yshift<font color=Cyan>*</font>dyf<font color=Cyan>)</font> <font color=Cyan>(</font>y0 <font color=Cyan>+</font> xshift<font color=Cyan>*</font>dyf <font color=Cyan>+</font> yshift<font color=Cyan>*</font>dxf<font color=Cyan>)</font>
<a name="line-1787"></a>  fillcolor_to_pdf color
<a name="line-1788"></a>  wprintf <font color=Magenta>"(%s) Tj\n"</font> <font color=Cyan>(</font>pdf_escape s<font color=Cyan>)</font>
<a name="line-1789"></a>  wPutStr <font color=Magenta>"ET\n"</font>
<a name="line-1790"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>SetLineWidth x<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1791"></a>  wprintf <font color=Magenta>"%f w\n"</font> x
<a name="line-1792"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>SetColor color<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1793"></a>  strokecolor_to_pdf color
<a name="line-1794"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Translate x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1795"></a>  wprintf <font color=Magenta>"1 0 0 1 %f %f cm\n"</font> x y
<a name="line-1796"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Scale x y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1797"></a>  wprintf <font color=Magenta>"%f 0 0 %f 0 0 cm\n"</font> x y
<a name="line-1798"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Rotate angle<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1799"></a>  wprintf <font color=Magenta>"%f %f %f %f 0 0 cm\n"</font> c s <font color=Cyan>(</font><font color=Blue><i>-</i></font>s<font color=Cyan>)</font> c <font color=Green><u>where</u></font>
<a name="line-1800"></a>    c <font color=Red>=</font> cos <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> angle<font color=Cyan>)</font>
<a name="line-1801"></a>    s <font color=Red>=</font> sin <font color=Cyan>(</font>pi<font color=Cyan>/</font><font color=Magenta>180</font> <font color=Cyan>*</font> angle<font color=Cyan>)</font>
<a name="line-1802"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Comment s<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1803"></a>  wprintf <font color=Magenta>"%% %s\n"</font> <font color=Cyan>(</font>remove_nl s<font color=Cyan>)</font>
<a name="line-1804"></a><font color=Blue>command_to_pdf</font> <font color=Cyan>(</font>Subroutine draw alt<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1805"></a>  <font color=Green><u>case</u></font> custom_lookup Language_PDF alt <font color=Green><u>of</u></font>
<a name="line-1806"></a>    Just out <font color=Red>-&gt;</font> wprintf <font color=Magenta>"%s"</font> <font color=Cyan>(</font>ensure_nl out<font color=Cyan>)</font>
<a name="line-1807"></a>    Nothing <font color=Red>-&gt;</font> draw_to_pdf draw
<a name="line-1808"></a>
<a name="line-1809"></a><a name="draw_to_pdf"></a><font color=Blue><i>-- | Render a draw action to PDF.</i></font>
<a name="line-1810"></a><font color=Blue>draw_to_pdf</font> <font color=Red>::</font> Draw a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1811"></a><font color=Blue>draw_to_pdf</font> <font color=Cyan>(</font>Draw_Return x<font color=Cyan>)</font> <font color=Red>=</font> return x
<a name="line-1812"></a><font color=Blue>draw_to_pdf</font> <font color=Cyan>(</font>Draw_Write cmd cont<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1813"></a>  command_to_pdf cmd
<a name="line-1814"></a>  draw_to_pdf cont
<a name="line-1815"></a><font color=Blue>draw_to_pdf</font> <font color=Cyan>(</font>Draw_Block body<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1816"></a>  wprintf <font color=Magenta>"q\n"</font>
<a name="line-1817"></a>  cont <font color=Red>&lt;-</font> draw_to_pdf body
<a name="line-1818"></a>  wprintf <font color=Magenta>"Q\n"</font>
<a name="line-1819"></a>  draw_to_pdf cont
<a name="line-1820"></a>
<a name="line-1821"></a><a name="pages_to_pdf"></a><font color=Blue><i>-- | Render pages as PDF. The first argument is a reference to the</i></font>
<a name="line-1822"></a><font color=Blue><i>-- document's page tree node. </i></font>
<a name="line-1823"></a><font color=Blue><i>-- </i></font>
<a name="line-1824"></a><font color=Blue><i>-- Note: Acrobat reader cannot handle pages whose bounding box width</i></font>
<a name="line-1825"></a><font color=Blue><i>-- or height exceed 200 inches (14400 points). Therefore, we</i></font>
<a name="line-1826"></a><font color=Blue><i>-- automatically scale pages to be no greater than 199 inches.</i></font>
<a name="line-1827"></a><font color=Blue>pages_to_pdf</font> <font color=Red>::</font> Object <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1828"></a><font color=Blue>pages_to_pdf</font> pagetree_obj <font color=Cyan>(</font>Document_Return a<font color=Cyan>)</font> <font color=Red>=</font> return a
<a name="line-1829"></a><font color=Blue>pages_to_pdf</font> pagetree_obj <font color=Cyan>(</font>Document_Page x y draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1830"></a>  <font color=Green><u>let</u></font> sc <font color=Red>=</font> <font color=Magenta>14328</font> <font color=Cyan>/</font> maximum <font color=Red>[</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> <font color=Magenta>14328</font><font color=Red>]</font>
<a name="line-1831"></a>  page <font color=Red>&lt;-</font> pdf_next_page
<a name="line-1832"></a>  wprintf <font color=Magenta>"%% Page %d\n"</font> page
<a name="line-1833"></a>  pdf_clear_fonttable
<a name="line-1834"></a>  contents_obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1835"></a>  cont <font color=Red>&lt;-</font> pdf_deferred_flate_stream contents_obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1836"></a>    when <font color=Cyan>(</font>sc <font color=Cyan>/=</font> <font color=Magenta>1.0</font><font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1837"></a>      draw_to_pdf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1838"></a>        scale sc sc
<a name="line-1839"></a>    draw_to_pdf draw
<a name="line-1840"></a>  fonttable_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1841"></a>    fonttable <font color=Red>&lt;-</font> pdf_get_fonttable
<a name="line-1842"></a>    wprintf <font color=Magenta>"&lt;&lt;\n"</font>
<a name="line-1843"></a>    sequence_ <font color=Red>[</font> wprintf <font color=Magenta>"/%s&lt;&lt;/Type/Font/Subtype/Type1/BaseFont/%s&gt;&gt;\n"</font> x f <font color=Red>|</font> <font color=Cyan>(</font>f<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList fonttable <font color=Red>]</font>
<a name="line-1844"></a>    wprintf <font color=Magenta>"&gt;&gt;\n"</font>
<a name="line-1845"></a>  page_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1846"></a>    wprintf <font color=Magenta>"&lt;&lt;/Type/Page/Parent %s/Resources&lt;&lt;/ProcSet[/PDF]/Font %s&gt;&gt;/MediaBox[0 0 %f %f]/Contents %s&gt;&gt;\n"</font> <font color=Cyan>(</font>objref pagetree_obj<font color=Cyan>)</font> <font color=Cyan>(</font>objref fonttable_obj<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>*</font>sc<font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>*</font>sc<font color=Cyan>)</font> <font color=Cyan>(</font>objref contents_obj<font color=Cyan>)</font>
<a name="line-1847"></a>  pdf_add_pagetable page page_obj
<a name="line-1848"></a>  pages_to_pdf pagetree_obj cont
<a name="line-1849"></a><font color=Blue>pages_to_pdf</font> pagetree_obj <font color=Cyan>(</font>Document_Page_defer draw<font color=Cyan>)</font> <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1850"></a>  page <font color=Red>&lt;-</font> pdf_next_page
<a name="line-1851"></a>  wprintf <font color=Magenta>"%% Page %d\n"</font> page
<a name="line-1852"></a>  pdf_clear_fonttable
<a name="line-1853"></a>  contents_obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1854"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> cont<font color=Cyan>)</font> <font color=Red>&lt;-</font> pdf_deferred_stream contents_obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1855"></a>    draw_to_pdf draw
<a name="line-1856"></a>  fonttable_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1857"></a>    fonttable <font color=Red>&lt;-</font> pdf_get_fonttable
<a name="line-1858"></a>    wprintf <font color=Magenta>"&lt;&lt;\n"</font>
<a name="line-1859"></a>    sequence_ <font color=Red>[</font> wprintf <font color=Magenta>"/%s&lt;&lt;/Type/Font/Subtype/Type1/BaseFont/%s&gt;&gt;\n"</font> x f <font color=Red>|</font> <font color=Cyan>(</font>f<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>toList fonttable <font color=Red>]</font>
<a name="line-1860"></a>    wprintf <font color=Magenta>"&gt;&gt;\n"</font>
<a name="line-1861"></a>  <font color=Green><u>let</u></font> sc <font color=Red>=</font> <font color=Magenta>14328</font> <font color=Cyan>/</font> maximum <font color=Red>[</font>x<font color=Cyan>,</font> y<font color=Cyan>,</font> <font color=Magenta>14328</font><font color=Red>]</font>
<a name="line-1862"></a>  scaled_contents_obj <font color=Red>&lt;-</font> 
<a name="line-1863"></a>    <font color=Green><u>if</u></font> sc <font color=Cyan>==</font> <font color=Magenta>1.0</font> <font color=Green><u>then</u></font> <font color=Green><u>do</u></font>
<a name="line-1864"></a>      return contents_obj
<a name="line-1865"></a>    <font color=Green><u>else</u></font> <font color=Green><u>do</u></font>
<a name="line-1866"></a>      scale_obj <font color=Red>&lt;-</font> pdf_define_stream <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1867"></a>        draw_to_pdf <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1868"></a>          scale sc sc
<a name="line-1869"></a>      obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1870"></a>        wprintf <font color=Magenta>"[%s %s]\n"</font> <font color=Cyan>(</font>objref scale_obj<font color=Cyan>)</font> <font color=Cyan>(</font>objref contents_obj<font color=Cyan>)</font>
<a name="line-1871"></a>      return obj
<a name="line-1872"></a>  page_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1873"></a>    wprintf <font color=Magenta>"&lt;&lt;/Type/Page/Parent %s/Resources&lt;&lt;/ProcSet[/PDF]/Font %s&gt;&gt;/MediaBox[0 0 %f %f]/Contents %s&gt;&gt;\n"</font> <font color=Cyan>(</font>objref pagetree_obj<font color=Cyan>)</font> <font color=Cyan>(</font>objref fonttable_obj<font color=Cyan>)</font> <font color=Cyan>(</font>x<font color=Cyan>*</font>sc<font color=Cyan>)</font> <font color=Cyan>(</font>y<font color=Cyan>*</font>sc<font color=Cyan>)</font> <font color=Cyan>(</font>objref scaled_contents_obj<font color=Cyan>)</font>
<a name="line-1874"></a>  pdf_add_pagetable page page_obj
<a name="line-1875"></a>  pages_to_pdf pagetree_obj cont
<a name="line-1876"></a> 
<a name="line-1877"></a><a name="document_to_pdf"></a><font color=Blue><i>-- | Render a document as PDF.</i></font>
<a name="line-1878"></a><font color=Blue>document_to_pdf</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> PDFWriter a
<a name="line-1879"></a><font color=Blue>document_to_pdf</font> custom document <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1880"></a>  <font color=Blue><i>-- global header</i></font>
<a name="line-1881"></a>  wprintf <font color=Magenta>"%%PDF-1.3\n"</font>
<a name="line-1882"></a>  info_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1883"></a>    <font color=Green><u>if</u></font> <font color=Cyan>(</font>creator custom <font color=Cyan>/=</font> <font color=Magenta>""</font><font color=Cyan>)</font> 
<a name="line-1884"></a>      <font color=Green><u>then</u></font> wprintf <font color=Magenta>"&lt;&lt;/Creator(%s)&gt;&gt;\n"</font> <font color=Cyan>(</font>pdf_escape <font color=Cyan>$</font> creator custom<font color=Cyan>)</font>
<a name="line-1885"></a>      <font color=Green><u>else</u></font> wprintf <font color=Magenta>"&lt;&lt;&gt;&gt;\n"</font>
<a name="line-1886"></a>  pagetree_obj <font color=Red>&lt;-</font> pdf_next_object
<a name="line-1887"></a>  catalog_obj <font color=Red>&lt;-</font> pdf_define_object <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1888"></a>    wprintf <font color=Magenta>"&lt;&lt;/Type/Catalog/Pages %s&gt;&gt;\n"</font> <font color=Cyan>(</font>objref pagetree_obj<font color=Cyan>)</font>
<a name="line-1889"></a>  a <font color=Red>&lt;-</font> pages_to_pdf pagetree_obj document
<a name="line-1890"></a>  pages <font color=Red>&lt;-</font> pdf_get_pagecount
<a name="line-1891"></a>  pagetable <font color=Red>&lt;-</font> pdf_get_pagetable
<a name="line-1892"></a>  pdf_deferred_object pagetree_obj <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1893"></a>    wprintf <font color=Magenta>"&lt;&lt;/Type/Pages/Count %d/Kids[\n"</font> pages
<a name="line-1894"></a>    sequence_ <font color=Red>[</font> wprintf <font color=Magenta>"%s\n"</font> <font color=Cyan>(</font>objref o<font color=Cyan>)</font> <font color=Red>|</font> o <font color=Red>&lt;-</font> Map<font color=Cyan>.</font>elems pagetable <font color=Red>]</font>
<a name="line-1895"></a>    wprintf <font color=Magenta>"]&gt;&gt;\n"</font>
<a name="line-1896"></a>  xref_pos <font color=Red>&lt;-</font> wprintf_xref
<a name="line-1897"></a>  wprintf <font color=Magenta>"trailer\n"</font>
<a name="line-1898"></a>  objcount <font color=Red>&lt;-</font> pdf_get_objcount
<a name="line-1899"></a>  wprintf <font color=Magenta>"&lt;&lt;/Size %d/Root %s/Info %s&gt;&gt;\n"</font> objcount <font color=Cyan>(</font>objref catalog_obj<font color=Cyan>)</font> <font color=Cyan>(</font>objref info_obj<font color=Cyan>)</font>
<a name="line-1900"></a>  wprintf <font color=Magenta>"startxref\n"</font>
<a name="line-1901"></a>  wprintf <font color=Magenta>"%d\n"</font> xref_pos
<a name="line-1902"></a>  wprintf <font color=Magenta>"%%%%EOF\n"</font>
<a name="line-1903"></a>  return a
<a name="line-1904"></a>
<a name="line-1905"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1906"></a><font color=Blue><i>-- ** Rendering to the Writer monad</i></font>
<a name="line-1907"></a>
<a name="line-1908"></a><a name="render_pdf_custom"></a><font color=Blue><i>-- | Render document as PDF. The first argument is a</i></font>
<a name="line-1909"></a><font color=Blue><i>-- customization data structure.</i></font>
<a name="line-1910"></a><font color=Blue>render_pdf_custom</font> <font color=Red>::</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1911"></a><font color=Blue>render_pdf_custom</font> custom doc <font color=Red>=</font> pdfwriter_run <font color=Cyan>(</font>document_to_pdf custom doc<font color=Cyan>)</font>
<a name="line-1912"></a>
<a name="line-1913"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1914"></a><font color=Blue><i>-- * Generic output functions</i></font>
<a name="line-1915"></a>
<a name="line-1916"></a><font color=Blue><i>-- $BACKENDS </i></font>
<a name="line-1917"></a><font color=Blue><i>-- </i></font>
<a name="line-1918"></a><font color=Blue><i>-- The following commands can be used to render documents to various</i></font>
<a name="line-1919"></a><font color=Blue><i>-- available formats. The available formats are PostScript, PDF, EPS,</i></font>
<a name="line-1920"></a><font color=Blue><i>-- and an ASCII-based debugging format. Output can be written to</i></font>
<a name="line-1921"></a><font color=Blue><i>-- standard output, to a file, or to a string.</i></font>
<a name="line-1922"></a>  
<a name="line-1923"></a><a name="RenderFormat"></a><font color=Blue><i>-- | Available graphics formats for rendering.</i></font>
<a name="line-1924"></a><a name="RenderFormat"></a><font color=Green><u>data</u></font> RenderFormat <font color=Red>=</font> 
<a name="line-1925"></a>  Format_PS            <font color=Blue><i>-- ^ PostScript.</i></font>
<a name="line-1926"></a>  <font color=Red>|</font> Format_PDF         <font color=Blue><i>-- ^ Portable Document Format.</i></font>
<a name="line-1927"></a>  <font color=Red>|</font> Format_EPS Integer <font color=Blue><i>-- ^ Encapsulated PostScript. The integer</i></font>
<a name="line-1928"></a>                       <font color=Blue><i>-- argument specifies which single page to</i></font>
<a name="line-1929"></a>                       <font color=Blue><i>-- extract from the document.</i></font>
<a name="line-1930"></a>  <font color=Red>|</font> Format_Debug       <font color=Blue><i>-- ^ An ASCII-based debugging format.</i></font>
<a name="line-1931"></a> <font color=Green><u>deriving</u></font> Show
<a name="line-1932"></a>
<a name="line-1933"></a><a name="is_binary_format"></a><font color=Blue><i>-- | Does the format require raw binary output?</i></font>
<a name="line-1934"></a><font color=Blue>is_binary_format</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Bool
<a name="line-1935"></a><font color=Blue>is_binary_format</font> Format_PS <font color=Red>=</font> False
<a name="line-1936"></a><font color=Blue>is_binary_format</font> Format_PDF <font color=Red>=</font> True
<a name="line-1937"></a><font color=Blue>is_binary_format</font> <font color=Cyan>(</font>Format_EPS page<font color=Cyan>)</font> <font color=Red>=</font> False
<a name="line-1938"></a><font color=Blue>is_binary_format</font> Format_Debug <font color=Red>=</font> False
<a name="line-1939"></a>
<a name="line-1940"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1941"></a><font color=Blue><i>-- ** Rendering with custom format</i></font>
<a name="line-1942"></a>
<a name="line-1943"></a><font color=Blue><i>-- $CUSTOMRENDER</i></font>
<a name="line-1944"></a><font color=Blue><i>-- </i></font>
<a name="line-1945"></a><font color=Blue><i>-- The following are versions of the generic rendering functions that</i></font>
<a name="line-1946"></a><font color=Blue><i>-- also take a customization data structure as an additional</i></font>
<a name="line-1947"></a><font color=Blue><i>-- parameter.</i></font>
<a name="line-1948"></a>
<a name="line-1949"></a><a name="render_custom"></a><font color=Blue><i>-- | Render a document to the 'Writer' monad, using the given output</i></font>
<a name="line-1950"></a><font color=Blue><i>-- format and customization data structure.</i></font>
<a name="line-1951"></a><font color=Blue>render_custom</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1952"></a><font color=Blue>render_custom</font> Format_PS <font color=Red>=</font> render_ps_custom
<a name="line-1953"></a><font color=Blue>render_custom</font> Format_PDF <font color=Red>=</font> render_pdf_custom
<a name="line-1954"></a><font color=Blue>render_custom</font> <font color=Cyan>(</font>Format_EPS page<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Red>\</font>c <font color=Red>-&gt;</font> render_eps_custom c page<font color=Cyan>)</font>
<a name="line-1955"></a><font color=Blue>render_custom</font> Format_Debug <font color=Red>=</font> <font color=Red>\</font>c <font color=Red>-&gt;</font> render_ascii
<a name="line-1956"></a>
<a name="line-1957"></a><a name="render_custom_file"></a><font color=Blue><i>-- | Render a document to a file, using the given output format and</i></font>
<a name="line-1958"></a><font color=Blue><i>-- customization data structure.</i></font>
<a name="line-1959"></a><font color=Blue>render_custom_file</font> <font color=Red>::</font> Handle <font color=Red>-&gt;</font> RenderFormat <font color=Red>-&gt;</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1960"></a><font color=Blue>render_custom_file</font> h format custom d <font color=Red>=</font> <font color=Green><u>do</u></font>
<a name="line-1961"></a>  when <font color=Cyan>(</font>is_binary_format format<font color=Cyan>)</font> <font color=Cyan>$</font> <font color=Green><u>do</u></font>
<a name="line-1962"></a>    hSetBinaryMode h True
<a name="line-1963"></a>  writer_to_file h <font color=Cyan>(</font>render_custom format custom d<font color=Cyan>)</font>
<a name="line-1964"></a>
<a name="line-1965"></a><a name="render_custom_stdout"></a><font color=Blue><i>-- | Render a document to standard output, using the given output</i></font>
<a name="line-1966"></a><font color=Blue><i>-- format and customization data structure.</i></font>
<a name="line-1967"></a><font color=Blue>render_custom_stdout</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1968"></a><font color=Blue>render_custom_stdout</font> <font color=Red>=</font> render_custom_file stdout
<a name="line-1969"></a>
<a name="line-1970"></a><a name="render_custom_string"></a><font color=Blue><i>-- | Render a document to a string, using the given output format and</i></font>
<a name="line-1971"></a><font color=Blue><i>-- customization data structure.</i></font>
<a name="line-1972"></a><font color=Blue>render_custom_string</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Custom <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> String
<a name="line-1973"></a><font color=Blue>render_custom_string</font> format custom d <font color=Red>=</font>
<a name="line-1974"></a>  writer_to_string <font color=Cyan>(</font>render_custom format custom d<font color=Cyan>)</font>  
<a name="line-1975"></a>
<a name="line-1976"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-1977"></a><font color=Blue><i>-- ** Rendering without custom format</i></font>
<a name="line-1978"></a>
<a name="line-1979"></a><a name="render"></a><font color=Blue><i>-- | Render a document to the 'Writer' monad, using the given output format.</i></font>
<a name="line-1980"></a><font color=Blue>render</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> Writer a
<a name="line-1981"></a><font color=Blue>render</font> format doc <font color=Red>=</font> render_custom format custom doc
<a name="line-1982"></a>
<a name="line-1983"></a><a name="render_file"></a><font color=Blue><i>-- | Render a document to a file, using the given output format.</i></font>
<a name="line-1984"></a><font color=Blue>render_file</font> <font color=Red>::</font> Handle <font color=Red>-&gt;</font> RenderFormat <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1985"></a><font color=Blue>render_file</font> h format doc <font color=Red>=</font> render_custom_file h format custom doc
<a name="line-1986"></a>
<a name="line-1987"></a><a name="render_stdout"></a><font color=Blue><i>-- | Render a document to standard output, using the given output format.</i></font>
<a name="line-1988"></a><font color=Blue>render_stdout</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> IO a
<a name="line-1989"></a><font color=Blue>render_stdout</font> <font color=Red>=</font> render_file stdout
<a name="line-1990"></a>
<a name="line-1991"></a><a name="render_string"></a><font color=Blue><i>-- | Render a document to a string, using the given output format.</i></font>
<a name="line-1992"></a><font color=Blue>render_string</font> <font color=Red>::</font> RenderFormat <font color=Red>-&gt;</font> Document a <font color=Red>-&gt;</font> String
<a name="line-1993"></a><font color=Blue>render_string</font> format doc <font color=Red>=</font> render_custom_string format custom doc
</pre>
</body>
</html>