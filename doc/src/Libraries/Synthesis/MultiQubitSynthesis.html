<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>Haskell code</title>
</head>
<body>
<pre><a name="line-1"></a><font color=Blue><i>{-# LANGUAGE MultiParamTypeClasses #-}</i></font>
<a name="line-2"></a><font color=Blue><i>{-# LANGUAGE FunctionalDependencies #-}</i></font>
<a name="line-3"></a><font color=Blue><i>{-# LANGUAGE UndecidableInstances #-}</i></font>
<a name="line-4"></a><font color=Blue><i>{-# LANGUAGE GADTs #-}</i></font>
<a name="line-5"></a>
<a name="line-6"></a><font color=Blue><i>-- | This module provides functions for the representation and exact</i></font>
<a name="line-7"></a><font color=Blue><i>-- synthesis of multi-qubit Clifford+/T/ operators. </i></font>
<a name="line-8"></a><font color=Blue><i>-- </i></font>
<a name="line-9"></a><font color=Blue><i>-- The multi-qubit Clifford+/T/ exact synthesis algorithm is described</i></font>
<a name="line-10"></a><font color=Blue><i>-- in the paper:</i></font>
<a name="line-11"></a><font color=Blue><i>-- </i></font>
<a name="line-12"></a><font color=Blue><i>-- * Brett Giles, Peter Selinger. Exact synthesis of multiqubit Clifford+T</i></font>
<a name="line-13"></a><font color=Blue><i>-- circuits. /Physical Review A/ 87, 032332 (7 pages), 2013. Available</i></font>
<a name="line-14"></a><font color=Blue><i>-- from &lt;<a href="http://arxiv.org/abs/1212.0506">http://arxiv.org/abs/1212.0506</a>&gt;.</i></font>
<a name="line-15"></a><font color=Blue><i>-- </i></font>
<a name="line-16"></a><font color=Blue><i>-- It generalizes the single-qubit exact synthesis algorithm of</i></font>
<a name="line-17"></a><font color=Blue><i>-- Kliuchnikov, Maslov, and Mosca.</i></font>
<a name="line-18"></a>
<a name="line-19"></a><font color=Green><u>module</u></font> Libraries<font color=Cyan>.</font>Synthesis<font color=Cyan>.</font>MultiQubitSynthesis <font color=Green><u>where</u></font>
<a name="line-20"></a>
<a name="line-21"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Synthesis<font color=Cyan>.</font>Matrix
<a name="line-22"></a><font color=Green><u>import</u></font> Libraries<font color=Cyan>.</font>Synthesis<font color=Cyan>.</font>Ring
<a name="line-23"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>List
<a name="line-24"></a><font color=Green><u>import</u></font> Data<font color=Cyan>.</font>Ord
<a name="line-25"></a>
<a name="line-26"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-27"></a><font color=Blue><i>-- * Residues</i></font>
<a name="line-28"></a>
<a name="line-29"></a><a name="Residue"></a><font color=Blue><i>-- | A type class for things that have residues. In a typical</i></font>
<a name="line-30"></a><a name="Residue"></a><font color=Blue><i>-- instance, /a/ is a ring whose elements are expressed with</i></font>
<a name="line-31"></a><a name="Residue"></a><font color=Blue><i>-- coefficients in &#8484;, and /b/ is a corresponding ring whose elements</i></font>
<a name="line-32"></a><a name="Residue"></a><font color=Blue><i>-- are expressed with coefficients in &#8484;[sub 2].</i></font>
<a name="line-33"></a><a name="Residue"></a><font color=Green><u>class</u></font> Residue a b <font color=Red>|</font> a <font color=Red>-&gt;</font> b <font color=Green><u>where</u></font>
<a name="line-34"></a>  <font color=Blue><i>-- | Return the residue of something.</i></font>
<a name="line-35"></a>  residue <font color=Red>::</font> a <font color=Red>-&gt;</font> b
<a name="line-36"></a>  
<a name="line-37"></a><font color=Green><u>instance</u></font> Residue Integer Z2 <font color=Green><u>where</u></font>
<a name="line-38"></a>  residue <font color=Red>=</font> parity
<a name="line-39"></a>  
<a name="line-40"></a><font color=Green><u>instance</u></font> Residue a b <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>Omega a<font color=Cyan>)</font> <font color=Cyan>(</font>Omega b<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-41"></a>  residue <font color=Cyan>(</font>Omega a b c d<font color=Cyan>)</font> <font color=Red>=</font> Omega <font color=Cyan>(</font>residue a<font color=Cyan>)</font> <font color=Cyan>(</font>residue b<font color=Cyan>)</font> <font color=Cyan>(</font>residue c<font color=Cyan>)</font> <font color=Cyan>(</font>residue d<font color=Cyan>)</font>
<a name="line-42"></a>
<a name="line-43"></a><font color=Green><u>instance</u></font> Residue a b <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>RootTwo a<font color=Cyan>)</font> <font color=Cyan>(</font>RootTwo b<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-44"></a>  residue <font color=Cyan>(</font>RootTwo a b<font color=Cyan>)</font> <font color=Red>=</font> RootTwo <font color=Cyan>(</font>residue a<font color=Cyan>)</font> <font color=Cyan>(</font>residue b<font color=Cyan>)</font>
<a name="line-45"></a>  
<a name="line-46"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>Residue a a'<font color=Cyan>,</font> Residue b b'<font color=Cyan>)</font> <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font>a'<font color=Cyan>,</font>b'<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-47"></a>  residue <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>residue x<font color=Cyan>,</font> residue y<font color=Cyan>)</font>
<a name="line-48"></a>  
<a name="line-49"></a><font color=Green><u>instance</u></font> Residue () () <font color=Green><u>where</u></font>  
<a name="line-50"></a>  residue <font color=Red>=</font> const ()
<a name="line-51"></a>  
<a name="line-52"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>Residue a b<font color=Cyan>)</font> <font color=Red>=&gt;</font> Residue <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>[</font>b<font color=Red>]</font> <font color=Green><u>where</u></font>  
<a name="line-53"></a>  residue <font color=Red>=</font> map residue
<a name="line-54"></a>  
<a name="line-55"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>Residue a b<font color=Cyan>)</font> <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>Cplx a<font color=Cyan>)</font> <font color=Cyan>(</font>Cplx b<font color=Cyan>)</font> <font color=Green><u>where</u></font>  
<a name="line-56"></a>  residue <font color=Cyan>(</font>Cplx a b<font color=Cyan>)</font> <font color=Red>=</font> Cplx <font color=Cyan>(</font>residue a<font color=Cyan>)</font> <font color=Cyan>(</font>residue b<font color=Cyan>)</font>
<a name="line-57"></a>  
<a name="line-58"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>Residue a b<font color=Cyan>)</font> <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>Vector n a<font color=Cyan>)</font> <font color=Cyan>(</font>Vector n b<font color=Cyan>)</font> <font color=Green><u>where</u></font>  
<a name="line-59"></a>  residue <font color=Red>=</font> vector_map residue
<a name="line-60"></a>  
<a name="line-61"></a><font color=Green><u>instance</u></font> <font color=Cyan>(</font>Residue a b<font color=Cyan>)</font> <font color=Red>=&gt;</font> Residue <font color=Cyan>(</font>Matrix m n a<font color=Cyan>)</font> <font color=Cyan>(</font>Matrix m n b<font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-62"></a>  residue <font color=Cyan>(</font>Matrix m<font color=Cyan>)</font> <font color=Red>=</font> Matrix <font color=Cyan>(</font>residue m<font color=Cyan>)</font>
<a name="line-63"></a>  
<a name="line-64"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-65"></a><font color=Blue><i>-- * One- and two-level operators</i></font>
<a name="line-66"></a>  
<a name="line-67"></a><font color=Blue><i>-- ----------------------------------------------------------------------  </i></font>
<a name="line-68"></a><font color=Blue><i>-- ** Symbolic representation</i></font>
<a name="line-69"></a>
<a name="line-70"></a><a name="Index"></a><font color=Blue><i>-- | An index for a row or column of a matrix.</i></font>
<a name="line-71"></a><a name="Index"></a><font color=Green><u>type</u></font> Index <font color=Red>=</font> Int
<a name="line-72"></a>
<a name="line-73"></a><a name="TwoLevel"></a><font color=Blue><i>-- | Symbolic representation of one- and two-level operators. Note</i></font>
<a name="line-74"></a><a name="TwoLevel"></a><font color=Blue><i>-- that the power /k/ in the 'TL_T' and 'TL_omega' constructors can be</i></font>
<a name="line-75"></a><a name="TwoLevel"></a><font color=Blue><i>-- positive or negative, and should be regarded modulo 8.</i></font>
<a name="line-76"></a><a name="TwoLevel"></a><font color=Blue><i>-- </i></font>
<a name="line-77"></a><a name="TwoLevel"></a><font color=Blue><i>-- Note: when we use a list of 'TwoLevel' operators to express a</i></font>
<a name="line-78"></a><a name="TwoLevel"></a><font color=Blue><i>-- sequence of operators, the operators are meant to be applied</i></font>
<a name="line-79"></a><a name="TwoLevel"></a><font color=Blue><i>-- right-to-left, i.e., as in the mathematical notation for matrix</i></font>
<a name="line-80"></a><a name="TwoLevel"></a><font color=Blue><i>-- multiplication. This is the opposite of the quantum circuit</i></font>
<a name="line-81"></a><a name="TwoLevel"></a><font color=Blue><i>-- notation.</i></font>
<a name="line-82"></a><a name="TwoLevel"></a><font color=Green><u>data</u></font> TwoLevel <font color=Red>=</font> 
<a name="line-83"></a>  TL_X Index Index <font color=Blue><i>-- ^ /X/[sub /i/,/j/]</i></font>
<a name="line-84"></a>  <font color=Red>|</font> TL_H Index Index <font color=Blue><i>-- ^ /H/[sub /i/,/j/]</i></font>
<a name="line-85"></a>  <font color=Red>|</font> TL_T Int Index Index <font color=Blue><i>-- ^ (/T/[sub /i/,/j/])[super /k/]</i></font>
<a name="line-86"></a>  <font color=Red>|</font> TL_omega Int Index <font color=Blue><i>-- ^ (&#969;[sub /i/])[super /k/]</i></font>
<a name="line-87"></a>  <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Show<font color=Cyan>,</font> Eq<font color=Cyan>)</font>
<a name="line-88"></a>
<a name="line-89"></a><a name="invert_twolevel"></a><font color=Blue><i>-- | Invert a 'TwoLevel' operator.</i></font>
<a name="line-90"></a><font color=Blue>invert_twolevel</font> <font color=Red>::</font> TwoLevel <font color=Red>-&gt;</font> TwoLevel
<a name="line-91"></a><font color=Blue>invert_twolevel</font> <font color=Cyan>(</font>TL_X i j<font color=Cyan>)</font> <font color=Red>=</font> TL_X i j
<a name="line-92"></a><font color=Blue>invert_twolevel</font> <font color=Cyan>(</font>TL_H i j<font color=Cyan>)</font> <font color=Red>=</font> TL_H i j
<a name="line-93"></a><font color=Blue>invert_twolevel</font> <font color=Cyan>(</font>TL_T m i j<font color=Cyan>)</font> <font color=Red>=</font> TL_T <font color=Cyan>(</font><font color=Blue><i>-</i></font>m<font color=Cyan>)</font> i j
<a name="line-94"></a><font color=Blue>invert_twolevel</font> <font color=Cyan>(</font>TL_omega m j<font color=Cyan>)</font> <font color=Red>=</font> TL_omega <font color=Cyan>(</font><font color=Blue><i>-</i></font>m<font color=Cyan>)</font> j
<a name="line-95"></a>
<a name="line-96"></a><a name="invert_twolevels"></a><font color=Blue><i>-- | Invert a list of 'TwoLevel' operators.</i></font>
<a name="line-97"></a><font color=Blue>invert_twolevels</font> <font color=Red>::</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font>
<a name="line-98"></a><font color=Blue>invert_twolevels</font> <font color=Red>=</font> reverse <font color=Cyan>.</font> map invert_twolevel
<a name="line-99"></a>
<a name="line-100"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-101"></a><font color=Blue><i>-- ** Constructors for two-level matrices</i></font>
<a name="line-102"></a>
<a name="line-103"></a><a name="twolevel_matrix"></a><font color=Blue><i>-- | Construct a two-level matrix with the given entries.</i></font>
<a name="line-104"></a><font color=Blue>twolevel_matrix</font> <font color=Red>::</font> <font color=Cyan>(</font>Ring a<font color=Cyan>,</font> Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> Matrix n n a
<a name="line-105"></a><font color=Blue>twolevel_matrix</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>b<font color=Cyan>)</font> <font color=Cyan>(</font>c<font color=Cyan>,</font>d<font color=Cyan>)</font> i j <font color=Red>=</font> matrix_of_function f <font color=Green><u>where</u></font>
<a name="line-106"></a>  f x y 
<a name="line-107"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> i <font color=Cyan>&amp;&amp;</font> y <font color=Cyan>==</font> i <font color=Red>=</font> a
<a name="line-108"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> i <font color=Cyan>&amp;&amp;</font> y <font color=Cyan>==</font> j <font color=Red>=</font> b
<a name="line-109"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> j <font color=Cyan>&amp;&amp;</font> y <font color=Cyan>==</font> i <font color=Red>=</font> c
<a name="line-110"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> j <font color=Cyan>&amp;&amp;</font> y <font color=Cyan>==</font> j <font color=Red>=</font> d
<a name="line-111"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> y <font color=Red>=</font> <font color=Magenta>1</font>
<a name="line-112"></a>    <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Magenta>0</font>
<a name="line-113"></a>
<a name="line-114"></a><a name="onelevel_matrix"></a><font color=Blue><i>-- | Construct a one-level matrix with the given entry.</i></font>
<a name="line-115"></a><font color=Blue>onelevel_matrix</font> <font color=Red>::</font> <font color=Cyan>(</font>Ring a<font color=Cyan>,</font> Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> a <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> Matrix n n a
<a name="line-116"></a><font color=Blue>onelevel_matrix</font> a i <font color=Red>=</font> matrix_of_function f <font color=Green><u>where</u></font>
<a name="line-117"></a>  f x y
<a name="line-118"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> i <font color=Cyan>&amp;&amp;</font> y <font color=Cyan>==</font> i <font color=Red>=</font> a
<a name="line-119"></a>    <font color=Red>|</font> x <font color=Cyan>==</font> y <font color=Red>=</font> <font color=Magenta>1</font>
<a name="line-120"></a>    <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Magenta>0</font>
<a name="line-121"></a>
<a name="line-122"></a><a name="matrix_of_twolevel"></a><font color=Blue><i>-- | Convert a symbolic one- or two-level operator into a matrix.</i></font>
<a name="line-123"></a><font color=Blue>matrix_of_twolevel</font> <font color=Red>::</font> <font color=Cyan>(</font>ComplexRing a<font color=Cyan>,</font> RootHalfRing a<font color=Cyan>,</font> Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> TwoLevel <font color=Red>-&gt;</font> Matrix n n a
<a name="line-124"></a><font color=Blue>matrix_of_twolevel</font> <font color=Cyan>(</font>TL_X i j<font color=Cyan>)</font> <font color=Red>=</font> twolevel_matrix <font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>,</font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>,</font><font color=Magenta>0</font><font color=Cyan>)</font> i j
<a name="line-125"></a><font color=Blue>matrix_of_twolevel</font> <font color=Cyan>(</font>TL_H i j<font color=Cyan>)</font> <font color=Red>=</font> twolevel_matrix <font color=Cyan>(</font>s<font color=Cyan>,</font>s<font color=Cyan>)</font> <font color=Cyan>(</font>s<font color=Cyan>,</font><font color=Blue><i>-</i></font>s<font color=Cyan>)</font> i j
<a name="line-126"></a>  <font color=Green><u>where</u></font> s <font color=Red>=</font> roothalf
<a name="line-127"></a><font color=Blue>matrix_of_twolevel</font> <font color=Cyan>(</font>TL_T k i j<font color=Cyan>)</font> <font color=Red>=</font> twolevel_matrix <font color=Cyan>(</font><font color=Magenta>1</font><font color=Cyan>,</font><font color=Magenta>0</font><font color=Cyan>)</font> <font color=Cyan>(</font><font color=Magenta>0</font><font color=Cyan>,</font>omega<font color=Cyan>^</font><font color=Cyan>(</font>k <font color=Cyan>`mod`</font> <font color=Magenta>8</font><font color=Cyan>)</font><font color=Cyan>)</font> i j
<a name="line-128"></a><font color=Blue>matrix_of_twolevel</font> <font color=Cyan>(</font>TL_omega k i<font color=Cyan>)</font> <font color=Red>=</font> onelevel_matrix <font color=Cyan>(</font>omega<font color=Cyan>^</font><font color=Cyan>(</font>k <font color=Cyan>`mod`</font> <font color=Magenta>8</font><font color=Cyan>)</font><font color=Cyan>)</font> i
<a name="line-129"></a>
<a name="line-130"></a><a name="matrix_of_twolevels"></a><font color=Blue><i>-- | Convert a list of symbolic one- or two-level operators into a</i></font>
<a name="line-131"></a><font color=Blue><i>-- matrix. Note that the operators are to be applied right-to-left,</i></font>
<a name="line-132"></a><font color=Blue><i>-- exactly as in mathematical notation.</i></font>
<a name="line-133"></a><font color=Blue>matrix_of_twolevels</font> <font color=Red>::</font> <font color=Cyan>(</font>ComplexRing a<font color=Cyan>,</font> RootHalfRing a<font color=Cyan>,</font> Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font> <font color=Red>-&gt;</font> Matrix n n a
<a name="line-134"></a><font color=Blue>matrix_of_twolevels</font> gs <font color=Red>=</font> foldl' <font color=Cyan>(</font><font color=Cyan>*</font><font color=Cyan>)</font> <font color=Magenta>1</font> <font color=Red>[</font> matrix_of_twolevel g <font color=Red>|</font> g <font color=Red>&lt;-</font> gs <font color=Red>]</font>
<a name="line-135"></a>
<a name="line-136"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-137"></a><font color=Blue><i>-- * Auxiliary list functions</i></font>
<a name="line-138"></a>
<a name="line-139"></a><a name="list_insert"></a><font color=Blue><i>-- | Replace the /i/th element of a list by /x/.</i></font>
<a name="line-140"></a><font color=Blue>list_insert</font> <font color=Red>::</font> Index <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font>
<a name="line-141"></a><font color=Blue>list_insert</font> <font color=Magenta>0</font> x <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> <font color=Red>=</font> x<font color=Red><b>:</b></font>t
<a name="line-142"></a><font color=Blue>list_insert</font> n x <font color=Cyan>(</font>h<font color=Red><b>:</b></font>t<font color=Cyan>)</font> <font color=Red>=</font> h<font color=Red><b>:</b></font><font color=Cyan>(</font>list_insert <font color=Cyan>(</font>n<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> x t<font color=Cyan>)</font>
<a name="line-143"></a><font color=Blue>list_insert</font> n x [] <font color=Red>=</font> []
<a name="line-144"></a>
<a name="line-145"></a><a name="transform_at"></a><font color=Blue><i>-- | Apply a unary operator to element /i/ of a list.</i></font>
<a name="line-146"></a><font color=Blue>transform_at</font> <font color=Red>::</font> <font color=Cyan>(</font>a <font color=Red>-&gt;</font> a<font color=Cyan>)</font> <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font>
<a name="line-147"></a><font color=Blue>transform_at</font> op i lst <font color=Red>=</font> lst' <font color=Green><u>where</u></font>
<a name="line-148"></a>  x <font color=Red>=</font> lst <font color=Cyan>!!</font> i
<a name="line-149"></a>  x' <font color=Red>=</font> op x
<a name="line-150"></a>  lst' <font color=Red>=</font> list_insert i x' lst
<a name="line-151"></a>
<a name="line-152"></a><a name="transform_at2"></a><font color=Blue><i>-- | Apply a binary operator to elements /i/ and /j/ of a list.</i></font>
<a name="line-153"></a><font color=Blue>transform_at2</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Cyan>(</font>a<font color=Cyan>,</font>a<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>a<font color=Cyan>,</font>a<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>a<font color=Red>]</font>
<a name="line-154"></a><font color=Blue>transform_at2</font> op i j lst <font color=Red>=</font> lst' <font color=Green><u>where</u></font>
<a name="line-155"></a>  <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>lst <font color=Cyan>!!</font> i<font color=Cyan>,</font> lst <font color=Cyan>!!</font> j<font color=Cyan>)</font>
<a name="line-156"></a>  <font color=Cyan>(</font>x'<font color=Cyan>,</font>y'<font color=Cyan>)</font> <font color=Red>=</font> op <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-157"></a>  lst' <font color=Red>=</font> list_insert i x' <font color=Cyan>(</font>list_insert j y' lst<font color=Cyan>)</font>
<a name="line-158"></a>
<a name="line-159"></a><a name="list_pairs"></a><font color=Blue><i>-- | Split a list into pairs. Return a list of pairs, and a final</i></font>
<a name="line-160"></a><font color=Blue><i>-- element if the length of the list was odd.</i></font>
<a name="line-161"></a><font color=Blue>list_pairs</font> <font color=Red>::</font> <font color=Red>[</font>a<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font><font color=Red>[</font><font color=Cyan>(</font>a<font color=Cyan>,</font>a<font color=Cyan>)</font><font color=Red>]</font><font color=Cyan>,</font> Maybe a<font color=Cyan>)</font>
<a name="line-162"></a><font color=Blue>list_pairs</font> [] <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> Nothing<font color=Cyan>)</font>
<a name="line-163"></a><font color=Blue>list_pairs</font> <font color=Red>[</font>h<font color=Red>]</font> <font color=Red>=</font> <font color=Cyan>(</font>[]<font color=Cyan>,</font> Just h<font color=Cyan>)</font>
<a name="line-164"></a><font color=Blue>list_pairs</font> <font color=Cyan>(</font>h<font color=Red><b>:</b></font>k<font color=Red><b>:</b></font>t<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font><font color=Cyan>(</font>h<font color=Cyan>,</font>k<font color=Cyan>)</font><font color=Red><b>:</b></font>t'<font color=Cyan>,</font>r'<font color=Cyan>)</font> <font color=Green><u>where</u></font> <font color=Cyan>(</font>t'<font color=Cyan>,</font>r'<font color=Cyan>)</font> <font color=Red>=</font> list_pairs t
<a name="line-165"></a>
<a name="line-166"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-167"></a><font color=Blue><i>-- * Functions on &#8484;[&#969;]</i></font>
<a name="line-168"></a>
<a name="line-169"></a><a name="log_omega"></a><font color=Blue><i>-- | Given an element of the form &#969;[sup /m/], return /m/ &#8712; {0,&#8230;,7}, or</i></font>
<a name="line-170"></a><font color=Blue><i>-- 'Nothing' if not of that form.</i></font>
<a name="line-171"></a><font color=Blue>log_omega</font> <font color=Red>::</font> ZOmega <font color=Red>-&gt;</font> Maybe Int
<a name="line-172"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>0</font>
<a name="line-173"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>1</font>
<a name="line-174"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>2</font>
<a name="line-175"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>3</font>
<a name="line-176"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>4</font>
<a name="line-177"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>5</font>
<a name="line-178"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>6</font>
<a name="line-179"></a><font color=Blue>log_omega</font> <font color=Cyan>(</font>Omega <font color=Cyan>(</font><font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> Just <font color=Magenta>7</font>
<a name="line-180"></a><font color=Blue>log_omega</font> <font color=Green><u>_</u></font> <font color=Red>=</font> Nothing
<a name="line-181"></a>
<a name="line-182"></a><a name="omega_power"></a><font color=Blue><i>-- | Multiply a scalar by &#969;[sup /n/].</i></font>
<a name="line-183"></a><font color=Blue>omega_power</font> <font color=Red>::</font> <font color=Cyan>(</font>OmegaRing a<font color=Cyan>)</font> <font color=Red>=&gt;</font> Int <font color=Red>-&gt;</font> a <font color=Red>-&gt;</font> a
<a name="line-184"></a><font color=Blue>omega_power</font> n x <font color=Red>=</font> x <font color=Cyan>*</font> omega<font color=Cyan>^</font><font color=Cyan>(</font>n <font color=Cyan>`mod`</font> <font color=Magenta>8</font><font color=Cyan>)</font>
<a name="line-185"></a>
<a name="line-186"></a><a name="reduce_ZOmega"></a><font color=Blue><i>-- | Divide an element of 'ZOmega' by &#8730;2, or throw an error if it is</i></font>
<a name="line-187"></a><font color=Blue><i>-- not divisible.</i></font>
<a name="line-188"></a><font color=Blue>reduce_ZOmega</font> <font color=Red>::</font> ZOmega <font color=Red>-&gt;</font> ZOmega
<a name="line-189"></a><font color=Blue>reduce_ZOmega</font> <font color=Cyan>(</font>Omega a b c d<font color=Cyan>)</font> 
<a name="line-190"></a>  <font color=Red>|</font> even <font color=Cyan>(</font>a<font color=Blue><i>-</i></font>c<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> even <font color=Cyan>(</font>b<font color=Blue><i>-</i></font>d<font color=Cyan>)</font> <font color=Red>=</font> Omega a' b' c' d'
<a name="line-191"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> error <font color=Magenta>"reduce_ZOmega: element not reducible"</font>
<a name="line-192"></a>  <font color=Green><u>where</u></font>
<a name="line-193"></a>    a' <font color=Red>=</font> <font color=Cyan>(</font>b<font color=Blue><i>-</i></font>d<font color=Cyan>)</font> <font color=Cyan>`div`</font> <font color=Magenta>2</font>
<a name="line-194"></a>    b' <font color=Red>=</font> <font color=Cyan>(</font>c<font color=Cyan>+</font>a<font color=Cyan>)</font> <font color=Cyan>`div`</font> <font color=Magenta>2</font>
<a name="line-195"></a>    c' <font color=Red>=</font> <font color=Cyan>(</font>b<font color=Cyan>+</font>d<font color=Cyan>)</font> <font color=Cyan>`div`</font> <font color=Magenta>2</font>
<a name="line-196"></a>    d' <font color=Red>=</font> <font color=Cyan>(</font>c<font color=Blue><i>-</i></font>a<font color=Cyan>)</font> <font color=Cyan>`div`</font> <font color=Magenta>2</font>
<a name="line-197"></a>
<a name="line-198"></a><a name="opX_zomega"></a><font color=Blue><i>-- | Apply the /X/ operator to a 2-dimensional vector over 'ZOmega'.</i></font>
<a name="line-199"></a><font color=Blue>opX_zomega</font> <font color=Red>::</font> <font color=Cyan>(</font>ZOmega<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>ZOmega<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font>
<a name="line-200"></a><font color=Blue>opX_zomega</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>y<font color=Cyan>,</font>x<font color=Cyan>)</font>
<a name="line-201"></a>
<a name="line-202"></a><a name="opH_zomega"></a><font color=Blue><i>-- | Apply the /H/ operator to a 2-dimensional vector over</i></font>
<a name="line-203"></a><font color=Blue><i>-- 'ZOmega'. This throws an error if the result is not well-defined</i></font>
<a name="line-204"></a><font color=Blue><i>-- over 'ZOmega'.</i></font>
<a name="line-205"></a><font color=Blue>opH_zomega</font> <font color=Red>::</font> <font color=Cyan>(</font>ZOmega<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Cyan>(</font>ZOmega<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font>
<a name="line-206"></a><font color=Blue>opH_zomega</font> <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>reduce_ZOmega <font color=Cyan>(</font>x<font color=Cyan>+</font>y<font color=Cyan>)</font><font color=Cyan>,</font> reduce_ZOmega <font color=Cyan>(</font>x<font color=Blue><i>-</i></font>y<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-207"></a>
<a name="line-208"></a><a name="apply_twolevel_zomega"></a><font color=Blue><i>-- | Apply a 'TwoLevel' operator to a 'ZOmega'-vector, represented as</i></font>
<a name="line-209"></a><font color=Blue><i>-- a list. Throws an error if any operation produces a scalar that is</i></font>
<a name="line-210"></a><font color=Blue><i>-- not in 'ZOmega'.</i></font>
<a name="line-211"></a><font color=Blue>apply_twolevel_zomega</font> <font color=Red>::</font> TwoLevel <font color=Red>-&gt;</font> <font color=Red>[</font>ZOmega<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>ZOmega<font color=Red>]</font>
<a name="line-212"></a><font color=Blue>apply_twolevel_zomega</font> <font color=Cyan>(</font>TL_X i j<font color=Cyan>)</font> w <font color=Red>=</font> transform_at2 opX_zomega i j w
<a name="line-213"></a><font color=Blue>apply_twolevel_zomega</font> <font color=Cyan>(</font>TL_H i j<font color=Cyan>)</font> w <font color=Red>=</font> transform_at2 opH_zomega i j w
<a name="line-214"></a><font color=Blue>apply_twolevel_zomega</font> <font color=Cyan>(</font>TL_T k i j<font color=Cyan>)</font> w <font color=Red>=</font> transform_at <font color=Cyan>(</font>omega_power k<font color=Cyan>)</font> j w
<a name="line-215"></a><font color=Blue>apply_twolevel_zomega</font> <font color=Cyan>(</font>TL_omega k i<font color=Cyan>)</font> w <font color=Red>=</font> transform_at <font color=Cyan>(</font>omega_power k<font color=Cyan>)</font> i w
<a name="line-216"></a>
<a name="line-217"></a><a name="apply_twolevels_zomega"></a><font color=Blue><i>-- | Apply a list of 'TwoLevel' operators to a 'ZOmega'-vector,</i></font>
<a name="line-218"></a><font color=Blue><i>-- represented as a list. Throws an error if any operation produces a</i></font>
<a name="line-219"></a><font color=Blue><i>-- scalar that is not in 'ZOmega'.</i></font>
<a name="line-220"></a><font color=Blue>apply_twolevels_zomega</font> <font color=Red>::</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>ZOmega<font color=Red>]</font> <font color=Red>-&gt;</font> <font color=Red>[</font>ZOmega<font color=Red>]</font>
<a name="line-221"></a><font color=Blue>apply_twolevels_zomega</font> gs w <font color=Red>=</font> foldr apply_twolevel_zomega' w gs
<a name="line-222"></a>  <font color=Green><u>where</u></font> apply_twolevel_zomega' g w <font color=Red>=</font> apply_twolevel_zomega g w
<a name="line-223"></a>
<a name="line-224"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-225"></a><font color=Blue><i>-- * Functions on residues</i></font>
<a name="line-226"></a>
<a name="line-227"></a><a name="ResidueType"></a><font color=Blue><i>-- | The /residue type/ of /t/ &#8712; &#8484;[&#969;] is the residue of /t/[sup &#8224;]/t/.</i></font>
<a name="line-228"></a><a name="ResidueType"></a><font color=Blue><i>-- It is 0000, 0001, or 1010.</i></font>
<a name="line-229"></a><a name="ResidueType"></a><font color=Green><u>data</u></font> ResidueType <font color=Red>=</font> RT_0000 <font color=Red>|</font> RT_0001 <font color=Red>|</font> RT_1010
<a name="line-230"></a>                                       <font color=Green><u>deriving</u></font> <font color=Cyan>(</font>Eq<font color=Cyan>,</font> Ord<font color=Cyan>)</font>
<a name="line-231"></a>
<a name="line-232"></a><a name="residue_type"></a><font color=Blue><i>-- | Return the residue's 'ResidueType'.</i></font>
<a name="line-233"></a><font color=Blue>residue_type</font> <font color=Red>::</font> Omega Z2 <font color=Red>-&gt;</font> ResidueType
<a name="line-234"></a><font color=Blue>residue_type</font> r <font color=Red>=</font> t <font color=Green><u>where</u></font>
<a name="line-235"></a>  <font color=Cyan>(</font>t<font color=Cyan>,</font> <font color=Green><u>_</u></font><font color=Cyan>)</font> <font color=Red>=</font> residue_type_shift r
<a name="line-236"></a>  
<a name="line-237"></a><a name="residue_shift"></a><font color=Blue><i>-- | Return the residue's /shift/.</i></font>
<a name="line-238"></a><font color=Blue><i>-- </i></font>
<a name="line-239"></a><font color=Blue><i>-- The shift is defined so that: </i></font>
<a name="line-240"></a><font color=Blue><i>-- </i></font>
<a name="line-241"></a><font color=Blue><i>-- * 0001, 1110, 0011 have shift 0,</i></font>
<a name="line-242"></a><font color=Blue><i>-- </i></font>
<a name="line-243"></a><font color=Blue><i>-- * 0010, 1101, 0110 have shift 1,</i></font>
<a name="line-244"></a><font color=Blue><i>-- </i></font>
<a name="line-245"></a><font color=Blue><i>-- * 0100, 1011, 1100 have shift 2, and</i></font>
<a name="line-246"></a><font color=Blue><i>-- </i></font>
<a name="line-247"></a><font color=Blue><i>-- * 1000, 0111, 1001 have shift 3.</i></font>
<a name="line-248"></a><font color=Blue><i>-- </i></font>
<a name="line-249"></a><font color=Blue><i>-- Residues of type 'RT_0000' have shift 0.</i></font>
<a name="line-250"></a><font color=Blue>residue_shift</font> <font color=Red>::</font> Omega Z2 <font color=Red>-&gt;</font> Int
<a name="line-251"></a><font color=Blue>residue_shift</font> r <font color=Red>=</font> s <font color=Green><u>where</u></font>
<a name="line-252"></a>  <font color=Cyan>(</font><font color=Green><u>_</u></font><font color=Cyan>,</font> s<font color=Cyan>)</font> <font color=Red>=</font> residue_type_shift r
<a name="line-253"></a>
<a name="line-254"></a><a name="residue_type_shift"></a><font color=Blue><i>-- | Return the residue's 'ResidueType' and the shift.</i></font>
<a name="line-255"></a><font color=Blue>residue_type_shift</font> <font color=Red>::</font> Omega Z2 <font color=Red>-&gt;</font> <font color=Cyan>(</font>ResidueType<font color=Cyan>,</font> Int<font color=Cyan>)</font>
<a name="line-256"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0000<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-257"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-258"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-259"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_1010<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-260"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-261"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0000<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-262"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_1010<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-263"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font>
<a name="line-264"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font>
<a name="line-265"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_1010<font color=Cyan>,</font> <font color=Magenta>3</font><font color=Cyan>)</font>
<a name="line-266"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0000<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-267"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>1</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-268"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_1010<font color=Cyan>,</font> <font color=Magenta>2</font><font color=Cyan>)</font>
<a name="line-269"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>0</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-270"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>0</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0001<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-271"></a><font color=Blue>residue_type_shift</font> <font color=Cyan>(</font>Omega <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>1</font> <font color=Magenta>1</font><font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>RT_0000<font color=Cyan>,</font> <font color=Magenta>0</font><font color=Cyan>)</font>
<a name="line-272"></a><font color=Blue>residue_type_shift</font> <font color=Green><u>_</u></font> <font color=Red>=</font> undefined  <font color=Blue><i>-- to turn off a compiler warning</i></font>
<a name="line-273"></a>
<a name="line-274"></a><a name="residue_offset"></a><font color=Blue><i>-- | Given two irreducible residues /a/ and /b/ of the same type, find</i></font>
<a name="line-275"></a><font color=Blue><i>-- an index /m/ such that /a/ + &#969;[sup /m/]/b/ = 0000. If no such index</i></font>
<a name="line-276"></a><font color=Blue><i>-- exists, find an index /m/ such that /a/ + &#969;[sup /m/]/b/ = 1111.</i></font>
<a name="line-277"></a><font color=Blue>residue_offset</font> <font color=Red>::</font> Omega Z2 <font color=Red>-&gt;</font> Omega Z2 <font color=Red>-&gt;</font> Int
<a name="line-278"></a><font color=Blue>residue_offset</font> a b <font color=Red>=</font> <font color=Cyan>(</font>residue_shift a <font color=Blue><i>-</i></font> residue_shift b<font color=Cyan>)</font> <font color=Cyan>`mod`</font> <font color=Magenta>4</font>
<a name="line-279"></a>
<a name="line-280"></a><a name="reducible"></a><font color=Blue><i>-- | Check whether a residue is reducible. A residue /r/ is called /reducible/</i></font>
<a name="line-281"></a><font color=Blue><i>-- if it is of the form /r/ = &#8730;2 &#8901; /r/', i.e., /r/ &#8712; {0000, 0101, 1010, 1111}.</i></font>
<a name="line-282"></a><font color=Blue>reducible</font> <font color=Red>::</font> Omega Z2 <font color=Red>-&gt;</font> Bool
<a name="line-283"></a><font color=Blue>reducible</font> <font color=Cyan>(</font>Omega a b c d<font color=Cyan>)</font> <font color=Red>=</font> <font color=Cyan>(</font>a<font color=Cyan>==</font>c<font color=Cyan>)</font> <font color=Cyan>&amp;&amp;</font> <font color=Cyan>(</font>b<font color=Cyan>==</font>d<font color=Cyan>)</font>
<a name="line-284"></a>
<a name="line-285"></a><font color=Blue><i>-- ----------------------------------------------------------------------</i></font>
<a name="line-286"></a><font color=Blue><i>-- * Exact synthesis</i></font>
<a name="line-287"></a>
<a name="line-288"></a><a name="row_step"></a><font color=Blue><i>-- | Perform a single row operation as in Lemma 4, applied to rows /i/</i></font>
<a name="line-289"></a><font color=Blue><i>-- and /j/.  The entries at rows /i/ and /j/ are /x/ and /y/,</i></font>
<a name="line-290"></a><font color=Blue><i>-- respectively, with respective residues /a/ and /b/. A precondition</i></font>
<a name="line-291"></a><font color=Blue><i>-- is that /x/ and /y/ are of the same residue type. Returns a list of</i></font>
<a name="line-292"></a><font color=Blue><i>-- two-level operations that decreases the denominator exponent.</i></font>
<a name="line-293"></a><font color=Blue>row_step</font> <font color=Red>::</font> <font color=Cyan>(</font><font color=Cyan>(</font>Index<font color=Cyan>,</font> Omega Z2<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>Index<font color=Cyan>,</font> Omega Z2<font color=Cyan>,</font> ZOmega<font color=Cyan>)</font><font color=Cyan>)</font> <font color=Red>-&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font>
<a name="line-294"></a><font color=Blue>row_step</font> <font color=Cyan>(</font><font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>j<font color=Cyan>,</font>b<font color=Cyan>,</font>y<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-295"></a>  <font color=Red>|</font> reducible a <font color=Cyan>&amp;&amp;</font> reducible b <font color=Red>=</font> []
<a name="line-296"></a>  <font color=Red>|</font> offs <font color=Cyan>/=</font> <font color=Magenta>0</font> <font color=Red>=</font> <font color=Cyan>(</font>TL_T offs i j<font color=Cyan>)</font> <font color=Red><b>:</b></font> row_step <font color=Cyan>(</font><font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>j<font color=Cyan>,</font>b'<font color=Cyan>,</font>y'<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-297"></a>  <font color=Red>|</font> otherwise <font color=Red>=</font> <font color=Cyan>(</font>TL_H i j<font color=Cyan>)</font> <font color=Red><b>:</b></font> row_step <font color=Cyan>(</font><font color=Cyan>(</font>i<font color=Cyan>,</font>a1<font color=Cyan>,</font>x1<font color=Cyan>)</font><font color=Cyan>,</font> <font color=Cyan>(</font>j<font color=Cyan>,</font>b1<font color=Cyan>,</font>y1<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-298"></a>  <font color=Green><u>where</u></font>
<a name="line-299"></a>    offs <font color=Red>=</font> residue_offset b a
<a name="line-300"></a>    y' <font color=Red>=</font> omega_power <font color=Cyan>(</font><font color=Blue><i>-</i></font>offs<font color=Cyan>)</font> y
<a name="line-301"></a>    b' <font color=Red>=</font> residue y'
<a name="line-302"></a>    <font color=Cyan>(</font>x1<font color=Cyan>,</font>y1<font color=Cyan>)</font> <font color=Red>=</font> opH_zomega <font color=Cyan>(</font>x<font color=Cyan>,</font>y<font color=Cyan>)</font>
<a name="line-303"></a>    <font color=Cyan>(</font>a1<font color=Cyan>,</font>b1<font color=Cyan>)</font> <font color=Red>=</font> residue <font color=Cyan>(</font>x1<font color=Cyan>,</font>y1<font color=Cyan>)</font>
<a name="line-304"></a>
<a name="line-305"></a><a name="reduce_column"></a><font color=Blue><i>-- | Row reduction: Given a unit column vector /v/, generate a</i></font>
<a name="line-306"></a><font color=Blue><i>-- sequence of two-level operators that reduces the /i/th standard</i></font>
<a name="line-307"></a><font color=Blue><i>-- basis vector /e/[sub /i/] to /v/. Any rows that are already 0 in</i></font>
<a name="line-308"></a><font color=Blue><i>-- both vectors are guaranteed not to be touched.</i></font>
<a name="line-309"></a><font color=Blue>reduce_column</font> <font color=Red>::</font> <font color=Cyan>(</font>Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> Matrix n One <font color=Cyan>(</font>DOmega<font color=Cyan>)</font> <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font>
<a name="line-310"></a><font color=Blue>reduce_column</font> v i <font color=Red>=</font> aux w k <font color=Green><u>where</u></font>
<a name="line-311"></a>  vlist <font color=Red>=</font> list_of_vector <font color=Cyan>(</font>vector_head <font color=Cyan>(</font>unMatrix v<font color=Cyan>)</font><font color=Cyan>)</font>
<a name="line-312"></a>  <font color=Cyan>(</font>w<font color=Cyan>,</font> k<font color=Cyan>)</font> <font color=Red>=</font> denomexp_decompose vlist
<a name="line-313"></a>  aux w <font color=Magenta>0</font> <font color=Red>=</font> m1 <font color=Cyan>++</font> m2 <font color=Green><u>where</u></font>
<a name="line-314"></a>    j <font color=Red>=</font> <font color=Green><u>case</u></font> findIndices <font color=Cyan>(</font><font color=Cyan>/=</font> <font color=Magenta>0</font><font color=Cyan>)</font> w <font color=Green><u>of</u></font>
<a name="line-315"></a>      <font color=Red>[</font>j<font color=Red>]</font> <font color=Red>-&gt;</font> j
<a name="line-316"></a>      <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"reduce_column: not a unit vector"</font>
<a name="line-317"></a>    wj <font color=Red>=</font> w <font color=Cyan>!!</font> j
<a name="line-318"></a>    l <font color=Red>=</font> <font color=Green><u>case</u></font> log_omega wj <font color=Green><u>of</u></font>
<a name="line-319"></a>      Just l <font color=Red>-&gt;</font> l
<a name="line-320"></a>      Nothing <font color=Red>-&gt;</font> error <font color=Magenta>"reduce_column: not a unit vector"</font>
<a name="line-321"></a>    m1 <font color=Red>=</font> <font color=Green><u>if</u></font> i<font color=Cyan>==</font>j <font color=Green><u>then</u></font> [] <font color=Green><u>else</u></font> <font color=Red>[</font>TL_X i j<font color=Red>]</font>
<a name="line-322"></a>    m2 <font color=Red>=</font> <font color=Red>[</font>TL_omega l i<font color=Red>]</font>
<a name="line-323"></a>  aux w k <font color=Red>=</font> gates <font color=Cyan>++</font> aux w' <font color=Cyan>(</font>k<font color=Blue><i>-</i></font><font color=Magenta>1</font><font color=Cyan>)</font> <font color=Green><u>where</u></font>
<a name="line-324"></a>    res <font color=Red>=</font> residue w
<a name="line-325"></a>    idx_res <font color=Red>=</font> zip3 <font color=Red>[</font><font color=Magenta>0</font><font color=Red>..</font><font color=Red>]</font> res w
<a name="line-326"></a>    res1010 <font color=Red>=</font> <font color=Red>[</font> <font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> idx_res<font color=Cyan>,</font> residue_type a <font color=Cyan>==</font> RT_1010 <font color=Red>]</font>
<a name="line-327"></a>    res0001 <font color=Red>=</font> <font color=Red>[</font> <font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>|</font> <font color=Cyan>(</font>i<font color=Cyan>,</font>a<font color=Cyan>,</font>x<font color=Cyan>)</font> <font color=Red>&lt;-</font> idx_res<font color=Cyan>,</font> residue_type a <font color=Cyan>==</font> RT_0001 <font color=Red>]</font>
<a name="line-328"></a>    res1010_pairs <font color=Red>=</font> <font color=Green><u>case</u></font> list_pairs res1010 <font color=Green><u>of</u></font>
<a name="line-329"></a>      <font color=Cyan>(</font>p<font color=Cyan>,</font> Nothing<font color=Cyan>)</font> <font color=Red>-&gt;</font> p
<a name="line-330"></a>      <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"reduce_column: not a unit vector"</font>
<a name="line-331"></a>    res0001_pairs <font color=Red>=</font> <font color=Green><u>case</u></font> list_pairs res0001 <font color=Green><u>of</u></font>
<a name="line-332"></a>      <font color=Cyan>(</font>p<font color=Cyan>,</font> Nothing<font color=Cyan>)</font> <font color=Red>-&gt;</font> p
<a name="line-333"></a>      <font color=Green><u>_</u></font> <font color=Red>-&gt;</font> error <font color=Magenta>"reduce_column: not a unit vector"</font>
<a name="line-334"></a>    m1010 <font color=Red>=</font> concat <font color=Cyan>$</font> map row_step res1010_pairs
<a name="line-335"></a>    m0001 <font color=Red>=</font> concat <font color=Cyan>$</font> map row_step res0001_pairs
<a name="line-336"></a>    gates <font color=Red>=</font> m1010 <font color=Cyan>++</font> m0001
<a name="line-337"></a>    w' <font color=Red>=</font> map <font color=Cyan>(</font>reduce_ZOmega<font color=Cyan>)</font> <font color=Cyan>(</font>apply_twolevels_zomega <font color=Cyan>(</font>invert_twolevels gates<font color=Cyan>)</font> w<font color=Cyan>)</font>
<a name="line-338"></a>
<a name="line-339"></a><a name="synthesis_nqubit"></a><font color=Blue><i>-- | Input an exact /n/&#215;/n/ unitary operator with coefficients in</i></font>
<a name="line-340"></a><font color=Blue><i>-- [bold D][&#969;], and output an equivalent sequence of two-level</i></font>
<a name="line-341"></a><font color=Blue><i>-- operators.  This is the algorithm from the Giles-Selinger paper. It</i></font>
<a name="line-342"></a><font color=Blue><i>-- has superexponential complexity.</i></font>
<a name="line-343"></a><font color=Blue><i>-- </i></font>
<a name="line-344"></a><font color=Blue><i>-- Note: the list of 'TwoLevel' operators will be returned in</i></font>
<a name="line-345"></a><font color=Blue><i>-- right-to-left order, i.e., as in the mathematical notation for</i></font>
<a name="line-346"></a><font color=Blue><i>-- matrix multiplication. This is the opposite of the quantum circuit</i></font>
<a name="line-347"></a><font color=Blue><i>-- notation.</i></font>
<a name="line-348"></a><font color=Blue>synthesis_nqubit</font> <font color=Red>::</font> <font color=Cyan>(</font>Nat n<font color=Cyan>)</font> <font color=Red>=&gt;</font> Matrix n n DOmega <font color=Red>-&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font>
<a name="line-349"></a><font color=Blue>synthesis_nqubit</font> m <font color=Red>=</font> aux <font color=Cyan>(</font>unMatrix m<font color=Cyan>)</font> <font color=Magenta>0</font> <font color=Green><u>where</u></font>
<a name="line-350"></a>  aux <font color=Red>::</font> <font color=Cyan>(</font>Nat m<font color=Cyan>)</font> <font color=Red>=&gt;</font> Vector n <font color=Cyan>(</font>Vector m DOmega<font color=Cyan>)</font> <font color=Red>-&gt;</font> Index <font color=Red>-&gt;</font> <font color=Red>[</font>TwoLevel<font color=Red>]</font>
<a name="line-351"></a>  aux Nil i <font color=Red>=</font> []
<a name="line-352"></a>  aux <font color=Cyan>(</font>c <font color=Cyan>`Cons`</font> cs<font color=Cyan>)</font> i <font color=Red>=</font> gates <font color=Cyan>++</font> aux <font color=Cyan>(</font>unMatrix m'<font color=Cyan>)</font> <font color=Cyan>(</font>i<font color=Cyan>+</font><font color=Magenta>1</font><font color=Cyan>)</font>
<a name="line-353"></a>    <font color=Green><u>where</u></font>
<a name="line-354"></a>      gates <font color=Red>=</font> reduce_column <font color=Cyan>(</font>column_matrix c<font color=Cyan>)</font> i
<a name="line-355"></a>      gates_matrix <font color=Red>=</font> matrix_of_twolevels <font color=Cyan>(</font>invert_twolevels gates<font color=Cyan>)</font>
<a name="line-356"></a>      m' <font color=Red>=</font> gates_matrix <font color=Cyan>.*.</font> <font color=Cyan>(</font>Matrix cs<font color=Cyan>)</font>
</pre>
</body>
</html>